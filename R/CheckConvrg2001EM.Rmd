---
title: "2001 EM convergence check"
author: "Robert Wildermuth"
date: "3/15/2022"
output: 
  pdf_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
library(tidyverse)
library(r4ss)
library(ss3sim)
library(hablar)
library(SSMSE)
library(reshape2)
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/bDiagPlots.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/compDiagPlots.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/recrDiagPlots.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/catchDiagPlots.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/age1plusDiagPlots.R")

library(RColorBrewer)
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/GetSumryOutput.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/CalcPerformance.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/CalcTermTS.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/PlotEMAnnualEsts.R")
```

# Server Runs

Look at years of no convergence and parameter bounds
```{r}
serverTest <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns/RandRecHCR2servertest/results_scalar_RandRecHCR2servertest.csv")

convrgCheckServerTest <- serverTest %>% select(max_grad, params_on_bound, 
                                               params_stuck_low, params_stuck_high,
                                               model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)

convrgCheckServerTest 
```

Plot diagnostics from server runs (random recruitment, HCR2)
```{r}
# Ran just to have summary tables
# sumry <- SSMSE_summary_all("C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns",
#                            scenarios = "RandRecHCR2servertest", # won't work for the no catch scenario
#                            run_parallel = TRUE)

srvBio <- bDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns",
                      scenario = "RandRecHCR2servertest",
                      termYr = 2068, surveyInx = 4)
srvBio[[1]] + geom_rug(data = convrgCheckServerTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

compDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns",
              scenario = "RandRecHCR2servertest",
              termYr = 2068, surveyInx = 4)

srvRec <- recrDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns",
                        scenario = "RandRecHCR2servertest", termYr = 2068)
srvRec[[1]] + geom_rug(data = convrgCheckServerTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

srvAge1Plus <- age1plusDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns",
                                  scenario = "RandRecHCR2servertest", termYr = 2068)
srvAge1Plus[[1]] + geom_rug(data = convrgCheckServerTest, mapping = aes(x = year),
                            sides = "b", inherit.aes = FALSE)
```

Look at recruitment and fishing mortality parameter estimates
```{r}
paramCheckServerTest <- serverTest %>% select(max_grad, SR_LN_R0, SR_regime,
                                              SR_regime_BLK1repl_2000,
                                              model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)
paramCheckServerTest
# compare to OM
serverTest %>% select(SR_LN_R0, SR_regime, SR_regime_BLK1repl_2000,
                      model_run, iteration) %>%
      mutate(year = as.numeric(regmatches(model_run, 
                                          gregexpr("[[:digit:]]+", model_run)))) %>%
      filter(model_run == "start2001_OM")

serverTestFrates <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns/RandRecHCR2servertest/results_ts_RandRecHCR2servertest.csv")
serverTestFrates <- serverTestFrates %>% select(F_1, F_2, F_3, Seas, year, model_run, iteration, scenario)
summary(serverTestFrates)
serverTestFrates %>% filter(F_1 > 1 | F_2 > 1 | F_3 > 1) %>% arrange(year, Seas) %>%
  mutate(yearEM = as.numeric(regmatches(model_run, 
                                      gregexpr("[[:digit:]]+", model_run)))) %>%
  left_join(y = convrgCheckServerTest, by = c("yearEM" = "year", "iteration", "model_run"))
```

Plot error for estimates of rec devs from 2068 compared to OM (these aren't terminal year estimates like plots above)
```{r}
recDevTS <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns/RandRecHCR2servertest/results_ts_RandRecHCR2servertest.csv")
recDevTS <- recDevTS %>% select(rec_dev, Seas, year, model_run, iteration, scenario) %>%
              filter(model_run == "start2001_OM" | grepl("2068", model_run)) %>%
              filter(complete.cases(.))

recDevTS %>% ggplot(aes(x=year, y=rec_dev)) + geom_line(aes(color = model_run)) + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()

relRecDevTS <- recDevTS %>% pivot_wider(id_cols = c(year, iteration),
                                        names_from = model_run, 
                                        values_from = rec_dev) %>% 
                  mutate(diffDevs = (constGrowBothShort_EM_2068 - start2001_OM)/start2001_OM)

relRecDevTS %>% ggplot(aes(x=year, y=diffDevs)) + geom_line() + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()
```

Look at dynamics of no catch runs to see if population crashes
```{r}
srvNoCatTest <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns/RandRecHCR2servertest/SSMSE_dq.csv")
srvNoCatTest <- srvNoCatTest %>% filter(scenario %in% c("constGrow2001OM_constGrow2005EM_RandRecHCR0",
                                                        "constGrow2001OM_constGrow2005EM_ARRecHCR0")) %>%
                  mutate(charIt = substr(as.character(iteration), 1, 1))

srvNoCatTest %>% ggplot(aes(x=year, y=Value.SSB)) + 
  geom_line(aes(color = iteration, linetype = as.character(iteration))) +
  scale_linetype_manual(values = rep("solid", nrow(srvNoCatTest))) +
  guides(linetype = "none") +
  #scale_color_manual(values = rep("black", 11))
  ggplot2::facet_wrap(. ~ charIt) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  ggplot2::theme_classic()

srvNoCatTest %>% filter(year %in% 2060:2070) %>% select(year, Value.SSB, Value.Recr, iteration)
```

# 1981 HCR6 Server Runs

Look at years of no convergence and parameter bounds
```{r}
# Ran just to have summary tables
# sumry <- SSMSE_summary_all("C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns",
#                            scenarios = "start1981HCR6serverRuns", # won't work for the no catch scenario
#                            run_parallel = TRUE)

serv1981Test <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns/start1981HCR6serverRuns/results_scalar_start1981HCR6serverRuns.csv")

convrgCheck1981ServerTest <- serv1981Test %>% select(max_grad, params_on_bound, 
                                               params_stuck_low, params_stuck_high,
                                               model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)

convrgCheck1981ServerTest 
```

Plot diagnostics from server runs (random recruitment, HCR2)
```{r}


srv1981Bio <- bDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns",
                      scenario = "start1981HCR6serverRuns",
                      termYr = 2068, surveyInx = 4)
srv1981Bio[[1]] + geom_rug(data = convrgCheck1981ServerTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

compDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns",
              scenario = "start1981HCR6serverRuns",
              termYr = 2068, surveyInx = 4)

srv1981Rec <- recrDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns",
                        scenario = "start1981HCR6serverRuns", termYr = 2068)
srv1981Rec[[1]] + geom_rug(data = convrgCheck1981ServerTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

srv1981Age1Plus <- age1plusDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns",
                                  scenario = "start1981HCR6serverRuns", termYr = 2068)
srv1981Age1Plus[[1]] + geom_rug(data = convrgCheck1981ServerTest, mapping = aes(x = year),
                            sides = "b", inherit.aes = FALSE)
```

Look at recruitment and fishing mortality parameter estimates
```{r}
paramCheck1981ServerTest <- serv1981Test %>% select(max_grad, SR_LN_R0, SR_regime,
                                              SR_regime_BLK1repl_1980,
                                              model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) #%>%
                          #filter(max_grad > 0.01)
paramCheck1981ServerTest
# compare to OM
serv1981Test %>% select(SR_LN_R0, SR_regime, SR_regime_BLK1repl_1980,
                      model_run, iteration) %>%
      mutate(year = as.numeric(regmatches(model_run, 
                                          gregexpr("[[:digit:]]+", model_run)))) %>%
      filter(model_run == "margComp_20210921_OM")

serv1981TestFrates <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns/start1981HCR6serverRuns/results_ts_start1981HCR6serverRuns.csv")
serv1981TestFrates <- serv1981TestFrates %>% select(F_1, F_2, F_3, Seas, year, model_run, iteration, scenario)
summary(serv1981TestFrates)
serv1981TestFrates %>% filter(F_1 > 1 | F_2 > 1 | F_3 > 1) %>% arrange(year, Seas) %>%
  mutate(yearEM = as.numeric(regmatches(model_run, 
                                      gregexpr("[[:digit:]]+", model_run)))) #%>%
  #left_join(y = convrgCheckServerTest, by = c("yearEM" = "year", "iteration", "model_run"))
```

Plot error for estimates of rec devs from 2068 compared to OM (these aren't terminal year estimates like plots above)
```{r}
recDevTS <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/scenarioRuns/start1981HCR6serverRuns/results_ts_start1981HCR6serverRuns.csv")
recDevTS <- recDevTS %>% select(rec_dev, Seas, year, model_run, iteration, scenario) %>%
              filter(model_run == "margComp_20210921_OM" | grepl("2068", model_run)) %>%
              filter(complete.cases(.))

recDevTS %>% ggplot(aes(x=year, y=rec_dev)) + geom_line(aes(color = model_run)) + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()

relRecDevTS <- recDevTS %>% pivot_wider(id_cols = c(year, iteration),
                                        names_from = model_run, 
                                        values_from = rec_dev) %>% 
                  mutate(diffDevs = (margCompsOMfixedSelexEM_EM_2068 - margComp_20210921_OM)/margComp_20210921_OM)

relRecDevTS %>% ggplot(aes(x=year, y=diffDevs)) + geom_line() + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()
```

# EM 2001 self test, recruitment at 0.25, perfect information

```{r}


mseDir <- "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios"

scenarios <- c("constGrow2001OM_selfTest_RandRecHCR0",
               "constGrow2001OM_selfTest_RandRecHCR2",
               "constGrow2001OM_selfTest_RandRecHCR3",
               "constGrow2001OM_selfTest_RandRecHCR5",
               "constGrow2001OM_selfTest_RandRecHCR6")

smryOutputList <- GetSumryOutput(dirSSMSE = mseDir,
                                 scenarios = scenarios)

performanceList <- CalcPerformance(smryOutputList)

metricsTbl <- performanceList$perfomanceMetrics

# parse out HCR and recruitment scenario
metricsTbl <- metricsTbl %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                    recScen = sub(pattern = "HCR.*","", scenario)) %>%
                mutate(recScen = sub(pattern = ".*selfTest_","", recScen))

hcrPal <- brewer.pal(10, "Set3")[-2]

# plot convergence frequency
metricsTbl %>% filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = frqNonConvg)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_brewer(palette = hcrPal)

# get terminal estimates of these values for timeseries plots
termTS <- CalcTermTS(smryOutputList) %>% 
              mutate(HCR = sub(pattern = ".*Rec","", scenario),
                               recScen = sub(pattern = "HCR.*","", scenario)) %>%
              mutate(recScen = sub(pattern = ".*selfTest_","", recScen))

omName <- grep("_OM", smryOutputList$tsSmry$model_run, 
                 fixed = TRUE, value = TRUE)[1]

convrgCheck <- smryOutputList$sclSmry %>% 
                  select(max_grad, model_run, iteration, scenario) %>%
                  mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
                  mutate(recScen = sub(pattern = ".*selfTest_","", recScen))  

hcrs <- unique(termTS$HCR)
exIters <- sample(termTS$iteration, size = 4)

cnvrgTS <- smryOutputList$tsSmry %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                   recScen = sub(pattern = "HCR.*","", scenario)) %>%
      mutate(recScen = sub(pattern = ".*selfTest_","", recScen)) %>%
      left_join(y = convrgCheck, by = c("iteration", "model_run", "scenario", "HCR", "recScen")) %>%
      mutate(plotGroup = case_when(model_run == omName ~ "OM",
                                   max_grad > 0.01 ~ "non-convrg",
                                   max_grad < 0.01 ~ "convrg"))

for(hcr in 2:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = log(Bio_smry))) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = log(50000), color = "red") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

for(hcr in 2:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = rec_dev)) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = 0, color = "gray") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

#termTS %>% filter(model_run == omName)

errCompare <- cnvrgTS %>% filter(Seas == 1, model_run != omName) %>%
                select(Bio_smry, year, model_run, iteration, scenario, HCR, recScen, emYear, plotGroup) %>%
                inner_join(y = subset(termTS, model_run == omName), 
                           by = c("year", "iteration", "scenario", "HCR", "recScen")) %>%
                #filter(iteration == 1) %>%
                  rename(age1plusOM = Bio_smry.y,
                         age1plusEM = Bio_smry.x) %>% 
                  mutate(errSmryBio = (age1plusEM - age1plusOM)/age1plusOM) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(errSmryBio)) %>%
                group_by(iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(runMSE))  #%>%
                # group_by(scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))

errCompare %>% #filter(HCR != "HCR3") %>%
  ggplot(aes(x = HCR, y = runMSE, fill = plotGroup)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~recScen) 
```

# EM 2001 self test, recruitment at SD=0.25, perfect information & fixed params

```{r}
mseDir <- "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios"

scenarios <- c("fixedParams2001OM_selfTestSD0.25_RandRecHCR0",
               "fixedParams2001OM_selfTestSD0.25_RandRecHCR2",
               "fixedParams2001OM_selfTestSD0.25_RandRecHCR3",
               "fixedParams2001OM_selfTestSD0.25_RandRecHCR5",
               "fixedParams2001OM_selfTestSD0.25_RandRecHCR6")

smryOutputList <- GetSumryOutput(dirSSMSE = mseDir,
                                 scenarios = scenarios)

performanceList <- CalcPerformance(smryOutputList)

metricsTbl <- performanceList$perfomanceMetrics

# parse out HCR and recruitment scenario
metricsTbl <- metricsTbl %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                    recScen = sub(pattern = "HCR.*","", scenario)) %>%
                mutate(recScen = sub(pattern = ".*selfTest_","", recScen))

hcrPal <- brewer.pal(10, "Set3")[-2]

# plot convergence frequency
metricsTbl %>% filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = frqNonConvg)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_brewer(palette = hcrPal)

# get terminal estimates of these values for timeseries plots
termTS <- CalcTermTS(smryOutputList) %>% 
              mutate(HCR = sub(pattern = ".*Rec","", scenario),
                               recScen = sub(pattern = "HCR.*","", scenario)) %>%
              mutate(recScen = sub(pattern = ".*selfTest_","", recScen))

omName <- grep("_OM", smryOutputList$tsSmry$model_run, 
                 fixed = TRUE, value = TRUE)[1]

convrgCheck <- smryOutputList$sclSmry %>% 
                  select(max_grad, model_run, iteration, scenario) %>%
                  mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
                  mutate(recScen = sub(pattern = ".*selfTest_","", recScen))  

hcrs <- unique(termTS$HCR)
#exIters <- sample(termTS$iteration, size = 4)

cnvrgTS <- smryOutputList$tsSmry %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                   recScen = sub(pattern = "HCR.*","", scenario)) %>%
      mutate(recScen = sub(pattern = ".*selfTest_","", recScen)) %>%
      left_join(y = convrgCheck, by = c("iteration", "model_run", "scenario", "HCR", "recScen")) %>%
      mutate(plotGroup = case_when(model_run == omName ~ "OM",
                                   max_grad > 0.01 ~ "non-convrg",
                                   max_grad < 0.01 ~ "convrg"))

for(hcr in 2:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = log(Bio_smry))) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = log(50000), color = "red") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

for(hcr in 2:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = rec_dev)) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = 0, color = "gray") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

#termTS %>% filter(model_run == omName)

errCompare <- cnvrgTS %>% filter(Seas == 1, model_run != omName) %>%
                select(Bio_smry, year, model_run, iteration, scenario, HCR, recScen, emYear, plotGroup) %>%
                inner_join(y = subset(termTS, model_run == omName), 
                           by = c("year", "iteration", "scenario", "HCR", "recScen")) %>%
                #filter(iteration == 1) %>%
                  rename(age1plusOM = Bio_smry.y,
                         age1plusEM = Bio_smry.x) %>% 
                  mutate(errSmryBio = (age1plusEM - age1plusOM)/age1plusOM) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(errSmryBio)) %>%
                group_by(iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(runMSE))  #%>%
                # group_by(scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))

errCompare %>% #filter(HCR != "HCR3") %>%
  ggplot(aes(x = HCR, y = runMSE, fill = plotGroup)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~recScen) 
```
Look at parameter estimate time series
```{r}
# Look at timeseries of B0 and account for non-convergence
B0s <- smryOutputList$sclSmry %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*selfTest","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg")) 
meanB0s <- B0s %>% filter(max_grad < 0.01) %>%
              group_by(HCR, recScen, plotGroup) %>%
              summarize(meanB0est = mean(SSB_Unfished)) %>%
              mutate(pikitch0.4B0 = 0.4*meanB0est)
  
B0s %>% filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = log(SSB_Unfished))) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "B0 (Unfished SSB)") +
  geom_hline(data = meanB0s, mapping = aes(yintercept = log(meanB0est)), color = "grey") +
  geom_hline(data = meanB0s, mapping = aes(yintercept = log(pikitch0.4B0)),  color = "red")

# Want to look at the other parameters
sclSmryAll <- NULL
  
  for(scn in 1:length(scenarios)){
    # read in SSMSE results summary scalars
    sclSumry <- read.csv(file.path(mseDir, scenarios[scn], 
                                   paste0("results_scalar_", scenarios[scn], ".csv")))
    # if(!"F_MSY" %in% names(sclSumry)){ # no catch scenarios don't have F_MSY
    #   sclSumry$F_MSY <- NA
    #   sclSumry$SSB_Unfished <- NA
    # }
    # sclSumry <- sclSumry[, c("F_MSY", "SmryBio_Unfished", "SSB_Unfished",
    #                          "max_grad", "model_run", "iteration", "scenario")]
      
    sclSmryAll <- bind_rows(sclSmryAll, sclSumry)
  } # end 'scn' for-loop

sclSmryAll %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*selfTest","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg"))  %>%
  filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = SR_LN_R0)) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "Ln(R0)")

sclSmryAll %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*selfTest","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg"))  %>%
  filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = SR_regime_BLK1repl_2000)) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "SR regime")

sclSmryAll %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*selfTest","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg"))  %>%
  filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = InitF_seas_2_flt_2MexCal_S2)) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "Seas 2 MexCal2 Initial F")

sclSmryAll %>% select(max_grad, params_on_bound, params_stuck_low, params_stuck_high,
                      iteration, model_run, scenario) %>%
  filter(model_run != omName)
```

# EM 2001 self test, recruitment at SD=0.25, perfect information, turning on params

```{r}
mseDir <- "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios"

scenarios <- c("fixedParams2001OM_SD0.25_RandRecHCR0",
               "fixedParams2001OM_SD0.25_RandRecHCR2")

smryOutputList <- GetSumryOutput(dirSSMSE = mseDir,
                                 scenarios = scenarios)

smryOutputList$dqSmry$model_run <- sub("0.", "dot", 
                                       smryOutputList$dqSmry$model_run, fixed = TRUE)
smryOutputList$sclSmry$model_run <- sub("0.", "dot", 
                                       smryOutputList$sclSmry$model_run, fixed = TRUE)
smryOutputList$tsSmry$model_run <- sub("0.", "dot", 
                                       smryOutputList$tsSmry$model_run, fixed = TRUE)

performanceList <- CalcPerformance(smryOutputList)

metricsTbl <- performanceList$perfomanceMetrics

# parse out HCR and recruitment scenario
metricsTbl <- metricsTbl %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                    recScen = sub(pattern = "HCR.*","", scenario)) %>%
                mutate(recScen = sub(pattern = ".*OM_","", recScen))

hcrPal <- brewer.pal(10, "Set3")[-2]

# plot convergence frequency
metricsTbl %>% filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = frqNonConvg)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_brewer(palette = hcrPal)

# get terminal estimates of these values for timeseries plots
termTS <- CalcTermTS(smryOutputList) %>% 
              mutate(HCR = sub(pattern = ".*Rec","", scenario),
                               recScen = sub(pattern = "HCR.*","", scenario)) %>%
              mutate(recScen = sub(pattern = ".*OM_","", recScen))

omName <- grep("_OM", smryOutputList$tsSmry$model_run, 
                 fixed = TRUE, value = TRUE)[1]

convrgCheck <- smryOutputList$sclSmry %>% 
                  select(max_grad, model_run, iteration, scenario) %>%
                  mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
                  mutate(recScen = sub(pattern = ".*OM_","", recScen))  

hcrs <- unique(termTS$HCR)
#exIters <- sample(termTS$iteration, size = 4)

cnvrgTS <- smryOutputList$tsSmry %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                   recScen = sub(pattern = "HCR.*","", scenario)) %>%
      mutate(recScen = sub(pattern = ".*OM_","", recScen)) %>%
      left_join(y = convrgCheck, by = c("iteration", "model_run", "scenario", "HCR", "recScen")) %>%
      mutate(plotGroup = case_when(model_run == omName ~ "OM",
                                   max_grad > 0.01 ~ "non-convrg",
                                   max_grad < 0.01 ~ "convrg"))

for(hcr in 2:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = log(Bio_smry))) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = log(50000), color = "red") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

for(hcr in 2:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = rec_dev)) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = 0, color = "gray") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

#termTS %>% filter(model_run == omName)

errCompare <- cnvrgTS %>% filter(Seas == 1, model_run != omName) %>%
                select(Bio_smry, year, model_run, iteration, scenario, HCR, recScen, emYear, plotGroup) %>%
                inner_join(y = subset(termTS, model_run == omName), 
                           by = c("year", "iteration", "scenario", "HCR", "recScen")) %>%
                #filter(iteration == 1) %>%
                  rename(age1plusOM = Bio_smry.y,
                         age1plusEM = Bio_smry.x) %>% 
                  mutate(errSmryBio = (age1plusEM - age1plusOM)/age1plusOM) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(errSmryBio)) %>%
                group_by(iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(runMSE))  #%>%
                # group_by(scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))

errCompare %>% #filter(HCR != "HCR3") %>%
  ggplot(aes(x = HCR, y = runMSE, fill = plotGroup)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~recScen) 
```
Look at parameter estimate time series
```{r}
# Look at timeseries of B0 and account for non-convergence
B0s <- smryOutputList$sclSmry %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*OM_","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg")) 
meanB0s <- B0s %>% filter(max_grad < 0.01) %>%
              group_by(HCR, recScen, plotGroup) %>%
              summarize(meanB0est = mean(SSB_Unfished)) %>%
              mutate(pikitch0.4B0 = 0.4*meanB0est)
  
B0s %>% filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = log(SSB_Unfished))) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "B0 (Unfished SSB)") +
  geom_hline(data = meanB0s, mapping = aes(yintercept = log(meanB0est)), color = "grey") +
  geom_hline(data = meanB0s, mapping = aes(yintercept = log(pikitch0.4B0)),  color = "red")

# Want to look at the other parameters
sclSmryAll <- NULL
  
  for(scn in 1:length(scenarios)){
    # read in SSMSE results summary scalars
    sclSumry <- read.csv(file.path(mseDir, scenarios[scn], 
                                   paste0("results_scalar_", scenarios[scn], ".csv")))
    # if(!"F_MSY" %in% names(sclSumry)){ # no catch scenarios don't have F_MSY
    #   sclSumry$F_MSY <- NA
    #   sclSumry$SSB_Unfished <- NA
    # }
    # sclSumry <- sclSumry[, c("F_MSY", "SmryBio_Unfished", "SSB_Unfished",
    #                          "max_grad", "model_run", "iteration", "scenario")]
      
    sclSmryAll <- bind_rows(sclSmryAll, sclSumry)
  } # end 'scn' for-loop

sclSmryAll$model_run <- sub("0.", "dot", sclSmryAll$model_run, fixed = TRUE)

sclSmryAll %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*OM_","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg"))  %>%
  filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = SR_LN_R0)) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "Ln(R0)")

sclSmryAll %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*OM_","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg"))  %>%
  filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = SR_regime_BLK1repl_2000)) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "SR regime")

sclSmryAll %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*OM_","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg"))  %>%
  filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = InitF_seas_2_flt_2MexCal_S2)) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "Seas 2 MexCal2 Initial F")

sclSmryAll %>% select(max_grad, params_on_bound, params_stuck_low, params_stuck_high,
                      iteration, model_run, scenario) %>%
  filter(model_run != omName)
```

# EM 2001 self test, recruitment at SD=0.5, h=0.6, Nsamp = 100

```{r}
mseDir <- "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios"

scenarios <- c("constGrow2001OM_MidSteepMidNsamp_RandRecHCR2",
              "constGrow2001OM_MidSteepMidNsamp_RandRecHCREM")

smryOutputList <- GetSumryOutput(dirSSMSE = mseDir,
                                 scenarios = scenarios)

smryOutputList$dqSmry$model_run <- sub("Steepness0dot6", "MidSteep", 
                                       smryOutputList$dqSmry$model_run, fixed = TRUE)
smryOutputList$sclSmry$model_run <- sub("Steepness0dot6", "MidSteep", 
                                       smryOutputList$sclSmry$model_run, fixed = TRUE)
smryOutputList$tsSmry$model_run <- sub("Steepness0dot6", "MidSteep", 
                                       smryOutputList$tsSmry$model_run, fixed = TRUE)

performanceList <- CalcPerformance(smryOutputList)

metricsTbl <- performanceList$perfomanceMetrics

# parse out HCR and recruitment scenario
metricsTbl <- metricsTbl %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                    recScen = sub(pattern = "HCR.*","", scenario)) %>%
                mutate(recScen = sub(pattern = ".*OM_","", recScen))

hcrPal <- brewer.pal(10, "Set3")[-2]

# plot convergence frequency
metricsTbl %>% filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = frqNonConvg)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_brewer(palette = hcrPal)

# get terminal estimates of these values for timeseries plots
termTS <- CalcTermTS(smryOutputList) %>% 
              mutate(HCR = sub(pattern = ".*Rec","", scenario),
                               recScen = sub(pattern = "HCR.*","", scenario)) %>%
              mutate(recScen = sub(pattern = ".*OM_","", recScen))

omName <- grep("_OM", smryOutputList$tsSmry$model_run, 
                 fixed = TRUE, value = TRUE)[1]

convrgCheck <- smryOutputList$sclSmry %>% #filter(!model_run %in% omName) %>%
                  select(max_grad, model_run, iteration, scenario) %>%
                  mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
                  mutate(recScen = sub(pattern = ".*OM_","", recScen))  

hcrs <- unique(termTS$HCR)
#exIters <- sample(termTS$iteration, size = 4)

cnvrgTS <- smryOutputList$tsSmry %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                   recScen = sub(pattern = "HCR.*","", scenario)) %>%
      mutate(recScen = sub(pattern = ".*OM_","", recScen)) %>%
      left_join(y = convrgCheck, by = c("iteration", "model_run", "scenario", "HCR", "recScen")) %>%
      mutate(plotGroup = case_when(model_run == omName ~ "OM",
                                   max_grad > 0.01 ~ "non-convrg",
                                   max_grad < 0.01 ~ "convrg"))

for(mr in 1:length(scenarios)){
  print(cnvrgTS %>% filter(scenario == scenarios[mr], Seas == 1) %>%
      ggplot(aes(x = year, y = log(Bio_smry))) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = log(50000), color = "red") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = scenarios[mr]))
}

for(mr in 1:length(scenarios)){
  print(cnvrgTS %>% filter(scenario == scenarios[mr], Seas == 1) %>%
      ggplot(aes(x = year, y = rec_dev)) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = 0, color = "gray") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = scenarios[mr]))
}

#termTS %>% filter(model_run == omName)

errCompare <- cnvrgTS %>% filter(Seas == 1, model_run != omName) %>%
                select(Bio_smry, year, model_run, iteration, scenario, HCR, 
                       recScen, emYear, plotGroup) %>%
                inner_join(y = subset(termTS, model_run == omName), 
                           by = c("year", "iteration", "scenario", "HCR", "recScen")) %>%
                #filter(iteration == 1) %>%
                  rename(age1plusOM = Bio_smry.y,
                         age1plusEM = Bio_smry.x) %>% 
                  mutate(errSmryBio = (age1plusEM - age1plusOM)/age1plusOM) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, 
                       iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(errSmryBio)) %>%
                group_by(iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(runMSE))  #%>%
                # group_by(scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))

errCompare %>% #filter(HCR != "HCR3") %>%
  ggplot(aes(x = HCR, y = runMSE, fill = plotGroup)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~recScen) 

PlotEMAnnualEsts(dirSSMSE = mseDir, scenarios = scenarios,
                 varCol = c("SSB_Unfished", #"NatM_uniform_Fem_GP_1",
                            "L_at_Amin_Fem_GP_1", "SR_LN_R0",
                            "SR_regime_BLK1repl_2000", "InitF_seas_2_flt_2MexCal_S2",
                            "CV_old_Fem_GP_1"))

convrgCheck %>%
  ggplot(aes(x = emYear, y = max_grad)) +
  geom_line(aes(linetype = scenario))+
  scale_linetype_manual(values = rep("solid", 51)) +
  guides(linetype = "none") +
  facet_grid(rows = vars(recScen), cols = vars(iteration), scales = "free") +
  theme_classic() + theme(legend.position="none")

# investigate non-converged models
# omOut <- SS_output("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_selfTestMidSteepFixRec_RandRecHCR2/1/constGrowthSteepness0dot6_OM_OM")
# fixedOut <- SS_output("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_selfTestMidSteepFixRec_RandRecHCR2/1/constGrowFixRec_EM_2035")
# compFixed <- SSsummarize(list(OM = omOut, EM2032 = fixedOut))
# compFixed$pars$relErr <- round((compFixed$pars$EM2032 - compFixed$pars$OM)/compFixed$pars$OM, digits = 3)
# SSplotComparisons(compFixed)
# compFixed$pars

```
Take closer look at estimated derived and parameter values
```{r}
# error of params 
hcr2 <- read_csv(file = file.path(mseDir, scenarios[1], "results_scalar_constGrow2001OM_MidSteepMidNsamp_RandRecHCR2.csv"))
hcr2Fixed <- read_csv(file = file.path(mseDir, scenarios[2], "results_scalar_constGrow2001OM_MidSteepMidNsamp_RandRecHCREM.csv"))
sclHCR2 <- rbind(hcr2, hcr2Fixed)
unique(sclHCR2[, c("params_on_bound", "params_stuck_low", "params_stuck_high", "scenario")])

parCols <- c("CV_old_Fem_GP_1", "Size_95.width_MexCal_S1_1", "CV_young_Fem_GP_1", 
             "VonBert_K_Fem_GP_1", "SR_regime_BLK1repl_2000","L_at_Amax_Fem_GP_1",
             "L_at_Amin_Fem_GP_1", "SR_LN_R0")
focPars <- sclHCR2 %>% select(max_grad, parCols, 
                              model_run, iteration, scenario) %>%
            pivot_longer(cols = parCols, names_to = "parameter", values_to = "value")
focParsOM <- focPars %>% filter(grepl("_OM", model_run, fixed = TRUE))
focPars <- focPars %>% filter(!grepl("_OM", model_run, fixed = TRUE)) %>%
              left_join(y = focParsOM, by = c("iteration", "scenario", "parameter")) %>%
              mutate(parRE = (value.x - value.y)/value.y * 100,
                     emYear = as.numeric(regmatches(model_run.x,
                                                    gregexpr("[[:digit:]]+", 
                                                              model_run.x))),
                     convg = case_when(max_grad.x > 0.01 ~ "non-convg",
                                       max_grad.x < 0.01 ~ "convg")) 

focPars %>% ggplot(aes(x = emYear, y = value.x, color = scenario)) + 
  #geom_line() + 
  geom_point() + 
  facet_grid(rows = vars(parameter), cols = vars(convg), scales = "free") + 
  geom_hline(aes(yintercept = value.y))

pairs(focPars %>% mutate(combo = paste(scenario, iteration, model_run.x, sep = "-")) %>%
        dcast(combo ~ parameter, value.var = "value.x") %>% 
        select(unique(focPars$parameter)))

# error of summary biomass
simDat <- smryOutputList$obsCPUE %>% mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                                            model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                                            iteration = str_extract(resDir, "/\\d/")) %>%
              mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                     iteration = as.numeric(str_extract(iteration, "\\d")),
                     plotGroup = "simData") %>%
              rename(Bio_smry = obs) %>%
              filter(!grepl("_OM", model_run, fixed = TRUE), index == 4, seas != 10) %>%
                  select(year, Bio_smry, model_run, iteration, scenario, plotGroup)

age1PlusBio <- smryOutputList$tsSmry %>% filter(Seas == 1) %>%
                  select(year, Bio_smry, model_run, iteration, scenario) %>%
                  mutate(plotGroup = case_when(grepl("_OM", model_run, fixed = TRUE) ~ "OM",
                                               TRUE ~ "EM"))

age1PlusRE <- age1PlusBio %>% filter(plotGroup != "OM")
age1PlusRE <- rbind(age1PlusRE, simDat)
age1PlusRE <- age1PlusRE %>% pivot_wider(names_from = "plotGroup", values_from = "Bio_smry") %>%
                  left_join(y = convrgCheck, 
                            by = c("model_run", "iteration", "scenario")) %>%
                  full_join(y = subset(age1PlusBio, subset = plotGroup == "OM"), 
                            by = c("iteration", "scenario", "year")) %>%
                  mutate(convrg = case_when(max_grad > 0.01 ~ "non-convrg",
                                            max_grad < 0.01 ~ "convrg",
                                            TRUE ~ "OM"),
                         datRE = (simData - Bio_smry)/Bio_smry * 100,
                         emRE = (EM - Bio_smry)/Bio_smry * 100)

age1PlusBio <- rbind(age1PlusBio, simDat)
age1PlusBio <- age1PlusBio %>% left_join(y = convrgCheck, 
                                         by = c("model_run", "iteration", "scenario")) %>%
                  mutate(convrg = case_when(max_grad > 0.01 ~ "non-convrg",
                                            max_grad < 0.01 ~ "convrg",
                                            TRUE ~ "OM"))

for(mr in 1:length(scenarios)){
  print(age1PlusBio %>% filter(scenario == scenarios[mr], plotGroup != "simData") %>%
    ggplot(aes(x = year, y = log(Bio_smry))) +
    ggplot2::geom_vline(xintercept = 2019, color = "gray") +
    ggplot2::geom_line(ggplot2::aes(linetype = as.character(model_run), color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
    ggplot2::guides(linetype = "none") +
     ggplot2::facet_grid(rows = vars(iteration)) +
    ggplot2::theme_classic() +
  labs(title = scenarios[mr]))
}

# Plot relative errors of biomass over time
age1PlusRE %>% filter(HCR != "HCR0") %>%
    ggplot(aes(x = year, y = ifelse(emRE > 100, 100, emRE))) + #y = emRE)) +
    geom_vline(xintercept = 2019, color = "gray") +
    geom_vline(xintercept = 2030, color = "coral1") +
    geom_hline(yintercept = 0, color = "gray") +
    geom_line(aes(linetype = as.character(model_run.x), color = convrg))+
    geom_point(aes(y = datRE), shape = 4, color = "grey") +
    scale_color_manual(values = c("black", "blue", "#D65F00")) +
    scale_linetype_manual(values = rep("solid", 51)) +
    guides(linetype = "none") +
    facet_grid(rows = vars(iteration), cols = vars(scenario)) +
    theme_classic() + labs(title = "Relative Error of Age 1+ Biomass (%)") + 
    ylim(-100, 100)

# error of catch
simCat <- smryOutputList$obsCatch %>% mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                                            model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                                            iteration = str_extract(resDir, "/\\d/")) %>%
              mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                     iteration = as.numeric(str_extract(iteration, "\\d")),
                     plotGroup = "simCatch") %>%
              group_by(year, model_run, iteration, scenario, plotGroup) %>%
                # summarize total catch within year
                dplyr::summarize(totCatch = sum(catch)) %>%
              filter(!grepl("_OM", model_run, fixed = TRUE), year != -999) %>%
                  select(year, totCatch, model_run, iteration, scenario, plotGroup)

catchTS <- smryOutputList$tsSmry %>% 
                  mutate(totCatch = retainB_1 + retainB_2 + retainB_3) %>%
                  group_by(year, model_run, iteration, scenario) %>%
                # summarize total catch within year
                dplyr::summarize(totCatch = sum(totCatch)) %>%
                  select(year, totCatch, model_run, iteration, scenario) %>%
                  mutate(plotGroup = case_when(grepl("_OM", model_run, fixed = TRUE) ~ "OM",
                                               TRUE ~ "EM"))

catchRE <- catchTS %>% filter(plotGroup != "OM")
catchRE <- rbind(catchRE, simCat)
catchRE <- catchRE %>% pivot_wider(names_from = "plotGroup", values_from = "totCatch") %>%
                  left_join(y = convrgCheck, 
                            by = c("model_run", "iteration", "scenario")) %>%
                  full_join(y = subset(catchTS, subset = plotGroup == "OM"), 
                            by = c("iteration", "scenario", "year")) %>%
                  mutate(convrg = case_when(max_grad > 0.01 ~ "non-convrg",
                                            max_grad < 0.01 ~ "convrg",
                                            TRUE ~ "OM"),
                         datRE = (simCatch - totCatch)/(totCatch + 0.0001) * 100, # add small amount so not div by 0
                         emRE = (EM - totCatch)/(totCatch + 0.0001) * 100)

catchTS <- rbind(catchTS, simCat)
catchTS <- catchTS %>% left_join(y = convrgCheck, 
                                         by = c("model_run", "iteration", "scenario")) %>%
                  mutate(convrg = case_when(max_grad > 0.01 ~ "non-convrg",
                                            max_grad < 0.01 ~ "convrg",
                                            TRUE ~ "OM"))

for(mr in 1:length(scenarios)){
  print(catchTS %>% filter(scenario == scenarios[mr]) %>%
    ggplot(aes(x = year, y = log(totCatch))) +
    ggplot2::geom_vline(xintercept = 2019, color = "gray") +
    ggplot2::geom_line(ggplot2::aes(linetype = as.character(model_run), color = plotGroup))+
    ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
    ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(iteration)) +
    ggplot2::theme_classic() +
  labs(title = scenarios[mr]))
}

# Plot relative errors of biomass over time
catchRE %>% filter(HCR != "HCR0") %>%
    ggplot(aes(x = year, y = emRE)) +
    geom_vline(xintercept = 2019, color = "gray") +
    geom_line(aes(linetype = as.character(model_run.x), color = convrg))+
    geom_point(aes(y = datRE), shape = 4, color = "grey") +
    scale_color_manual(values = c("black", "blue", "#D65F00")) +
    scale_linetype_manual(values = rep("solid", 51)) +
    guides(linetype = "none") +
    facet_grid(cols = vars(iteration), rows = vars(scenario), scales = "free") +
    theme_classic() + labs(title = "Relative Error of Catch (%)")
```
Model expects high catches for 2020 in initial EM fit (emYear 2019)

Check harvest guideline from EMs
```{r}
# Use parallelization to pull in composition and EM data ------------------
  # Adapted from code from Peter Kuriyama
  
  # set up the directories
  # get the iterations
  resultsDirs <- NULL
  for(scn in 1:length(scenarios)){
    iters <- list.dirs(file.path(mseDir, scenarios[scn]), recursive = FALSE, full.names = FALSE)
  
    # get the model directory names
    runNames <- list.dirs(file.path(mseDir, scenarios[scn], iters[1]),
                           recursive = FALSE,
                           full.names = FALSE)
    # remove OM folder from list
    runNames <- runNames[-grep("_OM", runNames, fixed = TRUE)]
    
    #The results directories to read in
    scnResultsDirs <- expand_grid(scenarios[scn], iters, runNames) %>% 
                    mutate(scen = file.path(mseDir, `scenarios[scn]`, iters, runNames)) %>%
                    pull(scen)
    
    resultsDirs <- c(resultsDirs, scnResultsDirs)
  }
  
  
  # extract wanted tables per directory and add data origin
  start_time <- Sys.time()
  ncores <- detectCores() - 2 #Leave some cores open for background stuff
  cl <- makeCluster(ncores)
  registerDoParallel(cl)
  
  resultsList <- foreach::foreach(ii = 1:length(resultsDirs),
                                  
                                  .packages = c("tidyverse", 'r4ss')) %dopar% {
                                    outList <- SS_output(resultsDirs[ii], 
                                              covar = FALSE, printstats = FALSE,
                                              verbose = FALSE)
                                    outList %>% magrittr::extract("sprseries") %>%
                                      map2(.y = resultsDirs[ii], 
                                           .f = function(x, y){x['resDir'] <- y;x})
                                  }
  stopCluster(cl)
  run_time <- Sys.time() - start_time; run_time #To see how long it takes
  
  # summarize into single table for export
  smryForeBio <- resultsList %>% map_dfr(magrittr::extract2, "sprseries") %>%
                    filter(Era=="FORE") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d"))) %>%
                    select(Yr, Bio_Smry.1, scenario, model_run, iteration)
  
# apply HCR as calculated in HCR_sar_hcr2.R
  
#upload the CalCOFI temperature timeseries
 Ctemp=read.csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/dat/calcofi_sst_projected.csv")
 # Ctemp=read.csv("J:/Desiree/Sardine/SardineMSE/dat/calcofi_sst_projected.csv")
  
 #extract the average for the three years prior to the forecast
 #Tyr=c((EMts$Yr[1]-1),(EMts$Yr[1]-2),(EMts$Yr[1]-3))
 #Temsy = mean(Ctemp$gfdl_sst_all[Ctemp$year %in% Tyr])#here we might need to create a separte hcr 2 function for each projection or have the GCM as an input to the function
 smryForeBio$Temsy <- NA
 for(i in 1:nrow(smryForeBio)){
   smryForeBio[i, "Temsy"] <- mean(Ctemp$gfdl_sst_all[Ctemp$year %in% (smryForeBio[i, "Yr"]-3):(smryForeBio[i, "Yr"]-1)])
 }
 
 #set input to hcr
  #Emsy = -18.46452+3.25209*Temsy-0.19723*Temsy^2+0.0041863*Temsy^3
smryForeBio <- smryForeBio %>% mutate(Emsy = -18.46452+3.25209*Temsy-0.19723*Temsy^2+0.0041863*Temsy^3)
  cutoff = 150000
  distribution = 0.87
  
  #if biomass is less than the cutoff, the harvest guideline is set to 0, if not the current hg rule is ised
  #HG=(BIOMASS-CUTOFF)xFRACTIONxDISTRIBUTION
  #Note that as there are still
  # if (bio1 < cutoff) {HG = 0 } else {HG = (bio1-cutoff)*Emsy*distribution}
  # 
  # #the hg is capped at a maximum catch of 200000 mt
  # if (HG > 200000) {HG = 200000}

smryForeBio <- smryForeBio %>% mutate(HG = case_when(Bio_Smry.1 < cutoff ~ 0,
                                                     TRUE ~ (Bio_Smry.1-cutoff)*Emsy*distribution)) %>%
                  mutate(HG = case_when(HG > 200000 ~ 200000,
                                        TRUE ~ HG)) %>%
                  left_join(y = subset(catchTS, subset = plotGroup == "OM"), 
                            by = c("Yr" = "year", "scenario", "iteration")) %>%
                  left_join(y = subset(age1PlusBio, subset = plotGroup == "OM"), 
                            by = c("Yr" = "year", "scenario", "iteration")) %>%
                  select(Yr, scenario, model_run.x, iteration, Bio_Smry.1, HG, Bio_smry, totCatch, HCR.y, recScen.y)

smryForeBio %>% ggplot(aes(x = Yr, y = (totCatch - HG))) +
  geom_vline(xintercept = 2019, color = "gray") +
  geom_line(aes(linetype = as.character(scenario)))+
  geom_point(aes(y = (Bio_Smry.1 - Bio_smry)/Bio_smry*100), shape = 4, color = "grey") +
    scale_linetype_manual(values = rep("solid", 51)) +
    guides(linetype = "none") +
    facet_grid(rows = vars(iteration), cols = vars(scenario)) +
    theme_classic() + labs(title = "Difference from HG and Catch w/ Biomass RE (%)")

# compare OM, EM, and HG total catches

# look at catches listed in OM data files
# set up the directories
  # get the iterations
  omDirs <- NULL
  for(scn in 1:length(scenarios)){
    iters <- list.dirs(file.path(mseDir, scenarios[scn]), recursive = FALSE, full.names = FALSE)
  
    # get the model directory names
    runNames <- list.dirs(file.path(mseDir, scenarios[scn], iters[1]),
                           recursive = FALSE,
                           full.names = FALSE)
    # keep only OM folder from list
    runNames <- runNames[grep("_OM", runNames, fixed = TRUE)]
    
    #The results directories to read in
    scnResultsDirs <- expand_grid(scenarios[scn], iters, runNames) %>% 
                    mutate(scen = file.path(mseDir, `scenarios[scn]`, iters, runNames)) %>%
                    pull(scen)
    
    omDirs <- c(omDirs, scnResultsDirs)
  }
  
  
  # extract wanted tables per directory and add data origin
  start_time <- Sys.time()
  ncores <- detectCores() - 2 #Leave some cores open for background stuff
  cl <- makeCluster(ncores)
  registerDoParallel(cl)
  
 omDataList <- foreach::foreach(ii = 1:length(omDirs),
                                  
                                  .packages = c("tidyverse", 'r4ss')) %dopar% {
                                    outList <- SS_readdat(file.path(omDirs[ii], "data.ss"),
                                                          version = "3.30", verbose = FALSE)
                                    outList %>% magrittr::extract(c("catch", "CPUE")) %>%
                                      map2(.y = omDirs[ii], 
                                           .f = function(x, y){x['resDir'] <- y;x})
                                  }
  stopCluster(cl)
  
  # summarize into single table for export
  omDataCatch <- omDataList %>% map_dfr(magrittr::extract2, "catch") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d"))) %>%
                    rename(catchDat = catch)
  
    cl <- makeCluster(ncores)
  registerDoParallel(cl)
 omDataExpList <- foreach::foreach(ii = 1:length(omDirs),
                                  
                                  .packages = c("tidyverse", 'r4ss')) %dopar% {
                                    outList <- SS_readdat(file.path(omDirs[ii], "data.ss_new"),
                                                          version = "3.30", verbose = FALSE,
                                                          section = 2)
                                    outList %>% magrittr::extract(c("catch", "CPUE")) %>%
                                      map2(.y = omDirs[ii], 
                                           .f = function(x, y){x['resDir'] <- y;x})
                                  }
  stopCluster(cl)
  
  # summarize into single table for export
  omDataExpCatch <- omDataExpList %>% map_dfr(magrittr::extract2, "catch") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d")))%>%
                    rename(catchExp = catch)
  
    cl <- makeCluster(ncores)
registerDoParallel(cl)
 omDataBootList <- foreach::foreach(ii = 1:length(omDirs),
                                  
                                  .packages = c("tidyverse", 'r4ss')) %dopar% {
                                    outList <- SS_readdat(file.path(omDirs[ii], "data.ss_new"),
                                                          version = "3.30", verbose = FALSE,
                                                          section = 3)
                                    outList %>% magrittr::extract(c("catch", "CPUE")) %>%
                                      map2(.y = omDirs[ii], 
                                           .f = function(x, y){x['resDir'] <- y;x})
                                  }
  stopCluster(cl)
  # summarize into single table for export
  omDataBootCatch <- omDataBootList %>% map_dfr(magrittr::extract2, "catch") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d")))%>%
                    rename(catchBoot = catch)

# need to look at conditioning data for EM runs
cl <- makeCluster(ncores)
registerDoParallel(cl)
 emDataList <- foreach::foreach(ii = 1:length(resultsDirs),
                                  
                                  .packages = c("tidyverse", 'r4ss')) %dopar% {
                                    outList <- SS_readdat(file.path(resultsDirs[ii], "init_dat.ss"),
                                                          version = "3.30", verbose = FALSE)
                                    outList %>% magrittr::extract(c("catch", "CPUE")) %>%
                                      map2(.y = resultsDirs[ii], 
                                           .f = function(x, y){x['resDir'] <- y;x})
                                  }
  stopCluster(cl)
  # summarize into single table for export
  emDataCatch <- emDataList %>% map_dfr(magrittr::extract2, "catch") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d")))%>%
                    rename(catchEMInit = catch) %>%
                    group_by(year, resDir, scenario, model_run, iteration) %>%
                    summarize(totCatchInitDatEM = sum(catchEMInit)) %>%
                    filter(year != -999)
    run_time <- Sys.time() - start_time; run_time #To see how long it takes

    
omDataCatch <- omDataCatch %>% left_join(y = omDataExpCatch, 
                                         by = c("year", "seas", "fleet", "resDir", 
                                                "scenario", "model_run", "iteration")) %>%
                  left_join(y = omDataBootCatch, 
                            by = c("year", "seas", "fleet", "resDir", 
                                   "scenario", "model_run", "iteration")) %>%
                  group_by(year, resDir, scenario, model_run, iteration) %>%
                  summarize(totCatchDat = sum(catchDat),
                            totCatchExp = sum(catchExp),
                            totCatchBoot = sum(catchBoot)) %>%
                  filter(year != -999)

# add OM catch from tsSmry
omDataCatch <- omDataCatch %>% left_join(y = subset(catchTS, subset = plotGroup == "OM"), 
                                         by = c("year", "scenario", "iteration")) %>% 
                  rename(totCatchTSOM = totCatch)

# add OM catch from data.ss_new file
omDatNewCat <- smryOutputList$obsCatch %>% mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                                            model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                                            iteration = str_extract(resDir, "/\\d/")) %>%
              mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                     iteration = as.numeric(str_extract(iteration, "\\d")),
                     plotGroup = "OM") %>%
              group_by(year, model_run, iteration, scenario, plotGroup) %>%
                # summarize total catch within year
                dplyr::summarize(totCatchDatNewOM = sum(catch)) %>%
              filter(grepl("_OM", model_run, fixed = TRUE), year != -999) %>%
                  select(year, totCatchDatNewOM, model_run, iteration, scenario, plotGroup)

omDataCatch <- omDataCatch %>% left_join(y = omDatNewCat, 
                                         by = c("year", "scenario", "iteration",
                                                "model_run.x" = "model_run"))

catchTS <- omDataCatch %>% left_join(y = subset(catchTS, subset = plotGroup == "EM"), 
                          by = c("year", "iteration", "scenario",  
                                 "recScen", "HCR")) %>% 
              rename(totCatchEstEM = totCatch) %>%
              left_join(y = subset(catchTS, subset = plotGroup == "simCatch"), 
                        by = c("year", "iteration", "scenario", "emYear.y" = "emYear", 
                               "recScen", "HCR", "model_run")) %>% 
              rename(totCatchSimDatEM = totCatch) %>% 
              left_join(y = emDataCatch, by = c("year", "iteration", "scenario", "model_run")) %>%
              ungroup() %>%
              select(year, iteration, scenario, emYear.y, recScen, HCR, max_grad.x, convrg.x,
                     totCatchDat, totCatchDatNewOM, totCatchExp, totCatchBoot, 
                     totCatchTSOM, totCatchInitDatEM, totCatchSimDatEM, totCatchEstEM)

# Note: the HG is the catch advice provided from the HCR from the previous emYear 
#       to be applied in 'year'
catchTS <- catchTS %>% left_join(smryForeBio, 
                                 by = c("year" = "Yr", "iteration", "scenario",
                                        "recScen" = "recScen.y", "HCR" = "HCR.y")) %>%
              rename(emForeBioSmry = Bio_Smry.1,
                     omBioSmry = Bio_smry) %>%
              select(year, iteration, scenario, emYear.y, recScen, HCR, max_grad.x, 
                     convrg.x, HG, totCatchDat, totCatchDatNewOM, totCatchExp, totCatchBoot, 
                     totCatchTSOM, totCatchInitDatEM, totCatchSimDatEM, totCatchEstEM, emForeBioSmry, omBioSmry)
catchTS %>% filter(year %in% 2028:2032, emYear.y %in% 2028:2032,
                   iteration == 1, scenario == scenarios[1]) %>% select(-scenario, -recScen, -HCR)

# omOut <- SS_output("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_MidSteepMidNsamp_RandRecHCR2/1/constGrowthSteepness0dot6_OM_OM")
# em2030Out <- SS_output("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_MidSteepMidNsamp_RandRecHCR2/1/constGrowSelfTest_EM_2030")
# compFree <- SSsummarize(list(OM = omOut, EM2029 = em2029Out))

#SS_plots(em2030Out)
```
Check out the CPUE timeseries and EM implementation
```{r}
datNewCPUE <- smryOutputList$obsCPUE %>% mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                                            model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                                            iteration = str_extract(resDir, "/\\d/")) %>%
              mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                     iteration = as.numeric(str_extract(iteration, "\\d"))) %>%
              filter(seas == 1, index %in% c(4, -4))
cpueTS <- datNewCPUE %>% filter(grepl("_OM", model_run, fixed = TRUE)) %>%
              rename(cpueDatNewOM = obs) %>%
              full_join(y = subset(datNewCPUE, subset = !grepl("_OM", model_run, fixed = TRUE)), 
                          by = c("year", "seas", "index", "iteration", "scenario")) %>% 
              rename(cpueDatNewEM = obs)

omDataCPUE <- omDataList %>% map_dfr(magrittr::extract2, "CPUE") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d"))) %>%
                    rename(cpueDatOM = obs) %>%
                    filter(seas == 1, index %in% c(4, -4))

omDataExpCPUE <- omDataExpList %>% map_dfr(magrittr::extract2, "CPUE") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d"))) %>%
                    rename(cpueDatExpOM = obs) %>%
                    filter(seas == 1, index %in% c(4, -4))

omDataBootCPUE <- omDataBootList %>% map_dfr(magrittr::extract2, "CPUE") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d"))) %>%
                    rename(cpueDatBootOM = obs) %>%
                    filter(seas == 1, index %in% c(4, -4))

emDataCPUE <- emDataList %>% map_dfr(magrittr::extract2, "CPUE") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d")))%>%
                    rename(cpueInitEM = obs) %>%
                    filter(seas == 1, index %in% c(4, -4))

omDataCPUE <- omDataCPUE %>% left_join(y = omDataExpCPUE, 
                                         by = c("year", "seas", "resDir", 
                                                "scenario", "model_run", "iteration")) %>%
                  left_join(y = omDataBootCPUE, 
                            by = c("year", "seas",  "resDir", 
                                   "scenario", "model_run", "iteration")) %>%
                  full_join(y = emDataCPUE,
                            by = c("year", "seas",  "scenario", "iteration"))

cpueTS <- cpueTS %>% left_join(y = omDataCPUE, by = c("year", "seas", "scenario", 
                                            "iteration", "model_run.y", "resDir.y")) %>%
            select(year, scenario, iteration, model_run.y, cpueDatOM, cpueDatNewOM,
                   cpueDatExpOM, cpueDatBootOM, cpueInitEM, cpueDatNewEM) %>%
            mutate(emYear = as.numeric(regmatches(model_run.y,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run.y))))
cpueTS %>% filter(!is.na(model_run.y), scenario == scenarios[1])
cpueTS %>% filter(year %in% 2028:2032, emYear %in% 2028:2032,
                   iteration == 1, scenario == scenarios[1]) %>%
  arrange(year, emYear) %>% select(-scenario)
```
Plot AT index 4 against actual biomass and EM catch data against actual catch
```{r}
catchTS %>% ggplot(aes(x = year, y = omBioSmry)) +
  geom_line() +
  geom_line(data = cpueTS, mapping = aes(y = cpueInitEM, color = model_run.y)) +
  facet_grid(rows = vars(iteration), cols = vars(scenario)) +
  theme(legend.position = "none",
        strip.text = element_text(size = 15))

catchTS %>% ggplot(aes(x = year, y = totCatchTSOM)) +
  geom_line() +
  geom_line(aes(y = totCatchInitDatEM, color = emYear.y)) +
  geom_line(aes(y = HG, color = emYear.y)) +
  facet_grid(cols = vars(iteration), rows = vars(scenario)) +
  theme(legend.position = "none")

```

# EM 2001 self test, recruitment at SD=0.5, h=0.6, corrected sample size

```{r}
mseDir <- "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios"

scenarios <- c("constGrow2001OM_selfTestMidSteep_RandRecHCR0",
              "constGrow2001OM_selfTestMidSteep_RandRecHCR2",
              "constGrow2001OM_selfTestMidSteepFixRec_RandRecHCR2")

smryOutputList <- GetSumryOutput(dirSSMSE = mseDir,
                                 scenarios = scenarios)

smryOutputList$dqSmry$model_run <- sub("Steepness0dot6", "MidSteep", 
                                       smryOutputList$dqSmry$model_run, fixed = TRUE)
smryOutputList$sclSmry$model_run <- sub("Steepness0dot6", "MidSteep", 
                                       smryOutputList$sclSmry$model_run, fixed = TRUE)
smryOutputList$tsSmry$model_run <- sub("Steepness0dot6", "MidSteep", 
                                       smryOutputList$tsSmry$model_run, fixed = TRUE)

performanceList <- CalcPerformance(smryOutputList)

metricsTbl <- performanceList$perfomanceMetrics

# parse out HCR and recruitment scenario
metricsTbl <- metricsTbl %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                    recScen = sub(pattern = "HCR.*","", scenario)) %>%
                mutate(recScen = sub(pattern = ".*OM_","", recScen))

hcrPal <- brewer.pal(10, "Set3")[-2]

# plot convergence frequency
metricsTbl %>% filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = frqNonConvg)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_brewer(palette = hcrPal)

# get terminal estimates of these values for timeseries plots
termTS <- CalcTermTS(smryOutputList) %>% 
              mutate(HCR = sub(pattern = ".*Rec","", scenario),
                               recScen = sub(pattern = "HCR.*","", scenario)) %>%
              mutate(recScen = sub(pattern = ".*OM_","", recScen))

omName <- grep("_OM", smryOutputList$tsSmry$model_run, 
                 fixed = TRUE, value = TRUE)[1]

convrgCheck <- smryOutputList$sclSmry %>% #filter(!model_run %in% omName) %>%
                  select(max_grad, model_run, iteration, scenario) %>%
                  mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
                  mutate(recScen = sub(pattern = ".*OM_","", recScen))  

hcrs <- unique(termTS$HCR)
#exIters <- sample(termTS$iteration, size = 4)

cnvrgTS <- smryOutputList$tsSmry %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                   recScen = sub(pattern = "HCR.*","", scenario)) %>%
      mutate(recScen = sub(pattern = ".*OM_","", recScen)) %>%
      left_join(y = convrgCheck, by = c("iteration", "model_run", "scenario", "HCR", "recScen")) %>%
      mutate(plotGroup = case_when(model_run == omName ~ "OM",
                                   max_grad > 0.01 ~ "non-convrg",
                                   max_grad < 0.01 ~ "convrg"))

for(mr in 2:3){
  print(cnvrgTS %>% filter(scenario == scenarios[mr], Seas == 1) %>%
      ggplot(aes(x = year, y = log(Bio_smry))) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = log(50000), color = "red") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = scenarios[mr]))
}

for(mr in 2:3){
  print(cnvrgTS %>% filter(scenario == scenarios[mr], Seas == 1) %>%
      ggplot(aes(x = year, y = rec_dev)) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = 0, color = "gray") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = scenarios[mr]))
}

#termTS %>% filter(model_run == omName)

errCompare <- cnvrgTS %>% filter(Seas == 1, model_run != omName) %>%
                select(Bio_smry, year, model_run, iteration, scenario, HCR, recScen, emYear, plotGroup) %>%
                inner_join(y = subset(termTS, model_run == omName), 
                           by = c("year", "iteration", "scenario", "HCR", "recScen")) %>%
                #filter(iteration == 1) %>%
                  rename(age1plusOM = Bio_smry.y,
                         age1plusEM = Bio_smry.x) %>% 
                  mutate(errSmryBio = (age1plusEM - age1plusOM)/age1plusOM) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(errSmryBio)) %>%
                group_by(iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(runMSE))  #%>%
                # group_by(scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))

errCompare %>% #filter(HCR != "HCR3") %>%
  ggplot(aes(x = HCR, y = runMSE, fill = plotGroup)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~recScen) 

PlotEMAnnualEsts(dirSSMSE = mseDir, scenarios = scenarios,
                 varCol = c("SSB_Unfished", #"NatM_uniform_Fem_GP_1",
                            "L_at_Amin_Fem_GP_1", "SR_LN_R0",
                            "SR_regime_BLK1repl_2000", "InitF_seas_2_flt_2MexCal_S2",
                            "CV_old_Fem_GP_1"))

convrgCheck %>%
  ggplot(aes(x = emYear, y = max_grad)) +
  geom_line(aes(linetype = scenario))+
  scale_linetype_manual(values = rep("solid", 51)) +
  guides(linetype = "none") +
  facet_grid(rows = vars(recScen), cols = vars(iteration), scales = "free") +
  theme_classic() + theme(legend.position="none")

# investigate non-converged models
omOut <- SS_output("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_selfTestMidSteepFixRec_RandRecHCR2/1/constGrowthSteepness0dot6_OM_OM")
fixedOut <- SS_output("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_selfTestMidSteepFixRec_RandRecHCR2/1/constGrowFixRec_EM_2035")
compFixed <- SSsummarize(list(OM = omOut, EM2032 = fixedOut))
compFixed$pars$relErr <- round((compFixed$pars$EM2032 - compFixed$pars$OM)/compFixed$pars$OM, digits = 3)
SSplotComparisons(compFixed)
compFixed$pars
```
Take closer look at estimated derived and parameter values
```{r}
# error of params 
hcr2 <- read_csv(file = file.path(mseDir, scenarios[2], "results_scalar_constGrow2001OM_selfTestMidSteep_RandRecHCR2.csv"))
hcr2Fixed <- read_csv(file = file.path(mseDir, scenarios[3], "results_scalar_constGrow2001OM_selfTestMidSteepFixRec_RandRecHCR2.csv"))
sclHCR2 <- rbind(hcr2, hcr2Fixed)
unique(sclHCR2[, c("params_on_bound", "params_stuck_low", "params_stuck_high", "scenario")])

parCols <- c("CV_old_Fem_GP_1", "Size_95.width_MexCal_S1_1", "CV_young_Fem_GP_1", 
             "VonBert_K_Fem_GP_1", "SR_regime_BLK1repl_2000","L_at_Amax_Fem_GP_1",
             "L_at_Amin_Fem_GP_1", "SR_LN_R0")
focPars <- sclHCR2 %>% select(max_grad, parCols, 
                              model_run, iteration, scenario) %>%
            pivot_longer(cols = parCols, names_to = "parameter", values_to = "value")
focParsOM <- focPars %>% filter(grepl("_OM", model_run, fixed = TRUE))
focPars <- focPars %>% filter(!grepl("_OM", model_run, fixed = TRUE)) %>%
              left_join(y = focParsOM, by = c("iteration", "scenario", "parameter")) %>%
              mutate(parRE = (value.x - value.y)/value.y * 100,
                     emYear = as.numeric(regmatches(model_run.x,
                                                    gregexpr("[[:digit:]]+", 
                                                              model_run.x))),
                     convg = case_when(max_grad.x > 0.01 ~ "non-convg",
                                       max_grad.x < 0.01 ~ "convg")) 

focPars %>% ggplot(aes(x = emYear, y = value.x, color = scenario)) + 
  #geom_line() + 
  geom_point() + 
  facet_grid(rows = vars(parameter), cols = vars(convg), scales = "free") + 
  geom_hline(aes(yintercept = value.y))

pairs(focPars %>% mutate(combo = paste(scenario, iteration, model_run.x, sep = "-")) %>%
        dcast(combo ~ parameter, value.var = "value.x") %>% 
        select(unique(focPars$parameter)))

# error of summary biomass
simDat <- smryOutputList$obsCPUE %>% mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                                            model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                                            iteration = str_extract(resDir, "/\\d/")) %>%
              mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                     iteration = as.numeric(str_extract(iteration, "\\d")),
                     plotGroup = "simData") %>%
              rename(Bio_smry = obs) %>%
              filter(!grepl("_OM", model_run, fixed = TRUE), index == 4, seas != 10) %>%
                  select(year, Bio_smry, model_run, iteration, scenario, plotGroup)

age1PlusBio <- smryOutputList$tsSmry %>% filter(Seas == 1) %>%
                  select(year, Bio_smry, model_run, iteration, scenario) %>%
                  mutate(plotGroup = case_when(grepl("_OM", model_run, fixed = TRUE) ~ "OM",
                                               TRUE ~ "EM"))

age1PlusRE <- age1PlusBio %>% filter(plotGroup != "OM")
age1PlusRE <- rbind(age1PlusRE, simDat)
age1PlusRE <- age1PlusRE %>% pivot_wider(names_from = "plotGroup", values_from = "Bio_smry") %>%
                  left_join(y = convrgCheck, 
                            by = c("model_run", "iteration", "scenario")) %>%
                  full_join(y = subset(age1PlusBio, subset = plotGroup == "OM"), 
                            by = c("iteration", "scenario", "year")) %>%
                  mutate(convrg = case_when(max_grad > 0.01 ~ "non-convrg",
                                            max_grad < 0.01 ~ "convrg",
                                            TRUE ~ "OM"),
                         datRE = (simData - Bio_smry)/Bio_smry * 100,
                         emRE = (EM - Bio_smry)/Bio_smry * 100)

age1PlusBio <- rbind(age1PlusBio, simDat)
age1PlusBio <- age1PlusBio %>% left_join(y = convrgCheck, 
                                         by = c("model_run", "iteration", "scenario")) %>%
                  mutate(convrg = case_when(max_grad > 0.01 ~ "non-convrg",
                                            max_grad < 0.01 ~ "convrg",
                                            TRUE ~ "OM"))

for(mr in 1:3){
  print(age1PlusBio %>% filter(scenario == scenarios[mr]) %>%
    ggplot(aes(x = year, y = log(Bio_smry))) +
    ggplot2::geom_vline(xintercept = 2019, color = "gray") +
    ggplot2::geom_line(ggplot2::aes(linetype = as.character(model_run), color = plotGroup))+
    ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
    ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(iteration), cols = vars(convrg)) +
    ggplot2::theme_classic() +
  labs(title = scenarios[mr]))
}

# Plot relative errors of biomass over time
age1PlusRE %>% filter(HCR != "HCR0") %>%
    ggplot(aes(x = year, y = ifelse(emRE > 100, 100, emRE))) + #y = emRE)) +
    geom_vline(xintercept = 2019, color = "gray") +
    geom_hline(yintercept = 0, color = "gray") +
    geom_line(aes(linetype = as.character(model_run.x), color = convrg))+
    geom_point(aes(y = datRE), shape = 4, color = "grey") +
    scale_color_manual(values = c("black", "blue", "#D65F00")) +
    scale_linetype_manual(values = rep("solid", 51)) +
    guides(linetype = "none") +
    facet_grid(rows = vars(iteration), cols = vars(scenario)) +
    theme_classic() + labs(title = "Relative Error of Age 1+ Biomass (%)") + 
    ylim(-100, 100)

# error of catch
simCat <- smryOutputList$obsCatch %>% mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                                            model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                                            iteration = str_extract(resDir, "/\\d/")) %>%
              mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                     iteration = as.numeric(str_extract(iteration, "\\d")),
                     plotGroup = "simCatch") %>%
              group_by(year, model_run, iteration, scenario, plotGroup) %>%
                # summarize total catch within year
                dplyr::summarize(totCatch = sum(catch)) %>%
              filter(!grepl("_OM", model_run, fixed = TRUE), year != -999) %>%
                  select(year, totCatch, model_run, iteration, scenario, plotGroup)

catchTS <- smryOutputList$tsSmry %>% 
                  mutate(totCatch = retainB_1 + retainB_2 + retainB_3) %>%
                  group_by(year, model_run, iteration, scenario) %>%
                # summarize total catch within year
                dplyr::summarize(totCatch = sum(totCatch)) %>%
                  select(year, totCatch, model_run, iteration, scenario) %>%
                  mutate(plotGroup = case_when(grepl("_OM", model_run, fixed = TRUE) ~ "OM",
                                               TRUE ~ "EM"))

catchRE <- catchTS %>% filter(plotGroup != "OM")
catchRE <- rbind(catchRE, simCat)
catchRE <- catchRE %>% pivot_wider(names_from = "plotGroup", values_from = "totCatch") %>%
                  left_join(y = convrgCheck, 
                            by = c("model_run", "iteration", "scenario")) %>%
                  full_join(y = subset(catchTS, subset = plotGroup == "OM"), 
                            by = c("iteration", "scenario", "year")) %>%
                  mutate(convrg = case_when(max_grad > 0.01 ~ "non-convrg",
                                            max_grad < 0.01 ~ "convrg",
                                            TRUE ~ "OM"),
                         datRE = (simCatch - totCatch)/(totCatch + 0.0001) * 100, # add small amount so not div by 0
                         emRE = (EM - totCatch)/(totCatch + 0.0001) * 100)

catchTS <- rbind(catchTS, simCat)
catchTS <- catchTS %>% left_join(y = convrgCheck, 
                                         by = c("model_run", "iteration", "scenario")) %>%
                  mutate(convrg = case_when(max_grad > 0.01 ~ "non-convrg",
                                            max_grad < 0.01 ~ "convrg",
                                            TRUE ~ "OM"))

for(mr in 1:3){
  print(catchTS %>% filter(scenario == scenarios[mr]) %>%
    ggplot(aes(x = year, y = log(totCatch))) +
    ggplot2::geom_vline(xintercept = 2019, color = "gray") +
    ggplot2::geom_line(ggplot2::aes(linetype = as.character(model_run), color = plotGroup))+
    ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
    ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(iteration), cols = vars(convrg)) +
    ggplot2::theme_classic() +
  labs(title = scenarios[mr]))
}

# Plot relative errors of biomass over time
catchRE %>% filter(HCR != "HCR0") %>%
    ggplot(aes(x = year, y = emRE)) +
    geom_vline(xintercept = 2019, color = "gray") +
    geom_line(aes(linetype = as.character(model_run.x), color = convrg))+
    geom_point(aes(y = datRE), shape = 4, color = "grey") +
    scale_color_manual(values = c("black", "blue", "#D65F00")) +
    scale_linetype_manual(values = rep("solid", 51)) +
    guides(linetype = "none") +
    facet_grid(rows = vars(iteration), cols = vars(scenario)) +
    theme_classic() + labs(title = "Relative Error of Catch (%)")
```
Model expects high catches for 2020 in initial EM fit (emYear 2019)

Check harvest guideline from EMs
```{r}
# Use parallelization to pull in composition and EM data ------------------
  # Adapted from code from Peter Kuriyama
  
  # set up the directories
  # get the iterations
  resultsDirs <- NULL
  for(scn in 1:length(scenarios)){
    iters <- list.dirs(file.path(mseDir, scenarios[scn]), recursive = FALSE, full.names = FALSE)
  
    # get the model directory names
    runNames <- list.dirs(file.path(mseDir, scenarios[scn], iters[1]),
                           recursive = FALSE,
                           full.names = FALSE)
    # remove OM folder from list
    runNames <- runNames[-grep("_OM", runNames, fixed = TRUE)]
    
    #The results directories to read in
    scnResultsDirs <- expand_grid(scenarios[scn], iters, runNames) %>% 
                    mutate(scen = file.path(mseDir, `scenarios[scn]`, iters, runNames)) %>%
                    pull(scen)
    
    resultsDirs <- c(resultsDirs, scnResultsDirs)
  }
  
  
  # extract wanted tables per directory and add data origin
  start_time <- Sys.time()
  ncores <- detectCores() - 2 #Leave some cores open for background stuff
  cl <- makeCluster(ncores)
  registerDoParallel(cl)
  
  resultsList <- foreach::foreach(ii = 1:length(resultsDirs),
                                  
                                  .packages = c("tidyverse", 'r4ss')) %dopar% {
                                    outList <- SS_output(resultsDirs[ii], 
                                              covar = FALSE, printstats = FALSE,
                                              verbose = FALSE)
                                    outList %>% magrittr::extract("sprseries") %>%
                                      map2(.y = resultsDirs[ii], 
                                           .f = function(x, y){x['resDir'] <- y;x})
                                  }
  stopCluster(cl)
  run_time <- Sys.time() - start_time; run_time #To see how long it takes
  
  # summarize into single table for export
  smryForeBio <- resultsList %>% map_dfr(magrittr::extract2, "sprseries") %>%
                    filter(Era=="FORE") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d"))) %>%
                    select(Yr, Bio_Smry.1, scenario, model_run, iteration)
  
# apply HCR as calculated in HCR_sar_hcr2.R
  
#upload the CalCOFI temperature timeseries
 Ctemp=read.csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/dat/calcofi_sst_projected.csv")
 # Ctemp=read.csv("J:/Desiree/Sardine/SardineMSE/dat/calcofi_sst_projected.csv")
  
 #extract the average for the three years prior to the forecast
 #Tyr=c((EMts$Yr[1]-1),(EMts$Yr[1]-2),(EMts$Yr[1]-3))
 #Temsy = mean(Ctemp$gfdl_sst_all[Ctemp$year %in% Tyr])#here we might need to create a separte hcr 2 function for each projection or have the GCM as an input to the function
 smryForeBio$Temsy <- NA
 for(i in 1:nrow(smryForeBio)){
   smryForeBio[i, "Temsy"] <- mean(Ctemp$gfdl_sst_all[Ctemp$year %in% (smryForeBio[i, "Yr"]-3):(smryForeBio[i, "Yr"]-1)])
 }
 
 #set input to hcr
  #Emsy = -18.46452+3.25209*Temsy-0.19723*Temsy^2+0.0041863*Temsy^3
smryForeBio <- smryForeBio %>% mutate(Emsy = -18.46452+3.25209*Temsy-0.19723*Temsy^2+0.0041863*Temsy^3)
  cutoff = 150000
  distribution = 0.87
  
  #if biomass is less than the cutoff, the harvest guideline is set to 0, if not the current hg rule is ised
  #HG=(BIOMASS-CUTOFF)xFRACTIONxDISTRIBUTION
  #Note that as there are still
  # if (bio1 < cutoff) {HG = 0 } else {HG = (bio1-cutoff)*Emsy*distribution}
  # 
  # #the hg is capped at a maximum catch of 200000 mt
  # if (HG > 200000) {HG = 200000}

smryForeBio <- smryForeBio %>% mutate(HG = case_when(Bio_Smry.1 < cutoff ~ 0,
                                                     TRUE ~ (Bio_Smry.1-cutoff)*Emsy*distribution)) %>%
                  mutate(HG = case_when(HG > 200000 ~ 200000,
                                        TRUE ~ HG)) %>%
                  left_join(y = subset(catchTS, subset = plotGroup == "OM"), 
                            by = c("Yr" = "year", "scenario", "iteration")) %>%
                  left_join(y = subset(age1PlusBio, subset = plotGroup == "OM"), 
                            by = c("Yr" = "year", "scenario", "iteration")) %>%
                  select(Yr, scenario, model_run.x, iteration, Bio_Smry.1, HG, Bio_smry, totCatch, HCR.y, recScen.y)

smryForeBio %>% ggplot(aes(x = Yr, y = (totCatch - HG))) +
  geom_vline(xintercept = 2019, color = "gray") +
  geom_line(aes(linetype = as.character(scenario)))+
  geom_point(aes(y = (Bio_Smry.1 - Bio_smry)/Bio_smry*100), shape = 4, color = "grey") +
    scale_linetype_manual(values = rep("solid", 51)) +
    guides(linetype = "none") +
    facet_grid(rows = vars(iteration), cols = vars(scenario)) +
    theme_classic() + labs(title = "Difference from HG and Catch w/ Biomass RE (%)")

# compare OM, EM, and HG total catches

# look at catches listed in OM data files
# set up the directories
  # get the iterations
  omDirs <- NULL
  for(scn in 1:length(scenarios)){
    iters <- list.dirs(file.path(mseDir, scenarios[scn]), recursive = FALSE, full.names = FALSE)
  
    # get the model directory names
    runNames <- list.dirs(file.path(mseDir, scenarios[scn], iters[1]),
                           recursive = FALSE,
                           full.names = FALSE)
    # keep only OM folder from list
    runNames <- runNames[grep("_OM", runNames, fixed = TRUE)]
    
    #The results directories to read in
    scnResultsDirs <- expand_grid(scenarios[scn], iters, runNames) %>% 
                    mutate(scen = file.path(mseDir, `scenarios[scn]`, iters, runNames)) %>%
                    pull(scen)
    
    omDirs <- c(omDirs, scnResultsDirs)
  }
  
  
  # extract wanted tables per directory and add data origin
  start_time <- Sys.time()
  ncores <- detectCores() - 2 #Leave some cores open for background stuff
  cl <- makeCluster(ncores)
  registerDoParallel(cl)
  
 omDataList <- foreach::foreach(ii = 1:length(omDirs),
                                  
                                  .packages = c("tidyverse", 'r4ss')) %dopar% {
                                    outList <- SS_readdat(file.path(omDirs[ii], "data.ss"),
                                                          version = "3.30", verbose = FALSE)
                                    outList %>% magrittr::extract("catch") %>%
                                      map2(.y = omDirs[ii], 
                                           .f = function(x, y){x['resDir'] <- y;x})
                                  }
  stopCluster(cl)
  
  # summarize into single table for export
  omDataCatch <- omDataList %>% map_dfr(magrittr::extract2, "catch") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d"))) %>%
                    rename(catchDat = catch)
  
    cl <- makeCluster(ncores)
  registerDoParallel(cl)
 omDataExpList <- foreach::foreach(ii = 1:length(omDirs),
                                  
                                  .packages = c("tidyverse", 'r4ss')) %dopar% {
                                    outList <- SS_readdat(file.path(omDirs[ii], "data.ss_new"),
                                                          version = "3.30", verbose = FALSE,
                                                          section = 2)
                                    outList %>% magrittr::extract("catch") %>%
                                      map2(.y = omDirs[ii], 
                                           .f = function(x, y){x['resDir'] <- y;x})
                                  }
  stopCluster(cl)
  
  # summarize into single table for export
  omDataExpCatch <- omDataExpList %>% map_dfr(magrittr::extract2, "catch") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d")))%>%
                    rename(catchExp = catch)
  
    cl <- makeCluster(ncores)
registerDoParallel(cl)
 omDataBootList <- foreach::foreach(ii = 1:length(omDirs),
                                  
                                  .packages = c("tidyverse", 'r4ss')) %dopar% {
                                    outList <- SS_readdat(file.path(omDirs[ii], "data.ss_new"),
                                                          version = "3.30", verbose = FALSE,
                                                          section = 3)
                                    outList %>% magrittr::extract("catch") %>%
                                      map2(.y = omDirs[ii], 
                                           .f = function(x, y){x['resDir'] <- y;x})
                                  }
  stopCluster(cl)
  # summarize into single table for export
  omDataBootCatch <- omDataBootList %>% map_dfr(magrittr::extract2, "catch") %>%
                    mutate(scenario = sub(pattern = ".*Scenarios/","", resDir),
                           model_run = sub(pattern = ".*/[[:digit:]]+/","", resDir),
                           iteration = str_extract(resDir, "/\\d/")) %>%
                    mutate(scenario = sub(pattern = "/[[:digit:]]+/.*","", scenario),
                           iteration = as.numeric(str_extract(iteration, "\\d")))%>%
                    rename(catchBoot = catch)
    run_time <- Sys.time() - start_time; run_time #To see how long it takes

omDataCatch <- omDataCatch %>% left_join(y = omDataExpCatch, 
                                         by = c("year", "seas", "fleet", "resDir", 
                                                "scenario", "model_run", "iteration")) %>%
                  left_join(y = omDataBootCatch, 
                            by = c("year", "seas", "fleet", "resDir", 
                                   "scenario", "model_run", "iteration")) %>%
                  group_by(year, resDir, scenario, model_run, iteration) %>%
                  summarize(totCatchDat = sum(catchDat),
                            totCatchExp = sum(catchExp),
                            totCatchBoot = sum(catchBoot)) %>%
                  filter(year != -999)

catchTS <- omDataCatch %>% left_join(y = subset(catchTS, subset = plotGroup == "EM"), 
                          by = c("year", "iteration", "scenario")) %>% 
              rename(totCatchEstEM = totCatch) %>%
              left_join(y = subset(catchTS, subset = plotGroup == "simCatch"), 
                        by = c("year", "iteration", "scenario", "emYear", "recScen", 
                               "HCR", "model_run.y" = "model_run")) %>% 
              rename(totCatchSimDatEM = totCatch) %>% ungroup() %>%
              select(year, iteration, scenario, emYear, recScen, HCR, max_grad.x, convrg.x,
                     totCatchDat, totCatchExp, totCatchBoot, totCatchSimDatEM, totCatchEstEM)

# Note: the HG is the catch advice provided from the HCR from the previous emYear 
#       to be applied in 'year'
catchTS <- catchTS %>% left_join(smryForeBio, 
                                 by = c("year" = "Yr", "iteration", "scenario",
                                        "recScen" = "recScen.y", "HCR" = "HCR.y")) %>%
              rename(emForeBioSmry = Bio_Smry.1,
                     omBioSmry = Bio_smry) %>%
              select(year, iteration, scenario, emYear, recScen, HCR, max_grad.x, 
                     convrg.x, HG, totCatchDat, totCatchExp, totCatchBoot, 
                     totCatchSimDatEM, totCatchEstEM, totCatch, emForeBioSmry, omBioSmry)
catchTS %>% filter(year == 2030)

omOut <- SS_output("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_selfTestMidSteep_RandRecHCR2/1/constGrowthSteepness0dot6_OM_OM")
em2029Out <- SS_output("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_selfTestMidSteep_RandRecHCR2/1/constGrowSelfTest_EM_2029")
compFree <- SSsummarize(list(OM = omOut, EM2029 = em2029Out))

#SS_plots(em2029Out)
```
EM tries to throw in really high rec_dev at end of time series, maybe to support high forecast catches?

# EM 2001 self test, recruitment at SD=0.5, h=0.6, high sample size

```{r}
mseDir <- "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios"

scenarios <- c("constGrow2001OM_selfTestSteep0dot6_RandRecHCR0",
              "constGrow2001OM_selfTestSteep0dot6_RandRecHCR2",
              "constGrow2001OM_selfTestSteep0dot6FixRec_RandRecHCR2")

test1 <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_selfTestSteep0dot6FixRec_RandRecHCR2/results_scalar_constGrow2001OM_selfTestSteep0dot6FixRec_RandRecHCR2.csv")
#View(test1)
test1 %>% select(model_run, SR_LN_R0, SR_regime_BLK1repl_2000, iteration, scenario)

smryOutputList <- GetSumryOutput(dirSSMSE = mseDir,
                                 scenarios = scenarios)


smryOutputList$dqSmry$model_run <- sub("Steepness0dot6", "MidSteep", 
                                       smryOutputList$dqSmry$model_run, fixed = TRUE)
smryOutputList$sclSmry$model_run <- sub("Steepness0dot6", "MidSteep", 
                                       smryOutputList$sclSmry$model_run, fixed = TRUE)
smryOutputList$tsSmry$model_run <- sub("Steepness0dot6", "MidSteep", 
                                       smryOutputList$tsSmry$model_run, fixed = TRUE)

performanceList <- CalcPerformance(smryOutputList)

metricsTbl <- performanceList$perfomanceMetrics

# parse out HCR and recruitment scenario
metricsTbl <- metricsTbl %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                    recScen = sub(pattern = "HCR.*","", scenario)) %>%
                mutate(recScen = sub(pattern = ".*OM_","", recScen))

hcrPal <- brewer.pal(10, "Set3")[-2]

# plot convergence frequency
metricsTbl %>% filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = frqNonConvg)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_brewer(palette = hcrPal)

# get terminal estimates of these values for timeseries plots
termTS <- CalcTermTS(smryOutputList) %>% 
              mutate(HCR = sub(pattern = ".*Rec","", scenario),
                               recScen = sub(pattern = "HCR.*","", scenario)) %>%
              mutate(recScen = sub(pattern = ".*OM_","", recScen))

omName <- grep("_OM", smryOutputList$tsSmry$model_run, 
                 fixed = TRUE, value = TRUE)[1]

convrgCheck <- smryOutputList$sclSmry %>% #filter(!model_run %in% omName) %>%
                  select(max_grad, model_run, iteration, scenario) %>%
                  mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
                  mutate(recScen = sub(pattern = ".*OM_","", recScen))  

hcrs <- unique(termTS$HCR)
#exIters <- sample(termTS$iteration, size = 4)

cnvrgTS <- smryOutputList$tsSmry %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                   recScen = sub(pattern = "HCR.*","", scenario)) %>%
      mutate(recScen = sub(pattern = ".*OM_","", recScen)) %>%
      left_join(y = convrgCheck, by = c("iteration", "model_run", "scenario", "HCR", "recScen")) %>%
      mutate(plotGroup = case_when(model_run == omName ~ "OM",
                                   max_grad > 0.01 ~ "non-convrg",
                                   max_grad < 0.01 ~ "convrg"))

for(mr in 2:3){
  print(cnvrgTS %>% filter(scenario == scenarios[mr], Seas == 1) %>%
      ggplot(aes(x = year, y = log(Bio_smry))) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = log(50000), color = "red") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = scenarios[mr]))
}

for(hcr in 2:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = rec_dev)) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = 0, color = "gray") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

#termTS %>% filter(model_run == omName)

errCompare <- cnvrgTS %>% filter(Seas == 1, model_run != omName) %>%
                select(Bio_smry, year, model_run, iteration, scenario, HCR, recScen, emYear, plotGroup) %>%
                inner_join(y = subset(termTS, model_run == omName), 
                           by = c("year", "iteration", "scenario", "HCR", "recScen")) %>%
                #filter(iteration == 1) %>%
                  rename(age1plusOM = Bio_smry.y,
                         age1plusEM = Bio_smry.x) %>% 
                  mutate(errSmryBio = (age1plusEM - age1plusOM)/age1plusOM) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(errSmryBio)) %>%
                group_by(iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(runMSE))  #%>%
                # group_by(scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))

errCompare %>% #filter(HCR != "HCR3") %>%
  ggplot(aes(x = HCR, y = runMSE, fill = plotGroup)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~recScen) 

# PlotEMAnnualEsts(dirSSMSE = mseDir, scenarios = scenarios, 
#                  varCol = c("SSB_Unfished", "NatM_uniform_Fem_GP_1",	
#                             "L_at_Amin_Fem_GP_1", "SR_LN_R0", 
#                             "SR_regime_BLK1repl_2000", "InitF_seas_2_flt_2MexCal_S2", 
#                             "CV_old_Fem_GP_1"))

convrgCheck %>%
  ggplot(aes(x = emYear, y = max_grad)) +
  geom_line(aes(linetype = scenario))+
  scale_linetype_manual(values = rep("solid", 51)) +
  guides(linetype = "none") +
  facet_grid(rows = vars(recScen), cols = vars(iteration), scales = "free") +
  theme_classic() + theme(legend.position="none")

omOut <- SS_output("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_selfTestSteep0dot6FixRec_RandRecHCR2/1/constGrowthSteepness0dot6_OM_OM")
fixedOut <- SS_output("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_selfTestSteep0dot6FixRec_RandRecHCR2/1/constGrowFixRec_EM_2032")
compFixed <- SSsummarize(list(OM = omOut, EM2032 = fixedOut))
compFixed$pars$relErr <- round((compFixed$pars$EM2032 - compFixed$pars$OM)/compFixed$pars$OM, digits = 3)
SSplotComparisons(compFixed)
compFixed$pars
omDat <- SS_readdat("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_selfTestSteep0dot6FixRec_RandRecHCR2/1/constGrowthSteepness0dot6_OM_OM/data.ss_new", section = 2)
emDat <- SS_readdat("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrow2001OM_selfTestSteep0dot6FixRec_RandRecHCR2/1/constGrowFixRec_EM_2032/data.ss_new")
omDat$CPUE$index <- abs(omDat$CPUE$index)
compDat <- omDat$CPUE %>% left_join(y = emDat$CPUE, by = c("year", "seas", "index")) %>%
  filter(index == 4) %>% pivot_longer(cols = c(obs.x, obs.y), names_to = "model", values_to = "CPUE")
compDat %>% ggplot(aes(x = year, y = CPUE)) + geom_line(aes(group = model))


```


# EM 2001 self test, recruitment at SD=1.25, perfect information

```{r}
mseDir <- "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios"

scenarios <- c("constGrow2001OM_selfTestSD1.25_RandRecHCR0",
               "constGrow2001OM_selfTestSD1.25_RandRecHCR2",
               "constGrow2001OM_selfTestSD1.25_RandRecHCR3",
               "constGrow2001OM_selfTestSD1.25_RandRecHCR5",
               "constGrow2001OM_selfTestSD1.25_RandRecHCR6")

smryOutputList <- GetSumryOutput(dirSSMSE = mseDir,
                                 scenarios = scenarios)

performanceList <- CalcPerformance(smryOutputList)

metricsTbl <- performanceList$perfomanceMetrics

# parse out HCR and recruitment scenario
metricsTbl <- metricsTbl %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                    recScen = sub(pattern = "HCR.*","", scenario)) %>%
                mutate(recScen = sub(pattern = ".*selfTest_","", recScen))

hcrPal <- brewer.pal(10, "Set3")[-2]

# plot convergence frequency
metricsTbl %>% filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = frqNonConvg)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_brewer(palette = hcrPal)

# get terminal estimates of these values for timeseries plots
termTS <- CalcTermTS(smryOutputList) %>% 
              mutate(HCR = sub(pattern = ".*Rec","", scenario),
                               recScen = sub(pattern = "HCR.*","", scenario)) %>%
              mutate(recScen = sub(pattern = ".*selfTest_","", recScen))

omName <- grep("_OM", smryOutputList$tsSmry$model_run, 
                 fixed = TRUE, value = TRUE)[1]

convrgCheck <- smryOutputList$sclSmry %>% 
                  select(max_grad, model_run, iteration, scenario) %>%
                  mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
                  mutate(recScen = sub(pattern = ".*selfTest_","", recScen))  

hcrs <- unique(termTS$HCR)
#exIters <- sample(termTS$iteration, size = 4)

cnvrgTS <- smryOutputList$tsSmry %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                   recScen = sub(pattern = "HCR.*","", scenario)) %>%
      mutate(recScen = sub(pattern = ".*selfTest_","", recScen)) %>%
      left_join(y = convrgCheck, by = c("iteration", "model_run", "scenario", "HCR", "recScen")) %>%
      mutate(plotGroup = case_when(model_run == omName ~ "OM",
                                   max_grad > 0.01 ~ "non-convrg",
                                   max_grad < 0.01 ~ "convrg"))

for(hcr in 2:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = log(Bio_smry))) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = log(50000), color = "red") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

for(hcr in 2:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = rec_dev)) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = 0, color = "gray") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

#termTS %>% filter(model_run == omName)

errCompare <- cnvrgTS %>% filter(Seas == 1, model_run != omName) %>%
                select(Bio_smry, year, model_run, iteration, scenario, HCR, recScen, emYear, plotGroup) %>%
                inner_join(y = subset(termTS, model_run == omName), 
                           by = c("year", "iteration", "scenario", "HCR", "recScen")) %>%
                #filter(iteration == 1) %>%
                  rename(age1plusOM = Bio_smry.y,
                         age1plusEM = Bio_smry.x) %>% 
                  mutate(errSmryBio = (age1plusEM - age1plusOM)/age1plusOM) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(errSmryBio)) %>%
                group_by(iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(runMSE))  #%>%
                # group_by(scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))

errCompare %>% #filter(HCR != "HCR3") %>%
  ggplot(aes(x = HCR, y = runMSE, fill = plotGroup)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~recScen) 
```
Look at parameter estimate time series
```{r}
# Look at timeseries of B0 and account for non-convergence
B0s <- smryOutputList$sclSmry %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*selfTest","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg")) 
meanB0s <- B0s %>% filter(max_grad < 0.01) %>%
              group_by(HCR, recScen, plotGroup) %>%
              summarize(meanB0est = mean(SSB_Unfished)) %>%
              mutate(pikitch0.4B0 = 0.4*meanB0est)
  
B0s %>% filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = log(SSB_Unfished))) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "B0 (Unfished SSB)") +
  geom_hline(data = meanB0s, mapping = aes(yintercept = log(meanB0est)), color = "grey") +
  geom_hline(data = meanB0s, mapping = aes(yintercept = log(pikitch0.4B0)),  color = "red")

# Want to look at the other parameters
sclSmryAll <- NULL
  
  for(scn in 1:length(scenarios)){
    # read in SSMSE results summary scalars
    sclSumry <- read.csv(file.path(mseDir, scenarios[scn], 
                                   paste0("results_scalar_", scenarios[scn], ".csv")))
    # if(!"F_MSY" %in% names(sclSumry)){ # no catch scenarios don't have F_MSY
    #   sclSumry$F_MSY <- NA
    #   sclSumry$SSB_Unfished <- NA
    # }
    # sclSumry <- sclSumry[, c("F_MSY", "SmryBio_Unfished", "SSB_Unfished",
    #                          "max_grad", "model_run", "iteration", "scenario")]
      
    sclSmryAll <- bind_rows(sclSmryAll, sclSumry)
  } # end 'scn' for-loop

sclSmryAll %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*selfTest","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg"))  %>%
  filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = SR_LN_R0)) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "Ln(R0)")

sclSmryAll %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*selfTest","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg"))  %>%
  filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = SR_regime_BLK1repl_2000)) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "SR regime")

sclSmryAll %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*selfTest","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg"))  %>%
  filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = InitF_seas_2_flt_2MexCal_S2)) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "Seas 2 MexCal2 Initial F")

sclSmryAll %>% select(max_grad, params_on_bound, params_stuck_low, params_stuck_high,
                      iteration, model_run, scenario) %>%
  filter(model_run != omName)
```

# EM 2001 self test, recruitment at SD=1.25, perfect information & fixed params

```{r}
mseDir <- "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios"

scenarios <- c("fixedParams2001OM_selfTestSD1.25_RandRecHCR0",
               "fixedParams2001OM_selfTestSD1.25_RandRecHCR2",
               "fixedParams2001OM_selfTestSD1.25_RandRecHCR3",
               "fixedParams2001OM_selfTestSD1.25_RandRecHCR5",
               "fixedParams2001OM_selfTestSD1.25_RandRecHCR6")

smryOutputList <- GetSumryOutput(dirSSMSE = mseDir,
                                 scenarios = scenarios)

performanceList <- CalcPerformance(smryOutputList)

metricsTbl <- performanceList$perfomanceMetrics

# parse out HCR and recruitment scenario
metricsTbl <- metricsTbl %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                    recScen = sub(pattern = "HCR.*","", scenario)) %>%
                mutate(recScen = sub(pattern = ".*selfTest_","", recScen))

hcrPal <- brewer.pal(10, "Set3")[-2]

# plot convergence frequency
metricsTbl %>% filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = frqNonConvg)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_brewer(palette = hcrPal)

# get terminal estimates of these values for timeseries plots
termTS <- CalcTermTS(smryOutputList) %>% 
              mutate(HCR = sub(pattern = ".*Rec","", scenario),
                               recScen = sub(pattern = "HCR.*","", scenario)) %>%
              mutate(recScen = sub(pattern = ".*selfTest_","", recScen))

omName <- grep("_OM", smryOutputList$tsSmry$model_run, 
                 fixed = TRUE, value = TRUE)[1]

convrgCheck <- smryOutputList$sclSmry %>% 
                  select(max_grad, model_run, iteration, scenario) %>%
                  mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
                  mutate(recScen = sub(pattern = ".*selfTest_","", recScen))  

hcrs <- unique(termTS$HCR)
#exIters <- sample(termTS$iteration, size = 4)

cnvrgTS <- smryOutputList$tsSmry %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                   recScen = sub(pattern = "HCR.*","", scenario)) %>%
      mutate(recScen = sub(pattern = ".*selfTest_","", recScen)) %>%
      left_join(y = convrgCheck, by = c("iteration", "model_run", "scenario", "HCR", "recScen")) %>%
      mutate(plotGroup = case_when(model_run == omName ~ "OM",
                                   max_grad > 0.01 ~ "non-convrg",
                                   max_grad < 0.01 ~ "convrg"))

for(hcr in 2:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = log(Bio_smry))) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = log(50000), color = "red") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

for(hcr in 2:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = rec_dev)) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = 0, color = "gray") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(iteration), cols = vars(plotGroup)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

#termTS %>% filter(model_run == omName)

errCompare <- cnvrgTS %>% filter(Seas == 1, model_run != omName) %>%
                select(Bio_smry, year, model_run, iteration, scenario, HCR, recScen, emYear, plotGroup) %>%
                inner_join(y = subset(termTS, model_run == omName), 
                           by = c("year", "iteration", "scenario", "HCR", "recScen")) %>%
                #filter(iteration == 1) %>%
                  rename(age1plusOM = Bio_smry.y,
                         age1plusEM = Bio_smry.x) %>% 
                  mutate(errSmryBio = (age1plusEM - age1plusOM)/age1plusOM) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(errSmryBio)) %>%
                group_by(iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(runMSE))  #%>%
                # group_by(scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))

errCompare %>% #filter(HCR != "HCR3") %>%
  ggplot(aes(x = HCR, y = runMSE, fill = plotGroup)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~recScen) 
```
Look at parameter estimate time series
```{r}
# Look at timeseries of B0 and account for non-convergence
B0s <- smryOutputList$sclSmry %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*selfTest","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg")) 
meanB0s <- B0s %>% filter(max_grad < 0.01) %>%
              group_by(HCR, recScen, plotGroup) %>%
              summarize(meanB0est = mean(SSB_Unfished)) %>%
              mutate(pikitch0.4B0 = 0.4*meanB0est)
  
B0s %>% filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = log(SSB_Unfished))) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "B0 (Unfished SSB)") +
  geom_hline(data = meanB0s, mapping = aes(yintercept = log(meanB0est)), color = "grey") +
  geom_hline(data = meanB0s, mapping = aes(yintercept = log(pikitch0.4B0)),  color = "red")

# Want to look at the other parameters
sclSmryAll <- NULL
  
  for(scn in 1:length(scenarios)){
    # read in SSMSE results summary scalars
    sclSumry <- read.csv(file.path(mseDir, scenarios[scn], 
                                   paste0("results_scalar_", scenarios[scn], ".csv")))
    # if(!"F_MSY" %in% names(sclSumry)){ # no catch scenarios don't have F_MSY
    #   sclSumry$F_MSY <- NA
    #   sclSumry$SSB_Unfished <- NA
    # }
    # sclSumry <- sclSumry[, c("F_MSY", "SmryBio_Unfished", "SSB_Unfished",
    #                          "max_grad", "model_run", "iteration", "scenario")]
      
    sclSmryAll <- bind_rows(sclSmryAll, sclSumry)
  } # end 'scn' for-loop

sclSmryAll %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*selfTest","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg"))  %>%
  filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = SR_LN_R0)) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "Ln(R0)")

sclSmryAll %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*selfTest","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg"))  %>%
  filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = SR_regime_BLK1repl_2000)) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "SR regime")

sclSmryAll %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
            mutate(recScen = sub(pattern = ".*selfTest","", recScen),
                   emYear = case_when(is.na(emYear) ~ 2019,
                                      TRUE ~ emYear),
                   plotGroup = case_when(model_run == omName ~ "OM",
                                             max_grad > 0.01 ~ "non-convrg",
                                             max_grad < 0.01 ~ "convrg"))  %>%
  filter(model_run != omName, HCR != "HCR0") %>%
  ggplot(aes(x = emYear, y = InitF_seas_2_flt_2MexCal_S2)) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = iteration))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(plotGroup), scales = "free") +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "Seas 2 MexCal2 Initial F")

sclSmryAll %>% select(max_grad, params_on_bound, params_stuck_low, params_stuck_high,
                      iteration, model_run, scenario) %>%
  filter(model_run != omName)
```

# EM 2001 self test, recruitment at SD=1.25, perfect information, turning on params

```{r}
mseDir <- "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios"

scenarios <- c("fixedParams2001OM_selfTest_RandRecHCR2",
              "fixedParams2001OM_selfTestRegime_RandRecHCR2",
              "fixedParams2001OM_selfTestR0_RandRecHCR2",
              "fixedParams2001OM_selfTestInitF_RandRecHCR2",
              "fixedParams2001OM_selfTestGrowth_RandRecHCR2")

# have to restructure output list to deal with multiple OMs
smryOutputList <- list()
for(i in 1:length(scenarios)){
  smryOutputList[[i]] <- GetSumryOutput(dirSSMSE = mseDir, scenarios = scenarios[i])
}
  
lenComp <- smryOutputList %>% map_dfr(magrittr::extract2, "lenComp")
ageComp <- smryOutputList %>% map_dfr(magrittr::extract2, "ageComp")
obsCPUE <- smryOutputList %>% map_dfr(magrittr::extract2, "obsCPUE")
obsCatch <- smryOutputList %>% map_dfr(magrittr::extract2, "obsCatch")
dqSmry <- smryOutputList %>% map_dfr(magrittr::extract2, "dqSmry")
sclSmry <- smryOutputList %>% map_dfr(magrittr::extract2, "sclSmry")
tsSmry <- smryOutputList %>% map_dfr(magrittr::extract2, "tsSmry")

smryOutputList <- list("lenComp" = lenComp, "ageComp" = ageComp, 
         "obsCPUE" = obsCPUE, "obsCatch" = obsCatch, 
         "dqSmry" = dqSmry, "sclSmry" = sclSmry, "tsSmry" = tsSmry)
# 
# performanceList <- CalcPerformance(smryOutputList) # also going to have OM issues 
# 
# metricsTbl <- performanceList$perfomanceMetrics
# 
# # parse out HCR and recruitment scenario
# metricsTbl <- metricsTbl %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
#                                     recScen = sub(pattern = "HCR.*","", scenario)) %>%
#                 mutate(recScen = sub(pattern = ".*OM_","", recScen))
# 
# hcrPal <- brewer.pal(10, "Set3")[-2]
# 
# # plot convergence frequency
# metricsTbl %>% filter(HCR != "HCR0") %>%
#   ggplot(aes(x = HCR, y = frqNonConvg)) +
#   geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
#   facet_wrap(~recScen) + 
#   theme_minimal() +
#   scale_fill_brewer(palette = hcrPal)

# get terminal estimates of these values for timeseries plots
termTS <- CalcTermTS(smryOutputList) %>% 
              mutate(HCR = sub(pattern = ".*Rec","", scenario),
                               recScen = sub(pattern = "HCR.*","", scenario)) %>%
              mutate(recScen = sub(pattern = ".*OM_","", recScen))

omName <- unique(grep("_OM", smryOutputList$tsSmry$model_run, 
                 fixed = TRUE, value = TRUE))

convrgCheck <- smryOutputList$sclSmry %>% 
                  select(max_grad, model_run, iteration, scenario) %>%
                  mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
                  mutate(recScen = sub(pattern = ".*OM_","", recScen))  

hcrs <- unique(termTS$HCR)
#exIters <- sample(termTS$iteration, size = 4)

cnvrgTS <- smryOutputList$tsSmry %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                   recScen = sub(pattern = "HCR.*","", scenario)) %>%
      mutate(recScen = sub(pattern = ".*OM_","", recScen)) %>%
      left_join(y = convrgCheck, by = c("iteration", "model_run", "scenario", "HCR", "recScen")) %>%
      mutate(plotGroup = case_when(model_run %in% omName ~ "OM",
                                   max_grad > 0.01 ~ "non-convrg",
                                   max_grad < 0.01 ~ "convrg"))

for(hcr in 1:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = log(Bio_smry))) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = log(50000), color = "red") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(scenario), cols = vars(iteration)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

for(hcr in 1:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], Seas == 1) %>%
      ggplot(aes(x = year, y = rec_dev)) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = 0, color = "gray") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      facet_grid(rows = vars(scenario), cols = vars(iteration)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

#termTS %>% filter(model_run == omName)

errCompare <- cnvrgTS %>% filter(Seas == 1, !model_run %in% omName) %>%
                select(Bio_smry, year, model_run, iteration, scenario, HCR, recScen, emYear, plotGroup) %>%
                inner_join(y = subset(termTS, model_run %in% omName), 
                           by = c("year", "iteration", "scenario", "HCR", "recScen")) %>%
                #filter(iteration == 1) %>%
                  rename(age1plusOM = Bio_smry.y,
                         age1plusEM = Bio_smry.x) %>% 
                  mutate(errSmryBio = (age1plusEM - age1plusOM)/age1plusOM) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(errSmryBio)) %>%
                group_by(iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(runMSE = mean(runMSE))  #%>%
                # group_by(scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))

errCompare %>% #filter(HCR != "HCR3") %>%
  ggplot(aes(x = HCR, y = runMSE, fill = plotGroup)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~recScen, scales = "free") 
```

# EM 2001 self test, random recruitment

Look at years of no convergence and parameter bounds
```{r}
selfTest <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001fixedParms_RandRec_HCR1/results_scalar_testConvrgEM2001fixedParms_RandRec_HCR1.csv")

convrgCheckSelfTest <- selfTest %>% select(max_grad, params_on_bound, 
                                               params_stuck_low, params_stuck_high,
                                               model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)

convrgCheckSelfTest 
```

Plot diagnostics from self test of the 2001 model (random recruitment, HCR1)
```{r}

selfBio <- bDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
          scenario = "testConvrgEM2001fixedParms_RandRec_HCR1",
          termYr = 2058, surveyInx = 4)
selfBio[[1]] + geom_rug(data = convrgCheckSelfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
selfBio[[2]] + geom_rug(data = convrgCheckSelfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

compDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2001fixedParms_RandRec_HCR1",
              termYr = 2058, surveyInx = 4)

selfRec <- recrDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2001fixedParms_RandRec_HCR1", termYr = 2058)
selfRec[[1]] + geom_rug(data = convrgCheckSelfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
selfRec[[2]] + geom_rug(data = convrgCheckSelfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

selfCat <- catchDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
                          scenario = "testConvrgEM2001fixedParms_RandRec_HCR1", termYr = 2058)
selfCat[[1]] + geom_rug(data = convrgCheckSelfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

selfAge1Plus <- age1plusDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2001fixedParms_RandRec_HCR1", termYr = 2058)
selfAge1Plus[[1]] + geom_rug(data = convrgCheckSelfTest, mapping = aes(x = year),
                             sides = "b", inherit.aes = FALSE)
```

Look at recruitment and fishing mortality parameter estimates
```{r}
paramCheckSelfTest <- selfTest %>% select(max_grad, SR_LN_R0, SR_regime, SR_BH_steep,
                                              SR_regime_BLK1repl_2000,
                                              model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)
paramCheckSelfTest
# compare to OM
selfTest %>% select(SR_LN_R0, SR_regime, SR_regime_BLK1repl_2000,
                      model_run, iteration) %>%
      mutate(year = as.numeric(regmatches(model_run, 
                                          gregexpr("[[:digit:]]+", model_run)))) %>%
      filter(model_run == "start2001_OM")

selfTestFrates <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001fixedParms_RandRec_HCR1/results_ts_testConvrgEM2001fixedParms_RandRec_HCR1.csv")
selfTestFrates <- selfTestFrates %>% select(F_1, F_2, F_3, Seas, year, model_run, iteration, scenario)
summary(selfTestFrates)
selfTestFrates %>% filter(F_1 > 1 | F_2 > 1 | F_3 > 1) %>% arrange(year, Seas) %>%
  mutate(yearEM = as.numeric(regmatches(model_run, 
                                        gregexpr("[[:digit:]]+", model_run)))) %>%
  left_join(y = convrgCheckSelfTest, by = c("yearEM" = "year", "iteration", "model_run"))
```

Plot error for estimates of rec devs from 2068 compared to OM (these aren't terminal year estimates like plots above)
```{r}
recDevTS <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001fixedParms_RandRec_HCR1/results_ts_testConvrgEM2001fixedParms_RandRec_HCR1.csv")
recDevTS <- recDevTS %>% select(rec_dev, Seas, year, model_run, iteration, scenario) %>%
              filter(model_run == "start2001_OM" | grepl("2058", model_run)) %>%
              filter(complete.cases(.))

recDevTS %>% ggplot(aes(x=year, y=rec_dev)) + geom_line(aes(color = model_run)) + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()

relRecDevTS <- recDevTS %>% pivot_wider(id_cols = c(year, iteration),
                                        names_from = model_run, 
                                        values_from = rec_dev) %>% 
                  mutate(diffDevs = (testConvrgShortEM_EM_2058 - start2001_OM)/start2001_OM)

relRecDevTS %>% ggplot(aes(x=year, y=diffDevs)) + geom_line() + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()
```
# EM 2001 self test, random recruitment HCR3 (constant catch)

Look at years of no convergence and parameter bounds
```{r}
selfHCR3Test <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001fixedParms_RandRec_HCR3/results_scalar_testConvrgEM2001fixedParms_RandRec_HCR3.csv")

convrgCheckHCR3SelfTest <- selfHCR3Test %>% select(max_grad, params_on_bound, 
                                               params_stuck_low, params_stuck_high,
                                               model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)

convrgCheckHCR3SelfTest 
```

Look at dynamics of to see if population crashes
```{r}
selfHCR3BioTest <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001fixedParms_RandRec_HCR3/results_dq_testConvrgEM2001fixedParms_RandRec_HCR3.csv")

selfHCR3BioTest %>% filter(Value.SSB < 1000) %>% 
  filter(model_run == "start2001_OM") %>%
  select(year, Value.SSB, Value.Recr, iteration)
```

Plot diagnostics from self test of the 2001 model (random recruitment, HCR3)
```{r}

selfHCR3Bio <- bDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
          scenario = "testConvrgEM2001fixedParms_RandRec_HCR3",
          termYr = 2058, surveyInx = 4)
selfHCR3Bio[[1]] + geom_rug(data = convrgCheckHCR3SelfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
selfHCR3Bio[[2]] + geom_rug(data = convrgCheckHCR3SelfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

compDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2001fixedParms_RandRec_HCR3",
              termYr = 2058, surveyInx = 4)

selfHCR3Rec <- recrDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2001fixedParms_RandRec_HCR3", termYr = 2058)
selfHCR3Rec[[1]] + geom_rug(data = convrgCheckHCR3SelfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
selfHCR3Rec[[2]] + geom_rug(data = convrgCheckHCR3SelfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

selfHCR3Cat <- catchDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
                          scenario = "testConvrgEM2001fixedParms_RandRec_HCR3", termYr = 2058)
selfHCR3Cat[[1]] + geom_rug(data = convrgCheckHCR3SelfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

selfHCR3Age1Plus <- age1plusDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2001fixedParms_RandRec_HCR3", termYr = 2058)
selfHCR3Age1Plus[[1]] + geom_rug(data = convrgCheckHCR3SelfTest, mapping = aes(x = year),
                             sides = "b", inherit.aes = FALSE)
```

Look at recruitment and fishing mortality parameter estimates
```{r}
paramCheckHCR3SelfTest <- selfHCR3Test %>% select(max_grad, SR_LN_R0, SR_regime, SR_BH_steep,
                                              SR_regime_BLK1repl_2000,
                                              model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)
paramCheckHCR3SelfTest
# compare to OM
selfHCR3Test %>% select(SR_LN_R0, SR_regime, SR_regime_BLK1repl_2000,
                      model_run, iteration) %>%
      mutate(year = as.numeric(regmatches(model_run, 
                                          gregexpr("[[:digit:]]+", model_run)))) %>%
      filter(model_run == "start2001_OM")

selfHCR3TestFrates <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001fixedParms_RandRec_HCR3/results_ts_testConvrgEM2001fixedParms_RandRec_HCR3.csv")
selfHCR3TestFrates <- selfHCR3TestFrates %>% select(F_1, F_2, F_3, Seas, year, model_run, iteration, scenario)
summary(selfHCR3TestFrates)
selfHCR3TestFrates %>% filter(F_1 > 1 | F_2 > 1 | F_3 > 1) %>% arrange(year, Seas) %>%
  mutate(yearEM = as.numeric(regmatches(model_run, 
                                        gregexpr("[[:digit:]]+", model_run)))) %>%
  left_join(y = convrgCheckHCR3SelfTest, by = c("yearEM" = "year", "iteration", "model_run"))
```

Plot error for estimates of rec devs from 2058 compared to OM (these aren't terminal year estimates like plots above)
```{r}
recDevTS <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001fixedParms_RandRec_HCR3/results_ts_testConvrgEM2001fixedParms_RandRec_HCR3.csv")
recDevTS <- recDevTS %>% select(rec_dev, Seas, year, model_run, iteration, scenario) %>%
              filter(model_run == "start2001_OM" | grepl("2058", model_run)) %>%
              filter(complete.cases(.))

recDevTS %>% ggplot(aes(x=year, y=rec_dev)) + geom_line(aes(color = model_run)) + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()

relRecDevTS <- recDevTS %>% pivot_wider(id_cols = c(year, iteration),
                                        names_from = model_run, 
                                        values_from = rec_dev) %>% 
                  mutate(diffDevs = (testConvrgShortEM_EM_2058 - start2001_OM)/start2001_OM)

relRecDevTS %>% ggplot(aes(x=year, y=diffDevs)) + geom_line() + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()
```

# EM 2001 self test, mean recruitment

Look at years of no convergence and parameter bounds
```{r}
meanTest <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001fixedParms_MeanRec_HCR1/results_scalar_testConvrgEM2001fixedParms_MeanRec_HCR1.csv")

convrgCheckMeanTest <- meanTest %>% select(max_grad, params_on_bound, 
                                               params_stuck_low, params_stuck_high,
                                               model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)

convrgCheckMeanTest 
```

Plot diagnostics from self test of the 2001 model (random recruitment, HCR1)
```{r}

meanBio <- bDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
          scenario = "testConvrgEM2001fixedParms_MeanRec_HCR1",
          termYr = 2058, surveyInx = 4)
meanBio[[1]] + geom_rug(data = convrgCheckMeanTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
meanBio[[2]] + geom_rug(data = convrgCheckMeanTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

compDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2001fixedParms_MeanRec_HCR1",
              termYr = 2058, surveyInx = 4)

meanRec <- recrDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2001fixedParms_MeanRec_HCR1", termYr = 2058)
meanRec[[1]] + geom_rug(data = convrgCheckMeanTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
meanRec[[2]] + geom_rug(data = convrgCheckMeanTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

meanCat <- catchDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
                          scenario = "testConvrgEM2001fixedParms_MeanRec_HCR1", termYr = 2058)
meanCat[[1]] + geom_rug(data = convrgCheckMeanTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

meanAge1Plus <- age1plusDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2001fixedParms_MeanRec_HCR1", termYr = 2058)
meanAge1Plus[[1]] + geom_rug(data = convrgCheckMeanTest, mapping = aes(x = year),
                             sides = "b", inherit.aes = FALSE)
```

Look at dynamics of to see if population crashes
```{r}
meanBioTest <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001fixedParms_MeanRec_HCR1/results_dq_testConvrgEM2001fixedParms_MeanRec_HCR1.csv")

meanBioTest %>% filter(Value.SSB < 1000) %>% 
  filter(model_run == "start2001_OM") %>%
  select(year, Value.SSB, Value.Recr, iteration)
```

Look at recruitment and fishing mortality parameter estimates
```{r}
paramCheckMeanTest <- meanTest %>% select(max_grad, SR_LN_R0, SR_regime,SR_BH_steep,
                                              SR_regime_BLK1repl_2000,
                                              model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)
paramCheckMeanTest
# compare to OM
meanTest %>% select(SR_LN_R0, SR_regime, SR_regime_BLK1repl_2000,
                      model_run, iteration) %>%
      mutate(year = as.numeric(regmatches(model_run, 
                                          gregexpr("[[:digit:]]+", model_run)))) %>%
      filter(model_run == "start2001_OM")

meanTestFrates <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001fixedParms_MeanRec_HCR1/results_ts_testConvrgEM2001fixedParms_MeanRec_HCR1.csv")
meanTestFrates <- meanTestFrates %>% select(F_1, F_2, F_3, Seas, year, model_run, iteration, scenario)
summary(meanTestFrates)
meanTestFrates %>% filter(F_1 > 1 | F_2 > 1 | F_3 > 1) %>% arrange(year, Seas) %>%
  mutate(yearEM = as.numeric(regmatches(model_run, 
                                        gregexpr("[[:digit:]]+", model_run)))) %>%
  left_join(y = convrgCheckMeanTest, by = c("yearEM" = "year", "iteration", "model_run"))
```

Plot error for estimates of rec devs from 2068 compared to OM (these aren't terminal year estimates like plots above)
```{r}
recDevTS <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001fixedParms_MeanRec_HCR1/results_ts_testConvrgEM2001fixedParms_MeanRec_HCR1.csv")
recDevTS <- recDevTS %>% select(rec_dev, Seas, year, model_run, iteration, scenario) %>%
              filter(model_run == "start2001_OM" | grepl("2058", model_run)) %>%
              filter(complete.cases(.))

recDevTS %>% ggplot(aes(x=year, y=rec_dev)) + geom_line(aes(color = model_run)) + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()

relRecDevTS <- recDevTS %>% pivot_wider(id_cols = c(year, iteration),
                                        names_from = model_run, 
                                        values_from = rec_dev) %>% 
                  mutate(diffDevs = (testConvrgShortEM_EM_2058 - start2001_OM)/start2001_OM)

relRecDevTS %>% ggplot(aes(x=year, y=diffDevs)) + geom_line() + 
  ggplot2::facet_wrap(. ~ iteration, scales = "free") +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()
```

# EM 2001 self test, recruitment at SD = 1

Look at years of no convergence and parameter bounds
```{r}
sd1Test <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001_1SDRandRec_HCR1/results_scalar_testConvrgEM2001_1SDRandRec_HCR1.csv")

convrgCheck1SDTest <- sd1Test %>% select(max_grad, params_on_bound, 
                                               params_stuck_low, params_stuck_high,
                                               model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)

convrgCheck1SDTest 
```

Plot diagnostics from self test of the 2001 model (random recruitment, HCR1)
```{r}

sd1Bio <- bDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
          scenario = "testConvrgEM2001_1SDRandRec_HCR1",
          termYr = 2068, surveyInx = 4)
sd1Bio[[1]] + geom_rug(data = convrgCheck1SDTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
sd1Bio[[2]] + geom_rug(data = convrgCheck1SDTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

compDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2001_1SDRandRec_HCR1",
              termYr = 2068, surveyInx = 4)

sd1Rec <- recrDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2001_1SDRandRec_HCR1", termYr = 2068)
sd1Rec[[1]] + geom_rug(data = convrgCheck1SDTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
sd1Rec[[2]] + geom_rug(data = convrgCheck1SDTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

sd1Cat <- catchDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
                          scenario = "testConvrgEM2001_1SDRandRec_HCR1", termYr = 2068)
sd1Cat[[1]] + geom_rug(data = convrgCheck1SDTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

sd1Age1Plus <- age1plusDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2001_1SDRandRec_HCR1", termYr = 2068)
sd1Age1Plus[[1]] + geom_rug(data = convrgCheck1SDTest, mapping = aes(x = year),
                             sides = "b", inherit.aes = FALSE)
```

Look at recruitment and fishing mortality parameter estimates
```{r}
paramCheck1SDTest <- sd1Test %>% select(max_grad, SR_LN_R0, SR_regime,
                                              SR_regime_BLK1repl_2000,
                                              model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)
paramCheck1SDTest
# compare to OM
sd1Test %>% select(SR_LN_R0, SR_regime, SR_regime_BLK1repl_2000,
                      model_run, iteration) %>%
      mutate(year = as.numeric(regmatches(model_run, 
                                          gregexpr("[[:digit:]]+", model_run)))) %>%
      filter(model_run == "start2001_OM")

sd1TestFrates <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001_1SDRandRec_HCR1/results_ts_testConvrgEM2001_1SDRandRec_HCR1.csv")
sd1TestFrates <- sd1TestFrates %>% select(F_1, F_2, F_3, Seas, year, model_run, iteration, scenario)
summary(sd1TestFrates)
sd1TestFrates %>% filter(F_1 > 1 | F_2 > 1 | F_3 > 1) %>% arrange(year, Seas) %>%
  mutate(yearEM = as.numeric(regmatches(model_run, 
                                        gregexpr("[[:digit:]]+", model_run)))) %>%
  left_join(y = convrgCheck1SDTest, by = c("yearEM" = "year", "iteration", "model_run"))
```

Plot error for estimates of rec devs from 2068 compared to OM (these aren't terminal year estimates like plots above)
```{r}
recDevTS <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2001_1SDRandRec_HCR1/results_ts_testConvrgEM2001_1SDRandRec_HCR1.csv")
recDevTS <- recDevTS %>% select(rec_dev, Seas, year, model_run, iteration, scenario) %>%
              filter(model_run == "start2001_OM" | grepl("2068", model_run)) %>%
              filter(complete.cases(.))

recDevTS %>% ggplot(aes(x=year, y=rec_dev)) + geom_line(aes(color = model_run)) + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()

relRecDevTS <- recDevTS %>% pivot_wider(id_cols = c(year, iteration),
                                        names_from = model_run, 
                                        values_from = rec_dev) %>% 
                  mutate(diffDevs = (testConvrgShortEM_EM_2068 - start2001_OM)/start2001_OM)

relRecDevTS %>% ggplot(aes(x=year, y=diffDevs)) + geom_line() + 
  ggplot2::facet_wrap(. ~ iteration, scales = "free") +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()
```

# OM_K 1981 self test, EM management strategy

Look at years of no convergence and parameter bounds
```{r}
omkselfTest <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgOM_Kself_RandRec_EM/results_scalar_testConvrgOM_Kself_RandRec_EM.csv")

convrgCheckOMKselfTest <- omkselfTest %>% select(max_grad, params_on_bound, 
                                               params_stuck_low, params_stuck_high,
                                               model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)

convrgCheckOMKselfTest 
```

Plot diagnostics from self test of the 2001 model (random recruitment, HCR1)
```{r}

omkselfBio <- bDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
          scenario = "testConvrgOM_Kself_RandRec_EM",
          termYr = 2068, surveyInx = 4)
omkselfBio[[1]] + geom_rug(data = convrgCheckOMKselfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
omkselfBio[[2]] + geom_rug(data = convrgCheckOMKselfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

compDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgOM_Kself_RandRec_EM",
              termYr = 2068, surveyInx = 4)

omkselfRec <- recrDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgOM_Kself_RandRec_EM", termYr = 2068)
omkselfRec[[1]] + geom_rug(data = convrgCheckOMKselfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
omkselfRec[[2]] + geom_rug(data = convrgCheckOMKselfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

omkselfCat <- catchDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
                          scenario = "testConvrgOM_Kself_RandRec_EM", termYr = 2068)
omkselfCat[[1]] + geom_rug(data = convrgCheckOMKselfTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

omkselfAge1Plus <- age1plusDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgOM_Kself_RandRec_EM", termYr = 2068)
omkselfAge1Plus[[1]] + geom_rug(data = convrgCheckOMKselfTest, mapping = aes(x = year),
                             sides = "b", inherit.aes = FALSE)
```

Look at recruitment and fishing mortality parameter estimates
```{r}
paramCheckOMKselfTest <- omkselfTest %>% select(max_grad, SR_LN_R0, SR_regime,
                                              SR_regime_BLK1repl_1980,
                                              model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)
paramCheckOMKselfTest
# compare to OM
omkselfTest %>% select(SR_LN_R0, SR_regime, SR_regime_BLK1repl_1980,
                      model_run, iteration) %>%
      mutate(year = as.numeric(regmatches(model_run, 
                                          gregexpr("[[:digit:]]+", model_run)))) %>%
      filter(model_run == "OM_K_OM")

omkselfTestFrates <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgOM_Kself_RandRec_EM/results_ts_testConvrgOM_Kself_RandRec_EM.csv")
omkselfTestFrates <- omkselfTestFrates %>% select(F_1, F_2, F_3, Seas, year, model_run, iteration, scenario)
summary(omkselfTestFrates)
omkselfTestFrates %>% filter(F_1 > 1 | F_2 > 1 | F_3 > 1) %>% arrange(year, Seas) %>%
  mutate(yearEM = as.numeric(regmatches(model_run, 
                                        gregexpr("[[:digit:]]+", model_run)))) %>%
  left_join(y = convrgCheckOMKselfTest, by = c("yearEM" = "year", "iteration", "model_run"))
```

Plot error for estimates of rec devs from 2068 compared to OM (these aren't terminal year estimates like plots above)
```{r}
recDevTS <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgOM_Kself_RandRec_EM/results_ts_testConvrgOM_Kself_RandRec_EM.csv")
recDevTS <- recDevTS %>% select(rec_dev, Seas, year, model_run, iteration, scenario) %>%
              filter(model_run == "OM_K_OM" | grepl("2068", model_run)) %>%
              filter(complete.cases(.))

recDevTS %>% ggplot(aes(x=year, y=rec_dev)) + geom_line(aes(color = model_run)) + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()

relRecDevTS <- recDevTS %>% pivot_wider(id_cols = c(year, iteration),
                                        names_from = model_run, 
                                        values_from = rec_dev) %>% 
                  mutate(diffDevs = (testConvrgEM_K_EM_2068 - OM_K_OM)/OM_K_OM)

relRecDevTS %>% ggplot(aes(x=year, y=diffDevs)) + geom_line() + 
  ggplot2::facet_wrap(. ~ iteration, scales = "free") +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()
```

# OM_K 1981 with EM_K test, EM management strategy

Look at years of no convergence and parameter bounds
```{r}
omkemkTest <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgOM_KandEM_K_RandRec_EM/results_scalar_testConvrgOM_KandEM_K_RandRec_EM.csv")

convrgCheckOMKEMKTest <- omkemkTest %>% select(max_grad, params_on_bound, 
                                               params_stuck_low, params_stuck_high,
                                               model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)

convrgCheckOMKEMKTest 
```

Plot diagnostics from self test of the 2001 model (random recruitment, HCR1)
```{r}

omkemkBio <- bDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
          scenario = "testConvrgOM_KandEM_K_RandRec_EM",
          termYr = 2068, surveyInx = 4)
omkemkBio[[1]] + geom_rug(data = convrgCheckOMKEMKTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
omkemkBio[[2]] + geom_rug(data = convrgCheckOMKEMKTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

compDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgOM_KandEM_K_RandRec_EM",
              termYr = 2068, surveyInx = 4)

omkemkRec <- recrDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgOM_KandEM_K_RandRec_EM", termYr = 2068)
omkemkRec[[1]] + geom_rug(data = convrgCheckOMKEMKTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
omkemkRec[[2]] + geom_rug(data = convrgCheckOMKEMKTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

omkemkCat <- catchDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
                          scenario = "testConvrgOM_KandEM_K_RandRec_EM", termYr = 2068)
omkemkCat[[1]] + geom_rug(data = convrgCheckOMKEMKTest, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

omkemkAge1Plus <- age1plusDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgOM_KandEM_K_RandRec_EM", termYr = 2068)
omkemkAge1Plus[[1]] + facet_wrap(. ~ iteration, scales = "free") + 
  geom_rug(data = convrgCheckOMKEMKTest, mapping = aes(x = year),
           sides = "b", inherit.aes = FALSE) 
omkemkAge1Plus[[2]] + facet_wrap(. ~ iteration, scales = "free") + 
  geom_rug(data = convrgCheckOMKEMKTest, mapping = aes(x = year),
           sides = "b", inherit.aes = FALSE) 
```

Look at recruitment and fishing mortality parameter estimates
```{r}
paramCheckOMKselfTest <- omkemkTest %>% select(max_grad, SR_LN_R0, SR_regime,
                                              SR_regime_BLK1repl_1980,
                                              model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)
paramCheckOMKselfTest
# compare to OM
omkemkTest %>% select(SR_LN_R0, SR_regime, SR_regime_BLK1repl_1980,
                      model_run, iteration) %>%
      mutate(year = as.numeric(regmatches(model_run, 
                                          gregexpr("[[:digit:]]+", model_run)))) %>%
      filter(model_run == "OM_K_OM")

omkemkTestFrates <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgOM_KandEM_K_RandRec_EM/results_ts_testConvrgOM_KandEM_K_RandRec_EM.csv")
omkemkTestFrates <- omkemkTestFrates %>% select(F_1, F_2, F_3, Seas, year, model_run, iteration, scenario)
summary(omkemkTestFrates)
omkemkTestFrates %>% filter(F_1 > 1 | F_2 > 1 | F_3 > 1) %>% arrange(year, Seas) %>%
  mutate(yearEM = as.numeric(regmatches(model_run, 
                                        gregexpr("[[:digit:]]+", model_run)))) %>%
  left_join(y = convrgCheckOMKEMKTest, by = c("yearEM" = "year", "iteration", "model_run"))
```

Plot error for estimates of rec devs from 2068 compared to OM (these aren't terminal year estimates like plots above)
```{r}
recDevTS <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgOM_KandEM_K_RandRec_EM/results_ts_testConvrgOM_KandEM_K_RandRec_EM.csv")
recDevTS <- recDevTS %>% select(rec_dev, Seas, year, model_run, iteration, scenario) %>%
              filter(model_run == "OM_K_OM" | grepl("2068", model_run)) %>%
              filter(complete.cases(.))

recDevTS %>% ggplot(aes(x=year, y=rec_dev)) + geom_line(aes(color = model_run)) + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()

relRecDevTS <- recDevTS %>% pivot_wider(id_cols = c(year, iteration),
                                        names_from = model_run, 
                                        values_from = rec_dev) %>% 
                  mutate(diffDevs = (testConvrgEM_K_EM_2068 - OM_K_OM)/OM_K_OM)

relRecDevTS %>% ggplot(aes(x=year, y=diffDevs)) + geom_line() + 
  ggplot2::facet_wrap(. ~ iteration, scales = "free") +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()
```

# EM 2005 test, random recruitment

Look at years of no convergence and parameter bounds
```{r}
em2005Test <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2005fixedParms_RandRec_HCR1/results_scalar_testConvrgEM2005fixedParms_RandRec_HCR1.csv")

convrgCheck2005Test <- em2005Test %>% select(max_grad, params_on_bound, 
                                               params_stuck_low, params_stuck_high,
                                               model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)

convrgCheck2005Test 
```

Plot diagnostics from self test of the 2001 model (random recruitment, HCR1)
```{r}

em2005Bio <- bDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
          scenario = "testConvrgEM2005fixedParms_RandRec_HCR1",
          termYr = 2068, surveyInx = 4)
em2005Bio[[1]] + geom_rug(data = convrgCheck2005Test, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
em2005Bio[[2]] + geom_rug(data = convrgCheck2005Test, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

compDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2005fixedParms_RandRec_HCR1",
              termYr = 2068, surveyInx = 4)

em2005Rec <- recrDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2005fixedParms_RandRec_HCR1", termYr = 2068)
em2005Rec[[1]] + geom_rug(data = convrgCheck2005Test, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
em2005Rec[[2]] + geom_rug(data = convrgCheck2005Test, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

em2005Cat <- catchDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
                          scenario = "testConvrgEM2005fixedParms_RandRec_HCR1", termYr = 2068)
em2005Cat[[1]] + geom_rug(data = convrgCheck2005Test, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

em2005Age1Plus <- age1plusDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "testConvrgEM2005fixedParms_RandRec_HCR1", termYr = 2068)
em2005Age1Plus[[1]] + geom_rug(data = convrgCheck2005Test, mapping = aes(x = year),
                             sides = "b", inherit.aes = FALSE)
em2005Age1Plus[[2]] + geom_rug(data = convrgCheck2005Test, mapping = aes(x = year),
                             sides = "b", inherit.aes = FALSE)
```

Look at recruitment and fishing mortality parameter estimates
```{r}
paramCheck2005Test <- em2005Test %>% select(max_grad, SR_LN_R0, SR_regime, SR_BH_steep,
                                              SR_regime_BLK1repl_2000,
                                              model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)
paramCheck2005Test
# compare to OM
em2005Test %>% select(SR_LN_R0, SR_regime, SR_regime_BLK1repl_2000,
                      model_run, iteration) %>%
      mutate(year = as.numeric(regmatches(model_run, 
                                          gregexpr("[[:digit:]]+", model_run)))) %>%
      filter(model_run == "start2001_OM")

em2005TestFrates <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2005fixedParms_RandRec_HCR1/results_ts_testConvrgEM2005fixedParms_RandRec_HCR1.csv")
em2005TestFrates <- em2005TestFrates %>% select(F_1, F_2, F_3, Seas, year, model_run, iteration, scenario)
summary(em2005TestFrates)
em2005TestFrates %>% filter(F_1 > 1 | F_2 > 1 | F_3 > 1) %>% arrange(year, Seas) %>%
  mutate(yearEM = as.numeric(regmatches(model_run, 
                                        gregexpr("[[:digit:]]+", model_run)))) %>%
  left_join(y = convrgCheck2005Test, by = c("yearEM" = "year", "iteration", "model_run"))
```

Plot error for estimates of rec devs from 2068 compared to OM (these aren't terminal year estimates like plots above)
```{r}
recDevTS <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/testConvrgEM2005fixedParms_RandRec_HCR1/results_ts_testConvrgEM2005fixedParms_RandRec_HCR1.csv")
recDevTS <- recDevTS %>% select(rec_dev, Seas, year, model_run, iteration, scenario) %>%
              filter(model_run == "start2001_OM" | grepl("2068", model_run)) %>%
              filter(complete.cases(.))

recDevTS %>% ggplot(aes(x=year, y=rec_dev)) + geom_line(aes(color = model_run)) + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()

relRecDevTS <- recDevTS %>% pivot_wider(id_cols = c(year, iteration),
                                        names_from = model_run, 
                                        values_from = rec_dev) %>% 
                  mutate(diffDevs = (testConvrgShortEM_EM_2068 - start2001_OM)/start2001_OM)

relRecDevTS %>% ggplot(aes(x=year, y=diffDevs)) + geom_line() + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()
```

# EM 2005 test, SST recruitment

Look at years of no convergence and parameter bounds
```{r}
sst2005Test <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrowthShortOMandEM_SSTRec_HCR1/results_scalar_constGrowthShortOMandEM_SSTRec_HCR1.csv")

convrgCheckSST2005Test <- sst2005Test %>% select(max_grad, params_on_bound, 
                                               params_stuck_low, params_stuck_high,
                                               model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)

convrgCheckSST2005Test 
```

Plot diagnostics from self test of the 2001 model (random recruitment, HCR1)
```{r}

sst2005Bio <- bDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
          scenario = "constGrowthShortOMandEM_SSTRec_HCR1",
          termYr = 2068, surveyInx = 4)
sst2005Bio[[1]] + geom_rug(data = convrgCheckSST2005Test, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
sst2005Bio[[2]] + geom_rug(data = convrgCheckSST2005Test, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

compDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "constGrowthShortOMandEM_SSTRec_HCR1",
              termYr = 2068, surveyInx = 4)

sst2005Rec <- recrDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "constGrowthShortOMandEM_SSTRec_HCR1", termYr = 2068)
sst2005Rec[[1]] + geom_rug(data = convrgCheckSST2005Test, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)
sst2005Rec[[2]] + geom_rug(data = convrgCheckSST2005Test, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

sst2005Cat <- catchDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
                          scenario = "constGrowthShortOMandEM_SSTRec_HCR1", termYr = 2068)
sst2005Cat[[1]] + geom_rug(data = convrgCheckSST2005Test, mapping = aes(x = year),
                       sides = "b", inherit.aes = FALSE)

sst2005Age1Plus <- age1plusDiagPlots(dir = "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios",
              scenario = "constGrowthShortOMandEM_SSTRec_HCR1", termYr = 2068)
sst2005Age1Plus[[1]] + geom_rug(data = convrgCheckSST2005Test, mapping = aes(x = year),
                             sides = "b", inherit.aes = FALSE)
sst2005Age1Plus[[2]] + geom_rug(data = convrgCheckSST2005Test, mapping = aes(x = year),
                             sides = "b", inherit.aes = FALSE)
```

Look at recruitment and fishing mortality parameter estimates
```{r}
paramCheckSST2005Test <- sst2005Test %>% select(max_grad, SR_LN_R0, SR_regime, SR_BH_steep,
                                              SR_regime_BLK1repl_2000,
                                              model_run, iteration) %>%
                          mutate(year = as.numeric(regmatches(model_run, 
                                                              gregexpr("[[:digit:]]+", model_run)))) %>%
                          filter(max_grad > 0.01)
paramCheckSST2005Test
# compare to OM
sst2005Test %>% select(SR_LN_R0, SR_regime, SR_regime_BLK1repl_2000,
                      model_run, iteration) %>%
      mutate(year = as.numeric(regmatches(model_run, 
                                          gregexpr("[[:digit:]]+", model_run)))) %>%
      filter(model_run == "start2001_OM")

sst2005TestFrates <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrowthShortOMandEM_SSTRec_HCR1/results_ts_constGrowthShortOMandEM_SSTRec_HCR1.csv")
sst2005TestFrates <- sst2005TestFrates %>% select(F_1, F_2, F_3, Seas, year, model_run, iteration, scenario)
summary(sst2005TestFrates)
sst2005TestFrates %>% filter(F_1 > 1 | F_2 > 1 | F_3 > 1) %>% arrange(year, Seas) %>%
  mutate(yearEM = as.numeric(regmatches(model_run, 
                                        gregexpr("[[:digit:]]+", model_run)))) %>%
  left_join(y = convrgCheckSST2005Test, by = c("yearEM" = "year", "iteration", "model_run"))
```

Plot error for estimates of rec devs from 2068 compared to OM (these aren't terminal year estimates like plots above)
```{r}
recDevTS <- read_csv("C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios/constGrowthShortOMandEM_SSTRec_HCR1/results_ts_constGrowthShortOMandEM_SSTRec_HCR1.csv")
recDevTS <- recDevTS %>% select(rec_dev, Seas, year, model_run, iteration, scenario) %>%
              filter(model_run == "start2001_OM" | grepl("2068", model_run)) %>%
              filter(complete.cases(.))

recDevTS %>% ggplot(aes(x=year, y=rec_dev)) + geom_line(aes(color = model_run)) + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()

relRecDevTS <- recDevTS %>% pivot_wider(id_cols = c(year, iteration),
                                        names_from = model_run, 
                                        values_from = rec_dev) %>% 
                  mutate(diffDevs = (testConvrgShortEM_SSTRec_EM_2068 - start2001_OM)/start2001_OM)

relRecDevTS %>% ggplot(aes(x=year, y=diffDevs)) + geom_line() + 
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  ggplot2::theme_classic()
```

# Convergence summaries
Summary of non-convergence frequency per model run
```{r}
rbind(
convrgCheckServerTest %>% group_by(iteration) %>% 
  summarize(nonconvg = length(max_grad)) %>%
  mutate(nYrs = max(serverTestFrates$year) - 2019,
         frqNonConvg = nonconvg/nYrs,
         modRun = "old server OM2001 EM2005"),

# convrgCheck1981ServerTest %>% group_by(iteration) %>% 
#   summarize(nonconvg = length(max_grad)) %>%
#   mutate(nYrs = max(serv1981TestFrates$year) - 2019,
#          frqNonConvg = nonconvg/nYrs,
#          modRun = "old server OM_K EM_K")

convrgCheckSelfTest %>% group_by(iteration) %>% 
  summarize(nonconvg = length(max_grad)) %>%
  mutate(nYrs = max(selfTestFrates$year) - 2019,
         frqNonConvg = nonconvg/nYrs,
         modRun = "OM2001 self test"),

convrgCheckMeanTest %>% group_by(iteration) %>% 
  summarize(nonconvg = length(max_grad)) %>%
  mutate(nYrs = max(meanTestFrates$year) - 2019,
         frqNonConvg = nonconvg/nYrs,
         modRun = "OM2001 mean test"),

convrgCheck1SDTest %>% group_by(iteration) %>% 
  summarize(nonconvg = length(max_grad)) %>%
  mutate(nYrs = max(sd1TestFrates$year) - 2019,
         frqNonConvg = nonconvg/nYrs,
         modRun = "OM2001 SD=1, free est of Q and M"),

convrgCheckOMKselfTest %>% group_by(iteration) %>% 
  summarize(nonconvg = length(max_grad)) %>%
  mutate(nYrs = max(omkselfTestFrates$year) - 2019,
         frqNonConvg = nonconvg/nYrs,
         modRun = "OM_K self test"),

convrgCheckOMKEMKTest %>% group_by(iteration) %>% 
  summarize(nonconvg = length(max_grad)) %>%
  mutate(nYrs = max(omkemkTestFrates$year) - 2019,
         frqNonConvg = nonconvg/nYrs,
         modRun = "OM_K EM_K"),

convrgCheck2005Test %>% group_by(iteration) %>% 
  summarize(nonconvg = length(max_grad)) %>%
  mutate(nYrs = max(em2005TestFrates$year) - 2019,
         frqNonConvg = nonconvg/nYrs,
         modRun = "OM2001 EM2005"),

convrgCheckSST2005Test %>% group_by(iteration) %>% 
  summarize(nonconvg = length(max_grad)) %>%
  mutate(nYrs = max(sst2005TestFrates$year) - 2019,
         frqNonConvg = nonconvg/nYrs,
         modRun = "OM2001 EM2005 SSTRec")
)


unique(convrgCheck2005Test$params_on_bound)
unique(convrgCheck2005Test$params_stuck_low)
unique(convrgCheck2005Test$params_stuck_high)

unique(c(convrgCheckSelfTest$params_on_bound, convrgCheckMeanTest$params_on_bound))
unique(c(convrgCheckSelfTest$params_stuck_low, convrgCheckMeanTest$params_stuck_low))
unique(c(convrgCheckSelfTest$params_stuck_high, convrgCheckMeanTest$params_stuck_high))
```
