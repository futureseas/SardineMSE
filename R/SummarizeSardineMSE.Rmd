---
title: "Sardine MSE Results Summary"
author: "Robert Wildermuth"
date: "3/25/2022"
output:
  pdf_document: 
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, include=FALSE}
library(r4ss)
library(tidyverse)
library(RColorBrewer)

# source("J:/Desiree/Sardine/SardineMSE/R/GetSumryOutput.R")
# source("J:/Desiree/Sardine/SardineMSE/R/CalcPerformance.R")
# source("J:/Desiree/Sardine/SardineMSE/R/CalcTermTS.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/GetSumryOutput.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/CalcPerformance.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/CalcTermTS.R")
```

```{r, GetResults}
# run GetSumryOutput and CalcPerformance to get performance metrics

# mseDir <- "J:/Desiree/Sardine/SardineScenarios"
mseDir <- "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios"
termYr <- 2068

scenarios <- c("constGrow2001OM_constGrow2005EM_RandRecHCR0",
              "constGrow2001OM_constGrow2005EM_RandRecHCR1",
              "constGrow2001OM_constGrow2005EM_RandRecHCR2",
              "constGrow2001OM_constGrow2005EM_RandRecHCR3")#,
              #"constGrow2001OM_constGrow2005EM_RandRecHCR4",
              # "constGrow2001OM_constGrow2005EM_RandRecHCR5",
              # "constGrow2001OM_constGrow2005EM_RandRecHCR6",
              # "constGrow2001OM_constGrow2005EM_RandRecHCR7",
              # "constGrow2001OM_constGrow2005EM_RandRecHCR8",
              # 
              # "constGrow2001OM_constGrow2005EM_ARRecHCR0",
              # "constGrow2001OM_constGrow2005EM_ARRecHCR1",
              # "constGrow2001OM_constGrow2005EM_ARRecHCR2",
              # "constGrow2001OM_constGrow2005EM_ARRecHCR3",
              # "constGrow2001OM_constGrow2005EM_ARRecHCR4",
              # "constGrow2001OM_constGrow2005EM_ARRecHCR5",
              # "constGrow2001OM_constGrow2005EM_ARRecHCR6",
              # "constGrow2001OM_constGrow2005EM_ARRecHCR7",
              # "constGrow2001OM_constGrow2005EM_ARRecHCR8")#,
             #  
             #  "constGrow2001OM_constGrow2005EM_SSTRecHCR0",
             #  "constGrow2001OM_constGrow2005EM_SSTRecHCR1",
             #  "constGrow2001OM_constGrow2005EM_SSTRecHCR2",
             #  "constGrow2001OM_constGrow2005EM_SSTRecHCR3",
             #  #"constGrow2001OM_constGrow2005EM_SSTRecHCR4",
             #  "constGrow2001OM_constGrow2005EM_SSTRecHCR5",
             #  "constGrow2001OM_constGrow2005EM_SSTRecHCR6",
             #  "constGrow2001OM_constGrow2005EM_SSTRecHCR7",
             #  "constGrow2001OM_constGrow2005EM_SSTRecHCR8",
             # 
             #  "constGrow2001OM_constGrow2005EM_ccPDORecHCR0",
             #  "constGrow2001OM_constGrow2005EM_ccPDORecHCR1",
             #  "constGrow2001OM_constGrow2005EM_ccPDORecHCR2",
             #  "constGrow2001OM_constGrow2005EM_ccPDORecHCR3",
             # # "constGrow2001OM_constGrow2005EM_ccPDORecHCR4",
             #  "constGrow2001OM_constGrow2005EM_ccPDORecHCR5",
             #  "constGrow2001OM_constGrow2005EM_ccPDORecHCR6",
             #  "constGrow2001OM_constGrow2005EM_ccPDORecHCR7",
             #  "constGrow2001OM_constGrow2005EM_ccPDORecHCR8")#,
              # 
              # "constGrow2001OM_constGrow2005EM_PDORecHCR0",
              # "constGrow2001OM_constGrow2005EM_PDORecHCR1",
              # "constGrow2001OM_constGrow2005EM_PDORecHCR2",
              # "constGrow2001OM_constGrow2005EM_PDORecHCR3",
              # "constGrow2001OM_constGrow2005EM_PDORecHCR4",
              # "constGrow2001OM_constGrow2005EM_PDORecHCR5",
              # "constGrow2001OM_constGrow2005EM_PDORecHCR6",
              # "constGrow2001OM_constGrow2005EM_PDORecHCR7",
              # "constGrow2001OM_constGrow2005EM_PDORecHCR8",
              # 
              # "constGrow2001OM_constGrow2005EM_MICERecHCR0",
              # "constGrow2001OM_constGrow2005EM_MICERecHCR1",
              # "constGrow2001OM_constGrow2005EM_MICERecHCR2",
              # "constGrow2001OM_constGrow2005EM_MICERecHCR3",
              # "constGrow2001OM_constGrow2005EM_MICERecHCR4",
              # "constGrow2001OM_constGrow2005EM_MICERecHCR5",
              # "constGrow2001OM_constGrow2005EM_MICERecHCR6",
              # "constGrow2001OM_constGrow2005EM_MICERecHCR7",
              # "constGrow2001OM_constGrow2005EM_MICERecHCR8")


  smryOutputList <- GetSumryOutput(dirSSMSE = mseDir,
                                   scenarios = scenarios)
  # saveRDS(smryOutputList, 
  #         file = file.path(mseDir, "serverRandRec_ARRec_allHCRs_results.RDS"))
# smryOutputList <- readRDS(file.path(mseDir, "serverRandSSTPDOCyclRec_allHCRs_results.RDS"))
  
performanceList <- CalcPerformance(smryOutputList)

metricsTbl <- performanceList$perfomanceMetrics
                   

```

# Model Dynamics
## Timeseries
Plot timeseries of age1+ biomass, catch, and recruitment
```{r, Timeseries}
# get terminal estimates of these values for timeseries plots
termTS <- CalcTermTS(smryOutputList, termYr = termYr) %>% 
              mutate(HCR = sub(pattern = ".*Rec","", scenario),
                               recScen = sub(pattern = "HCR.*","", scenario)) %>%
              mutate(recScen = sub(pattern = ".*EM_","", recScen))

omName <- grep("_OM", smryOutputList$tsSmry$model_run, 
                 fixed = TRUE, value = TRUE)[1]
hcrPal <- brewer.pal(10, "Set3")[-2]

```

### Biomass
Plots of simulated (OM) biomass of age 1+ fish with 90% confidence intervals (grey band), and individual trajectories (dotted lines). Under a no fishing strategy:
* Biomass recovers in the random and cyclic PDO recruitment scenarios
  * Cyclic PDO doesn't result in same variation as random recruitment
* The SST recruitment scenario has higher overall biomass and larger variation
```{r, tsBiomass}

# timeseries plot for presentation
termTS %>% filter(model_run == omName, HCR == "HCR0") %>%
  select(Bio_smry, year, model_run, iteration, scenario, HCR, recScen) %>%
  group_by(year, scenario, HCR, recScen) %>%
  summarize(meanAge1Plus = mean(Bio_smry),
            lowAge1Plus = quantile(Bio_smry, probs = 0.1, na.rm = TRUE),
            hiAge1Plus = quantile(Bio_smry, probs = 0.9, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = meanAge1Plus)) +
  geom_line() +
  geom_ribbon(aes(ymin = lowAge1Plus, ymax = hiAge1Plus, alpha = 0.3)) +
  facet_grid(rows = vars(HCR), cols = vars(recScen)) +
  theme_minimal() +
  labs(x = "Year", y = "Age 1+ Biomass (mt)") +
  # add example trajectories
  geom_line(data = subset(termTS, model_run == omName & 
                            HCR == "HCR0" & 
                            iteration %in% sample(iteration, size = 5)),
            mapping = aes(x = year, y = Bio_smry, linetype = as.character(iteration))) +
  scale_linetype_manual(values = rep("dashed", 5)) +
  scale_color_manual(values = c("blue")) +
  theme(legend.position = "none")

# plot summary of biomass trajectories
termTS %>% filter(model_run == omName) %>%
  select(Bio_smry, year, model_run, iteration, scenario, HCR, recScen) %>%
  group_by(year, scenario, HCR, recScen) %>%
  summarize(meanAge1Plus = mean(Bio_smry),
            lowAge1Plus = quantile(Bio_smry, probs = 0.1, na.rm = TRUE),
            hiAge1Plus = quantile(Bio_smry, probs = 0.9, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = meanAge1Plus)) +
  geom_line() +
  geom_ribbon(aes(ymin = lowAge1Plus, ymax = hiAge1Plus, alpha = 0.3)) +
  facet_grid(rows = vars(HCR), cols = vars(recScen)) +
  theme_minimal()+ 
  theme(legend.position = "none")

```

### Recruitment
Samples of time series of recruitment deviations from 4 iterations. 
* The SST recruitment scenario is biased positive
  * Leads to much higher recruitment (numbers) overall compared to random recruitment scenario
* The cyclic PDO scenario doesn't have the same amount of interannual variability as historic or random scenarios, but over the projection period reaches the same distribution as historic recruitment deviations.
```{r, tsRecruitment}
# look at recruitment deviations
termTS %>% filter(model_run == omName,
                  HCR == "HCR0", iteration %in% sample(iteration, size = 4)) %>%
  ggplot(aes(x = year, y = rec_dev)) +
  geom_line(aes(linetype = as.character(iteration), color = as.character(iteration))) + 
  scale_linetype_manual(values = rep("solid", 50)) +
  guides(linetype = "none") +
  geom_hline(yintercept = 0, color = "grey") +
  facet_grid(rows = vars(iteration), cols = vars(recScen)) + 
  theme_minimal() +
  geom_vline(xintercept = 2019, color = "gray") +
  theme(legend.position = "none")

# plot summary of recruitment trajectories
termTS %>% filter(model_run == omName) %>%
  select(Value.Recr, year, model_run, iteration, scenario, HCR, recScen) %>%
  group_by(year, scenario, HCR, recScen) %>%
  summarize(meanRec = mean(Value.Recr),
            lowRec = quantile(Value.Recr, probs = 0.1, na.rm = TRUE),
            hiRec = quantile(Value.Recr, probs = 0.9, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = meanRec)) +
  geom_line() +
  geom_ribbon(aes(ymin = lowRec, ymax = hiRec, alpha = 0.3)) +
  facet_grid(rows = vars(HCR), cols = vars(recScen)) +
  theme_minimal() +
  theme(legend.position = "none")

```

### Catch
* Catch recovers more slowly in cyclic PDO scenario
* Catch is higher and more variable in the SST scenario
```{r, tsCatch}
# plot summary of catch trajectories
termTS %>% filter(model_run == omName) %>%
  select(totCatch, year, model_run, iteration, scenario, HCR, recScen) %>%
  group_by(year, scenario, HCR, recScen) %>%
  summarize(meanCatch = mean(totCatch),
            lowCatch = quantile(totCatch, probs = 0.1, na.rm = TRUE),
            hiCatch = quantile(totCatch, probs = 0.9, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = meanCatch)) +
  geom_line() +
  geom_ribbon(aes(ymin = lowCatch, ymax = hiCatch, alpha = 0.3)) +
  facet_grid(rows = vars(HCR), cols = vars(recScen)) +
  theme_minimal() +
  theme(legend.position = "none")

# plot catch levels for HCR5 (Pikitch rule)
meanCat <- termTS %>% filter(model_run == omName, HCR == "HCR5") %>%
  select(totCatch, year, model_run, iteration, scenario, HCR, recScen) %>%
  # try non-zero catch summary
  filter(totCatch > 0) %>%
  group_by(year, scenario, HCR, recScen) %>%
  summarize(meanCatch = mean(totCatch),
            # lowCatch = quantile(totCatch, probs = 0.1, na.rm = TRUE),
            hiCatch = quantile(totCatch, probs = 0.9, na.rm = TRUE),
            minCatch = min(totCatch)) 

# termTS %>% filter(model_run == omName, HCR == "HCR5") %>%
#   ggplot(aes(x = year, y = totCatch)) +
#   geom_point() +
#   geom_line(data = meanCat, aes(y = meanCatch, color = HCR)) +
#   geom_line(data = meanCat, aes(y = minCatch, color = HCR)) +
#   facet_wrap(~recScen) +
#   scale_color_manual(values = hcrPal[5]) +
#   theme_minimal()
```

## Other parameters
* No real trend in mean age, though larger stock biomasses generally allow for potentially older mean ages
* Unfished biomass (B0) estimated to increase as simulation projection progresses under SST recruitment scenario
```{r, tsParams}
# compare to mean length
  # find columns for directory parsing
  dirsCol <- ncol(str_split(smryOutputList$ageComp$resDir, 
                            pattern = "/", simplify = TRUE))

fleet4Age <- smryOutputList$ageComp %>% 
                # need to parse out iteration, model run and scenario
                mutate(model_run = str_split(resDir, pattern = "/", 
                                             simplify = TRUE)[, dirsCol], 
                       iteration = as.integer(str_split(resDir, pattern = "/", 
                                             simplify = TRUE)[, dirsCol-1]), 
                       scenario = str_split(resDir, pattern = "/", 
                                            simplify = TRUE)[, dirsCol-2]) %>%
                filter(grepl(omName, model_run, fixed = TRUE), Yr > 2019,
                       Seas == 1, Fleet == 4)

termTS %>% filter(model_run == omName, year > 2019,
                  recScen == "RandRec") %>%
  left_join(y = fleet4Age, by = c("model_run", "iteration", "scenario", "year" = "Yr")) %>%
  ggplot(aes(x = log(Bio_smry), y = All_exp_mean, color = HCR, alpha = 0.05)) +
  geom_point() +
  facet_wrap(~HCR) + 
  theme_minimal() +
  scale_color_manual(values = hcrPal) +
  labs(y = "Mean Age in Survey", x = "Age1+ Biomass (log-mt)")


# Look at timeseries of B0 and account for non-convergence
smryOutputList$sclSmry %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
  mutate(recScen = sub(pattern = ".*EM_","", recScen))  %>%
  filter(model_run != omName, HCR != "HCR0", max_grad < 0.01, 
         iteration == sample(1:max(unique(termTS$iteration)), size = 10)) %>%
  ggplot(aes(x = emYear, y = log(SSB_Unfished))) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = HCR))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(recScen)) +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "B0 (Unfished SSB)")

```

# Performance Metrics
Plot comparisons across HCR and Recruitment scenario

## Stock Status
```{r, metricsStatus}
# parse out HCR and recruitment scenario
metricsTbl <- metricsTbl %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                    recScen = sub(pattern = "HCR.*","", scenario)) %>%
                mutate(recScen = sub(pattern = ".*EM_","", recScen),
                       nameHCR = case_when(HCR == "HCR0" ~ "NoCat",
                                           HCR == "HCR1" ~ "PFMCF018",
                                           HCR == "HCR2" ~ "PFMCFSST",
                                           HCR == "HCR3" ~ "ConstF",
                                           HCR == "HCR5" ~ "Pikitch",
                                           HCR == "HCR6" ~ "40-10",
                                           HCR == "HCR7" ~ "DynPik",
                                           HCR == "HCR8" ~ "Dyn40-10"))

# fxn for metrics comparison
metricsPlot <- #function(yAxis, yLab){
  #ggplot(aes(x = HCR, y = vars(yAxis))) +
  ggplot() +
  geom_hline(yintercept = c(50000, 150000), color = "red") +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = c("NoCat", "PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
#}

# plot mean biomass
yLab = "Mean Age1+ Biomass (mt)"
metricsTbl %>% #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = meanB1plus)) +
  geom_hline(yintercept = c(50000, 150000), color = "red") +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = c("NoCat", "PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = yLab, x = "HCR") 


# plot collapse severity
metricsTbl %>% ggplot(aes(x = HCR, y = meanCollapseSever)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = c("NoCat", "PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Collapse severity", x = "HCR") 

# plot mean minimum age
metricsTbl %>% ggplot(aes(x = HCR, y = minAge)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = c("NoCat", "PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean minimum age", x = "HCR") 

# plot mean minimum length
metricsTbl %>% ggplot(aes(x = HCR, y = minLen)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = c("NoCat", "PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean minimum length", x = "HCR") 
```

## Fishery
```{r, metricsCatch}
# plot mean catch
metricsTbl %>%  filter(HCR != "HCR0") %>%
  #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = meanCatch)) +
  geom_hline(yintercept = 200000) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal[-1], labels = c("PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean Catch (mt)", x = "HCR")

# plot catch sd
metricsTbl %>%  filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = sdCatch)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal[-1], labels = c("PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Catch SD (mt)", x = "HCR")

# plot closure frequency
metricsTbl %>% #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = closuresFreq)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = c("NoCat", "PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency Bt < 150,000 mt", x = "HCR")

# plot collapse frequency
metricsTbl %>% ggplot(aes(x = HCR, y = collapseFreq)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = c("NoCat", "PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency Bt < 50,000 mt", x = "HCR")


# plot bonanza frequency
metricsTbl %>% ggplot(aes(x = HCR, y = bonanzaFreq)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = c("NoCat","PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequenct Bt > 0.8B0", x = "HCR")

```
Investigate rebuilding lengths
```{r}
rebuildTime <- performanceList$tsSmry %>% select(Bio_smry , year, model_run, iteration, scenario, closure, closureLength) %>%
  filter(closure) %>% arrange(scenario, iteration, year) #%>% filter(year == 2020)
#all(rebuildTime$closure)
rebuildTime$isRebuilt <- NA
for(i in 1:(nrow(rebuildTime)-1)){
  rebuildTime$isRebuilt[i] <- if(rebuildTime$closureLength[i] != rebuildTime$closureLength[i+1]-1){
                              TRUE
                            } else { FALSE }
}
rebuildTime <- rebuildTime %>% filter(isRebuilt, year != 2069) %>% # remove last year b/c can't guarantee stock is rebuilt
                   mutate(HCR = sub(pattern = ".*Rec","", scenario),
                          recScen = sub(pattern = "HCR.*","", scenario)) %>%
                   mutate(recScen = sub(pattern = ".*EM_","", recScen))

rebuildTime %>%  
  ggplot(aes(x = HCR, y = closureLength)) +
  #geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  geom_dotplot(binaxis = "y", binwidth = 1/15) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = c("NoCat","PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Rebuilding Time (yrs)", x = "HCR")

rebuildTime <- rebuildTime %>% group_by(model_run, iteration, scenario, HCR, recScen) %>%
                  summarize(nClosures = n(),
                            meanRebuildTime = mean(closureLength)) 

rebuildTime %>% #filter(recScen == "RandRec", HCR != "HCR4") %>% 
  ggplot(aes(x = HCR, y = meanRebuildTime)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = c("NoCat","PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean Rebuilding Time (yrs)", x = "HCR")

rebuildTime %>%  
  ggplot(aes(x = HCR, y = nClosures)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = c("NoCat","PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Number of Closures", x = "HCR")
```

## Assessment
* Maximum non-convergence rate was 4% to 8% depending on the HCR
* For the overall assessment:
  * Cyclic PDO led to positive bias in annual biomass estimate
  * The SST scenario was expected to be unbiased for a given year
* Estimates of biomass in the final year of assessment were negatively biased
  * Cyclic PDO recruitment scenario was least biased
  * SST recruitment scenario was most biased
```{r, metricsAssess}

# plot convergence frequency
metricsTbl %>% filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = frqNonConvg)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal[-1], labels = c("PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency of Non-convergence", x = "HCR")

hcrs <- unique(termTS$HCR)
exIters <- sample(termTS$iteration, size = 4)

convrgCheck <- smryOutputList$sclSmry %>% 
                  select(max_grad, model_run, iteration, scenario) %>%
                  mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
                  mutate(recScen = sub(pattern = ".*EM_","", recScen))  

cnvrgTS <- smryOutputList$tsSmry %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                   recScen = sub(pattern = "HCR.*","", scenario)) %>%
      mutate(recScen = sub(pattern = ".*EM_","", recScen)) %>%
      left_join(y = convrgCheck, by = c("iteration", "model_run", "scenario", "HCR", "recScen")) %>%
      mutate(plotGroup = case_when(model_run == omName ~ "OM",
                                   max_grad > 0.01 ~ "non-convrg",
                                   max_grad < 0.01 ~ "convrg"))


errCompare <- cnvrgTS %>% filter(Seas == 1, model_run != omName) %>%
                select(Bio_smry, year, model_run, iteration, scenario, HCR, 
                       recScen, emYear, plotGroup) %>%
                inner_join(y = subset(termTS, model_run == omName), 
                           by = c("year", "iteration", "scenario", "HCR", "recScen")) %>%
                #filter(iteration == 1) %>%
                  rename(age1plusOM = Bio_smry.y,
                         age1plusEM = Bio_smry.x) %>% 
                  mutate(errSmryBio = ((age1plusEM - age1plusOM)/age1plusOM)*100)

# Error among years within assessment
assessRE <- errCompare %>% filter(year <= emYear.x) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(meanRunRE = mean(errSmryBio),
                          medRunRE = median(errSmryBio),
                          hiRunRE = quantile(errSmryBio, probs = 0.95),
                          loRunRE = quantile(errSmryBio, probs = 0.05),
                          nErrs = n()) 
                # group_by(iteration, scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))  %>%
                # group_by(scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))

# Error among assessments within year
annualRE <- errCompare %>% filter(year <= emYear.x) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(year,  scenario, HCR, recScen, plotGroup) %>%#iteration,
                summarize(meanYrRE = mean(errSmryBio),
                          medYrRE = median(errSmryBio),
                          hiYrRE = quantile(errSmryBio, probs = 0.975),
                          loYrRE = quantile(errSmryBio, probs = 0.025),
                          q1YrRE = quantile(errSmryBio, probs = 0.25),
                          q3YrRE = quantile(errSmryBio, probs = 0.75),
                          nErrs = n())

assessRE %>% #filter(HCR != "HCR3") %>%
  ggplot(aes(x = HCR, y = meanRunRE, fill = plotGroup)) +
  geom_boxplot() +
  facet_wrap(~recScen) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Mean Annual Relative Error of Assessment")

scens <- unique(annualRE$recScen)
for(i in 1:length(scens)){
  print(annualRE %>% filter(plotGroup != "non-convrg", recScen == scens[i]) %>%
    ggplot(aes(x = as.factor(year), fill = HCR)) +
    geom_boxplot(aes(ymin = loYrRE, lower = q1YrRE, middle = medYrRE, 
                     upper = q3YrRE, ymax = hiYrRE),
                 stat = "identity") +
    facet_wrap(~HCR) +
    geom_hline(yintercept = 0) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    labs(title = "Median Annual Relative Error of Assessment"))
}

# Terminal estimate relative error
termRE <- errCompare %>% filter(year == emYear.x) %>%
              select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
              group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
              summarize(termRE = mean(errSmryBio))

termRE %>% ggplot(aes(x = HCR, y = termRE, fill = plotGroup)) +
  geom_boxplot() +
  facet_wrap(~recScen) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Mean Terminal Relative Error of Assessment")

termRE %>% group_by(scenario, HCR, recScen, plotGroup) %>%
              summarize(termScenHCR_RE = mean(termRE),
                        itN = n())
```

### Error Progression
Plot some timeseries over estimation models for each run
```{r}

for(hcr in 2:length(hcrs)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], iteration %in% exIters, Seas == 1) %>%
      ggplot(aes(x = year, y = log(Bio_smry))) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = log(50000), color = "red") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      ggplot2::facet_grid(rows = vars(iteration), cols = vars(recScen)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr]))
}

age1PlusBio <- smryOutputList$tsSmry %>% filter(Seas == 1) %>%
                  select(year, Bio_smry, model_run, iteration, scenario) %>%
                  mutate(plotGroup = case_when(grepl("_OM", model_run, fixed = TRUE) ~ "OM",
                                               TRUE ~ "EM"))

age1PlusRE <- age1PlusBio %>% filter(plotGroup != "OM")
age1PlusRE <- age1PlusRE %>% pivot_wider(names_from = "plotGroup", values_from = "Bio_smry") %>%
                left_join(y = convrgCheck,
                          by = c("model_run", "iteration", "scenario")) %>%
                full_join(y = subset(age1PlusBio, subset = plotGroup == "OM"),
                          by = c("iteration", "scenario", "year")) %>%
                mutate(convrg = case_when(max_grad > 0.01 ~ "non-convrg",
                                          max_grad < 0.01 ~ "convrg",
                                          TRUE ~ "OM"),
                       emRE = (EM - Bio_smry)/Bio_smry * 100)

# Plot relative errors of biomass over time
for(hcr in 2:length(hcrs)){
  print(age1PlusRE %>% filter(HCR == hcrs[hcr], iteration %in% exIters) %>%
  ggplot(aes(x = year, y = ifelse(emRE > 100, 100, emRE))) + #y = emRE)) +
  geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "gray") +
  geom_line(aes(linetype = as.character(model_run.x), color = convrg))+
  scale_color_manual(values = c("black", "blue", "#D65F00")) +
  scale_linetype_manual(values = rep("solid", 51)) +
  guides(linetype = "none") +
  facet_grid(rows = vars(iteration), cols = vars(scenario)) +
  theme_classic() + ylab(label = "Relative Error of Age 1+ Biomass (%)") +
  labs(title = hcrs[hcr]) +
  ylim(-100, 100))
}
```
### Terminal Year Error
Error of final assessment year over projection
```{r}
set.seed(seed = 413)
exIters <- sample(termTS$iteration, size = 3)
exHCR <- "HCR2"
convrgCheckEx <- convrgCheck %>% filter(iteration %in% exIters, HCR == exHCR)%>%
                  filter(max_grad > 0.01)

termTS %>% filter(iteration %in% exIters,
                  HCR == exHCR,
                  model_run != "constGrowBothShort_EM_init") %>%
  ggplot2::ggplot(aes(x = year, y = log(Bio_smry))) +
    ggplot2::geom_vline(xintercept = 2019, color = "gray") +
    
    ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = model_run))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
    ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(iteration), cols = vars(recScen)) +
    ggplot2::theme_classic() + 
  geom_rug(data = convrgCheckEx, mapping = aes(x = emYear),
                       sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "Age1+ Biomass (log-t)")
```
# Tradeoffs
Plot tradeoffs among metrics
```{r, Tradeoffs}

metricsTbl %>% #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = log(meanCatch), y = log(meanB1plus), color = HCR)) +
  geom_vline(xintercept = log(200000)) +
  geom_hline(yintercept = log(150000)) +
  geom_point() +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_color_manual(values = hcrPal, labels = c("NoCat","PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  labs(y = "Mean Age 1+ Biomass (log-mt)", x = "Mean Catch (log-mt)",
       title = "Mean Biomass x Mean Catch") 

termTS %>% filter(model_run == omName, year > 2019) %>%
  ggplot(aes(x = log(Bio_smry), y = log(totCatch), color = HCR)) +
  geom_point() +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_color_manual(values = hcrPal, labels = c("NoCat","PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) +
  labs(y = "Catch (log-mt)", x = "Age1+ Biomass (log-mt)",
       title = "Annual Biomass x Annual Catch")

metricsTbl %>% ggplot(aes(x = log(meanCatch), y = closuresFreq, color = HCR)) +
  geom_point() +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_color_manual(values = hcrPal, labels = c("NoCat","PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) 

metricsTbl %>% ggplot(aes(x = meanCatch, y = sdCatch, color = HCR)) +
  geom_point() +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_color_manual(values = hcrPal, labels = c("NoCat","PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) 

metricsTbl %>% ggplot(aes(x = meanCatch, y = minLen, color = HCR)) +
  geom_point() +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_color_manual(values = hcrPal, labels = c("NoCat","PFMCF018", "PFMCFSST",
                                                "ConstF", "Pikitch", "40-10",
                                                "DynPik", "Dyn40-10")) 

```



