---
title: "Sardine MSE Results Summary"
author: "Robert Wildermuth"
date: "3/25/2022"
output:
  pdf_document: 
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, include=FALSE}
library(r4ss)
library(tidyverse)
library(RColorBrewer)
library(scales)

# source("J:/Desiree/Sardine/SardineMSE/R/GetSumryOutput.R")
# source("J:/Desiree/Sardine/SardineMSE/R/CalcPerformance.R")
# source("J:/Desiree/Sardine/SardineMSE/R/CalcTermTS.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/GetSumryOutput.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/CalcPerformance.R")
source("C:/Users/r.wildermuth/Documents/FutureSeas/SardineMSE/R/CalcTermTS.R")
```

```{r, GetResults, include=FALSE}
# run GetSumryOutput and CalcPerformance to get performance metrics

# mseDir <- "J:/Desiree/Sardine/SardineScenarios"
mseDir <- "C:/Users/r.wildermuth/Documents/FutureSeas/SardineScenarios"
termYr <- 2068

scenarios <- c("constGrow2001OM_constGrow2005EM_RegRecHCR0",
              "constGrow2001OM_constGrow2005EM_RegRecHCR1",
              "constGrow2001OM_constGrow2005EM_RegRecHCR2",
              "constGrow2001OM_constGrow2005EM_RegRecHCR3",
              "constGrow2001OM_constGrow2005EM_RegRecHCR5",
              "constGrow2001OM_constGrow2005EM_RegRecHCR6",
              "constGrow2001OM_constGrow2005EM_RegRecHCR7",
              "constGrow2001OM_constGrow2005EM_RegRecHCR8",

              "constGrow2001OM_constGrow2005EM_ARRecHCR0",
              "constGrow2001OM_constGrow2005EM_ARRecHCR1",
              "constGrow2001OM_constGrow2005EM_ARRecHCR2",
              "constGrow2001OM_constGrow2005EM_ARRecHCR3",
              #"constGrow2001OM_constGrow2005EM_ARRecHCR4",
              "constGrow2001OM_constGrow2005EM_ARRecHCR5",
              "constGrow2001OM_constGrow2005EM_ARRecHCR6",
              "constGrow2001OM_constGrow2005EM_ARRecHCR7",
              "constGrow2001OM_constGrow2005EM_ARRecHCR8",
              
              # "constGrow2001OM_constGrow2005EM_MeanRecHCR0",
              # "constGrow2001OM_constGrow2005EM_MeanRecHCR1",
              # "constGrow2001OM_constGrow2005EM_MeanRecHCR2",
              # "constGrow2001OM_constGrow2005EM_MeanRecHCR3",
              # "constGrow2001OM_constGrow2005EM_MeanRecHCR5",
              # "constGrow2001OM_constGrow2005EM_MeanRecHCR6",
              # "constGrow2001OM_constGrow2005EM_MeanRecHCR7",
              # "constGrow2001OM_constGrow2005EM_MeanRecHCR8",

              "constGrow2001OM_constGrow2005EM_SSTRecHCR0",
              "constGrow2001OM_constGrow2005EM_SSTRecHCR1",
              "constGrow2001OM_constGrow2005EM_SSTRecHCR2",
              "constGrow2001OM_constGrow2005EM_SSTRecHCR3",
              #"constGrow2001OM_constGrow2005EM_SSTRecHCR4",
              "constGrow2001OM_constGrow2005EM_SSTRecHCR5",
              "constGrow2001OM_constGrow2005EM_SSTRecHCR6",
              "constGrow2001OM_constGrow2005EM_SSTRecHCR7",
              "constGrow2001OM_constGrow2005EM_SSTRecHCR8",


              "constGrow2001OM_constGrow2005EM_PDOclimRecHCR0",
              "constGrow2001OM_constGrow2005EM_PDOclimRecHCR1",
              "constGrow2001OM_constGrow2005EM_PDOclimRecHCR2",
              "constGrow2001OM_constGrow2005EM_PDOclimRecHCR3",
             # "constGrow2001OM_constGrow2005EM_ccPDORecHCR4",
              "constGrow2001OM_constGrow2005EM_PDOclimRecHCR5",
              "constGrow2001OM_constGrow2005EM_PDOclimRecHCR6",
              "constGrow2001OM_constGrow2005EM_PDOclimRecHCR7",
              "constGrow2001OM_constGrow2005EM_PDOclimRecHCR8",

              "constGrow2001OM_constGrow2005EM_PDOcyclRecHCR0",
              "constGrow2001OM_constGrow2005EM_PDOcyclRecHCR1",
              "constGrow2001OM_constGrow2005EM_PDOcyclRecHCR2",
              "constGrow2001OM_constGrow2005EM_PDOcyclRecHCR3",
              #"constGrow2001OM_constGrow2005EM_PDOcyclRecHCR4",
              "constGrow2001OM_constGrow2005EM_PDOcyclRecHCR5",
              "constGrow2001OM_constGrow2005EM_PDOcyclRecHCR6",
              "constGrow2001OM_constGrow2005EM_PDOcyclRecHCR7",
              "constGrow2001OM_constGrow2005EM_PDOcyclRecHCR8",

              "constGrow2001OM_constGrow2005EM_MICERecHCR0",
              "constGrow2001OM_constGrow2005EM_MICERecHCR1",
              "constGrow2001OM_constGrow2005EM_MICERecHCR2",
              "constGrow2001OM_constGrow2005EM_MICERecHCR3",
              # "constGrow2001OM_constGrow2005EM_MICERecHCR4",
              "constGrow2001OM_constGrow2005EM_MICERecHCR5",
              "constGrow2001OM_constGrow2005EM_MICERecHCR6",
              "constGrow2001OM_constGrow2005EM_MICERecHCR7",
              "constGrow2001OM_constGrow2005EM_MICERecHCR8")


  # smryOutputList <- GetSumryOutput(dirSSMSE = mseDir,
  #                                  scenarios = scenarios,
  #                                  comps = TRUE)
  # saveRDS(smryOutputList, 
  #         file = file.path(mseDir, "serverRandRec_ARRec_allHCRs_results.RDS"))
smryOutputList <- readRDS(file.path(mseDir, 
                                    "serverRegARPDOcyclPDOclimSSTMICE_allHCRs_results.RDS"))
  
performanceList <- CalcPerformance(smryOutputList)

metricsTbl <- performanceList$perfomanceMetrics
                   

```

# Model Dynamics
## Timeseries
Plot timeseries of age1+ biomass, catch, and recruitment
```{r, Timeseries, include=FALSE}
# get terminal estimates of these values for timeseries plots
termTS <- CalcTermTS(smryOutputList, termYr = termYr) %>% 
              mutate(HCR = sub(pattern = ".*Rec","", scenario),
                               recScen = sub(pattern = "HCR.*","", scenario)) %>%
              mutate(recScen = sub(pattern = ".*EM_","", recScen))

omName <- grep("_OM", smryOutputList$tsSmry$model_run, 
                 fixed = TRUE, value = TRUE)[1]
hcrPal <- brewer.pal(11, "Set3")[-2]

```

### Biomass
Plots of simulated (OM) biomass of age 1+ fish with 80% confidence intervals (grey band), and individual trajectories (dotted lines). Under a no fishing strategy:

* Biomass recovers in all recruitment scenarios
  * Regime and SST recruitment reach higher mean biomass than historic levels (max 1.5 x 10^6 in 1999 estimated from PK's research model)
  * MICE recruitment nears Regime scenario by end of simulation
* The SST recruitment scenario has unreasonably high biomass and larger variation 

```{r, tsBiomass, echo=FALSE, warning=FALSE, message=FALSE}

# timeseries plot for presentation
sampleDat <- termTS %>% filter(model_run == omName, HCR == "HCR0", Seas == 1) %>%
  select(Bio_smry, year, model_run, iteration, scenario, HCR, recScen, invScen) %>%
  group_by(year, scenario, HCR, recScen, invScen) %>%
  summarize(meanAge1Plus = mean(Bio_smry),
            lowAge1Plus = quantile(Bio_smry, probs = 0.1, na.rm = TRUE),
            hiAge1Plus = quantile(Bio_smry, probs = 0.9, na.rm = TRUE)) #%>%
  mutate(invScen = grepl("inv", recScen, fixed = TRUE))

sampleDat %>%
  ggplot(aes(x = year, y = meanAge1Plus)) +
  geom_line() +
  geom_ribbon(aes(ymin = lowAge1Plus, ymax = hiAge1Plus, alpha = 0.3)) +
  facet_grid(rows = vars(invScen), cols = vars(recScen)) +
  theme_minimal() +
  labs(x = "Year", y = "Age 1+ Biomass (mt)",
       caption = "Mean (solid line), 80% CI (grey shaded ribbon), and five sample trajectories under a No Catch (HCR0) management rule\n for each recruitment scenario.") +
  # add example trajectories
  geom_line(data = subset(termTS, model_run == omName & 
                            HCR == "HCR0" & 
                            iteration %in% sample(iteration, size = 5)),
            mapping = aes(x = year, y = Bio_smry, 
                          linetype = as.character(iteration), 
                          color = as.character(iteration)),
            size = 0.5) +
  scale_linetype_manual(values = rep("solid", 5)) +
  scale_color_manual(values = brewer.pal(n = 5, "Pastel1")) +
  geom_line(data = sampleDat, aes(x = year, y = meanAge1Plus)) +
  theme(legend.position = "none",
        plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") +
  geom_hline(yintercept = 150000, color = "red")

# plot summary of biomass trajectories
termTS %>% filter(model_run == omName) %>%
  select(Bio_smry, year, model_run, iteration, scenario, HCR, recScen) %>%
  group_by(year, scenario, HCR, recScen) %>%
  summarize(meanAge1Plus = mean(Bio_smry),
            lowAge1Plus = quantile(Bio_smry, probs = 0.1, na.rm = TRUE),
            hiAge1Plus = quantile(Bio_smry, probs = 0.9, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = meanAge1Plus)) +
  geom_line() +
  geom_ribbon(aes(ymin = lowAge1Plus, ymax = hiAge1Plus, alpha = 0.3)) +
  facet_grid(rows = vars(HCR), cols = vars(recScen)) +
  theme_minimal()+ 
  labs(x = "Year", y = "Age 1+ Biomass (mt)",
       caption = "Mean (solid line), 80% CI (grey shaded ribbon) of Age1+ biomass under each management rule (rows) for each recruitment\n scenario (columns).") +
  theme(legend.position = "none",
        plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

```

### Recruitment
Samples of time series of recruitment deviations from 4 iterations. 

* The SST recruitment scenario is biased positive with higher deviations than historic period
  * Leads to much higher recruitment (numbers) overall compared to other recruitment scenarios
* The cyclic PDO and Regime scenarios don't have the same amount of interannual variability as historic or autocorrelated scenarios, but over the projection period reach the same distribution as historic recruitment deviations.

```{r, tsRecruitment, echo=FALSE, warning=FALSE}
# look at recruitment deviations
termTS %>% filter(model_run == omName,
                  HCR == "HCR0", iteration %in% sample(iteration, size = 4)) %>%
  ggplot(aes(x = year, y = rec_dev)) +
  geom_line(aes(linetype = as.character(iteration), color = as.character(iteration))) + 
  scale_linetype_manual(values = rep("solid", 50)) +
  guides(linetype = "none") +
  geom_hline(yintercept = 0, color = "grey") +
  facet_grid(rows = vars(iteration), cols = vars(recScen)) + 
  theme_minimal() +
  geom_vline(xintercept = 2019, color = "gray") +
  labs(caption = "Sample recruitment deviation trajectories (rows) for each recruitment scenario (columns).") +
  theme(legend.position = "none",
        plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

# plot summary of recruitment trajectories
termTS %>% filter(model_run == omName) %>%
  select(Value.Recr, year, model_run, iteration, scenario, HCR, recScen) %>%
  group_by(year, scenario, HCR, recScen) %>%
  summarize(meanRec = mean(Value.Recr),
            lowRec = quantile(Value.Recr, probs = 0.1, na.rm = TRUE),
            hiRec = quantile(Value.Recr, probs = 0.9, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = meanRec)) +
  geom_line() +
  geom_ribbon(aes(ymin = lowRec, ymax = hiRec, alpha = 0.3)) +
  facet_grid(rows = vars(HCR), cols = vars(recScen)) +
  theme_minimal() +
  labs(caption = "Mean (solid line), 80% CI (grey shaded ribbon) of recruitment abundance under each management rule (rows) for each\n recruitment scenario (columns).") +
  theme(legend.position = "none",
        plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")
```

### Catch
* Catch generally follows the pattern of recruitment in each scenario
* Catch recovers more slowly in cyclic PDO scenario
* Catch reaches maximum levels in Regime and SST scenarios, almost immediately in SST scenario
  * Mean levels higher than AR scenario
* MICE and climate-driven PDO recruitment scenarios project decline (potential crash) in catch during simulation, regardless of HCR

```{r, tsCatch, echo=FALSE, warning=FALSE}
# plot summary of catch trajectories
termTS %>% filter(model_run == omName) %>%
  select(totCatch, year, model_run, iteration, scenario, HCR, recScen) %>%
  group_by(year, scenario, HCR, recScen) %>%
  summarize(meanCatch = mean(totCatch),
            lowCatch = quantile(totCatch, probs = 0.1, na.rm = TRUE),
            hiCatch = quantile(totCatch, probs = 0.9, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = meanCatch)) +
  geom_line() +
  geom_ribbon(aes(ymin = lowCatch, ymax = hiCatch, alpha = 0.3)) +
  facet_grid(rows = vars(HCR), cols = vars(recScen)) +
  theme_minimal() +
  labs(caption = "Mean (solid line), 80% CI (grey shaded ribbon) of catch (mt) under each management rule (rows) for each\n recruitment scenario (columns).") +
  theme(legend.position = "none",
        plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

# plot catch levels for HCR5 (Pikitch rule)
meanCat <- termTS %>% filter(model_run == omName, HCR == "HCR5") %>%
  select(totCatch, year, model_run, iteration, scenario, HCR, recScen) %>%
  # try non-zero catch summary
  filter(totCatch > 0) %>%
  group_by(year, scenario, HCR, recScen) %>%
  summarize(meanCatch = mean(totCatch),
            # lowCatch = quantile(totCatch, probs = 0.1, na.rm = TRUE),
            hiCatch = quantile(totCatch, probs = 0.9, na.rm = TRUE),
            minCatch = min(totCatch)) 

# termTS %>% filter(model_run == omName, HCR == "HCR5") %>%
#   ggplot(aes(x = year, y = totCatch)) +
#   geom_point() +
#   geom_line(data = meanCat, aes(y = meanCatch, color = HCR)) +
#   geom_line(data = meanCat, aes(y = minCatch, color = HCR)) +
#   facet_wrap(~recScen) +
#   scale_color_manual(values = hcrPal[5]) +
#   theme_minimal()
```

## Other parameters
* No real trend in mean age, though larger stock biomasses generally allow for potentially older mean ages
* Unfished biomass (B0) estimated to increase as simulation projection progresses under SST recruitment scenario

```{r, tsParams, echo=FALSE, warning=FALSE}
# compare to mean length
  # find columns for directory parsing
  dirsCol <- ncol(str_split(smryOutputList$ageComp$resDir, 
                            pattern = "/", simplify = TRUE))

fleet4Age <- smryOutputList$ageComp %>% 
                # need to parse out iteration, model run and scenario
                mutate(model_run = str_split(resDir, pattern = "/", 
                                             simplify = TRUE)[, dirsCol], 
                       iteration = as.integer(str_split(resDir, pattern = "/", 
                                             simplify = TRUE)[, dirsCol-1]), 
                       scenario = str_split(resDir, pattern = "/", 
                                            simplify = TRUE)[, dirsCol-2]) %>%
                filter(grepl(omName, model_run, fixed = TRUE), Yr > 2019,
                       Seas == 1, Fleet == 4)

termTS %>% filter(model_run == omName, year > 2019,
                  recScen == "ARRec") %>%
  left_join(y = fleet4Age, by = c("model_run", "iteration", "scenario", "year" = "Yr")) %>%
  ggplot(aes(x = log(Bio_smry), y = All_exp_mean, color = HCR, alpha = 0.05)) +
  geom_point() +
  facet_wrap(~HCR) + 
  theme_minimal() +
  scale_color_manual(values = hcrPal) +
  labs(y = "Mean Age in Survey", x = "Age1+ Biomass (log-mt)",
       caption = "Relationship between mean age in the AT survey and stock biomass under each management rule (rows) for the autocorrelated\n recruitment scenario.") +
  theme(legend.position = "none",
        plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

# Look at timeseries of B0 and account for non-convergence
smryOutputList$sclSmry %>% mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
  mutate(recScen = sub(pattern = ".*EM_","", recScen))  %>%
  filter(model_run != omName, HCR != "HCR0", max_grad < 0.01, 
         iteration == sample(1:max(unique(termTS$iteration)), size = 10)) %>%
  ggplot(aes(x = emYear, y = log(SSB_Unfished))) +
  geom_line(ggplot2::aes(linetype = as.character(iteration), color = HCR))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 100)) +
  ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(HCR), cols = vars(recScen)) +
    ggplot2::theme_classic() + 
  #geom_rug(data = convrgCheck, mapping = aes(x = emYear),
  #                     sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "B0 (Unfished SSB)",
       caption = "Sample of estimated unfished SSB (B0) in the assessment under each management rule (rows) and each recruitment\n scenario (columns).") +
  theme(legend.position = "none",
        plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

```

# Performance Metrics
Plot comparisons across HCR and Recruitment scenario

**NOTE** Current HCR (HCR2) only comparable among MICE and SST scenarios, *or* AR, cyclic and climate-driven PDO, and Regime recruitment scenarios. The last four scenarios need to be re-run with corrected HCR2 fxn.

## Stock Status

* Larger variation in biomass outcomes among scenarios than HCRs
  * Mean biomass only crosses management thresholds or limits in AR recruitment scenario
* Relative to other HCRs within recruitment scenarios, HCR1 allows larger biomasses on average
  * Distant second is HCR7, though groups more with other HCRs
  * HCR2 (Current SST rule) results in lowest mean biomass (see above note)
* HCR1 allows for higher biomass than No Catch HCR0 in a few instances
* Collapse severity slightly higher in HCR3 and HCR8
* Slightly higher mean min ages and lengths in HCR0 and HCR1 

```{r, metricsStatus, echo=FALSE, warning=FALSE}
# parse out HCR and recruitment scenario
metricsTbl <- metricsTbl %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                    recScen = sub(pattern = "HCR.*","", scenario)) %>%
                mutate(recScen = sub(pattern = ".*EM_","", recScen),
                       nameHCR = case_when(HCR == "HCR0" ~ "NoCat",
                                           HCR == "HCR1" ~ "PFMCF018",
                                           HCR == "HCR2" ~ "PFMCFSST",
                                           HCR == "HCR3" ~ "ConstF",
                                           HCR == "HCR5" ~ "Pikitch",
                                           HCR == "HCR6" ~ "40-10",
                                           HCR == "HCR7" ~ "DynPik",
                                           HCR == "HCR8" ~ "Dyn40-10",
                                           HCR == "HCR9" ~ "Index"))

# Calculate relative biomass and catch metrics
relDenoms <- metricsTbl %>% group_by(recScen, iteration) %>%
                summarize(maxMeanBio = max(meanB1plus),
                          maxMeanCat = max(meanCatch)) %>%
                full_join(y = metricsTbl %>% filter(HCR == "HCR0") %>% 
                                select(recScen, iteration, meanB1plus),
                          by = c("recScen", "iteration")) %>%
                rename("meanHCR0Bio" = "meanB1plus")

metricsTbl <- metricsTbl %>% full_join(y = relDenoms,
                                       by = c("recScen", "iteration")) %>%
                mutate(relBioMax = meanB1plus/maxMeanBio,
                       relBioHCR0 = meanB1plus/meanHCR0Bio,
                       relCatMax = meanCatch/maxMeanCat)

hcrLabels <- c("NoCat", "PFMCF018", "PFMCFSST", "ConstF", "Pikitch", "40-10",
               "DynPik", "Dyn40-10", "Index")

# fxn for metrics comparison
metricsPlot <- #function(yAxis, yLab){
  #ggplot(aes(x = HCR, y = vars(yAxis))) +
  ggplot() +
  geom_hline(yintercept = c(50000, 150000), color = "red") +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
#}

# plot mean biomass
yLab = "Mean Age1+ Biomass (mt)"
metricsTbl %>% #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = meanB1plus)) +
  geom_hline(yintercept = c(50000, 150000), color = "red") +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = yLab, x = "HCR",
       caption = "Violin plot of mean Age1+ biomass under each HCR for each recruitment scenario. Red lines are the 150K and 50K mt\n management limit and threshold.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

metricsTbl %>% #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = relBioMax)) +
  #geom_hline(yintercept = c(50000, 150000), color = "red") +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean Age1+ Biomass:Max", x = "HCR",
       caption = "Violin plot of mean Age1+ biomass under each HCR relative to the maximum mean biomass observed in each recruitment scenario.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

# pool recruitment scenarios
metricsTbl %>% #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = relBioMax)) +
  #geom_hline(yintercept = c(50000, 150000), color = "red") +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  #facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean Age1+ Biomass:Max", x = "HCR",
       caption = "Violin plot of mean Age1+ biomass under each HCR relative to the maximum mean biomass observed across recruitment scenarios.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

metricsTbl %>% #filter(recScen == "RandRec", HCR != "HCR4") %>%
    ggplot(aes(x = HCR, y = relBioMax)) +
    geom_jitter(aes(color = recScen, alpha = 0.03)) +
    theme_minimal() +
    scale_fill_manual(values = hcrPal, labels = hcrLabels) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    labs(y = "Mean Age1+ Biomass:Max", x = "HCR",
         caption = "Jitter plot of mean Age1+ biomass under each HCR relative to the maximum mean biomass observed in each recruitment scenario.\nMeans over model iteration, colors are recruitment scenario.") +
    theme(plot.caption = element_text(hjust = 0),
          plot.caption.position = "plot")

metricsTbl %>% #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = relBioHCR0)) +
  #geom_hline(yintercept = c(50000, 150000), color = "red") +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean Age1+ Biomass:HCR0", x = "HCR",
       caption = "Violin plot of mean Age1+ biomass under each HCR relative to the maximum mean biomass observed for the No Catch (HCR0) rule\n in each recruitment scenario.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") 

# plot collapse severity
metricsTbl %>% ggplot(aes(x = HCR, y = meanCollapseSever)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Collapse severity", x = "HCR",
       caption = "Violin plot of mean collapse severity under each HCR for each recruitment scenario. Values closer to 1 are less severe.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") 

metricsTbl %>% ggplot(aes(x = HCR, y = meanCollapseSever)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  #facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Collapse severity", x = "HCR",
       caption = "Violin plot of mean collapse severity under each HCR across recruitment scenarios. Values closer to 1 are less severe.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") 

metricsTbl %>% ggplot(aes(x = HCR, y = meanCollapseSever)) +
  geom_jitter(aes(color = recScen, alpha = 0.03)) +
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Collapse severity", x = "HCR",
       caption = "Jitter plot of mean collapse severity under each HCR for each recruitment scenario. Values closer to 1 are less severe.\nMeans over model iteration, colors are recruitment scenario.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") 

# plot mean minimum age
metricsTbl %>% ggplot(aes(x = HCR, y = minAge)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean minimum age", x = "HCR",
       caption = "Violin plot of mean of the minimum age observed under each HCR for each recruitment scenario.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") 

# plot mean minimum length
metricsTbl %>% ggplot(aes(x = HCR, y = minLen)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean minimum length", x = "HCR",
       caption = "Violin plot of mean of the minimum length observed under each HCR for each recruitment scenario.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") 
```

## Fishery

* Larger variation in catch outcomes among scenarios than HCRs
* Relative to HCR2 (highest mean catch), HCR1 and HCR7 had lowest mean catches
* HCR2 had highest catch variability in non-SST scenarios and lowest in SST scenario
  * HCR1 and HCR7 had highest variability in SST scenario
* Rank of least frequently below 150K mt: HCR0, HCR1, HCR2, HCR7
  * HCR1 had overall lowest frequency of years below 150K mt across all scenarios
* HCR1 least frequently below 50K mt, HCR3 and HCR8 most frequently below 50K mt
* Bonanzas (biomass >0.8B0) generally rare (<10% chance), except in SST scenario where bonanzas were common (50% chance or greater)
* Rebuilding time generally less than 10 yrs, though potentially longer in AR scenario
  * Slightly longer rebuilding time under HCR0 and HCR1 under Regime and cyclic PDO scenarios
  * Slightly longer rebuilding time under HCR3 and HCR8 under AR scenario
* Number of potential closure events always <4 for HCR0 and HCR1, no longer than 6 times

```{r, metricsCatch, echo=FALSE, warning=FALSE}
# plot mean catch
metricsTbl %>%  filter(HCR != "HCR0") %>%
  #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = meanCatch)) +
  geom_hline(yintercept = 200000) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean Catch (mt)", x = "HCR",
       caption = "Violin plot of mean catch (mt) observed under each HCR for each recruitment scenario. Black horizontal line indicates the\n maximum catch.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") 

metricsTbl %>%  filter(HCR != "HCR0") %>%
  #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = relCatMax)) +
  #geom_hline(yintercept = 200000) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean Catch:Max", x = "HCR",
       caption = "Violin plot of mean catch (mt) under each HCR relative to the maximum catch observed in each recruitment scenario.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

metricsTbl %>%  filter(HCR != "HCR0") %>%
  #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = relCatMax)) +
  #geom_hline(yintercept = 200000) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  #facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean Catch:Max", x = "HCR",
       caption = "Violin plot of mean catch (mt) under each HCR relative to the maximum catch observed across recruitment scenarios.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

metricsTbl %>%  filter(HCR != "HCR0") %>%
  #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = relCatMax)) +
  geom_jitter(aes(color = recScen, alpha = 0.03)) +
  theme_minimal() +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean Catch:Max", x = "HCR",
       caption = "Jitter plot of mean catch (mt) under each HCR relative to the maximum catch observed in each recruitment scenario.\nMeans over model iteration, colors are recruitment scenarios.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

# plot catch sd
metricsTbl %>%  filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = sdCatch)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Catch SD (mt)", x = "HCR",
       caption = "Violin plot of mean standard deviation of catch (mt) observed under each HCR for each recruitment scenario.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

metricsTbl %>%  filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = sdCatch)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  #facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Catch SD (mt)", x = "HCR",
       caption = "Violin plot of mean standard deviation of catch (mt) observed under each HCR across recruitment scenarios.\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

metricsTbl %>%  filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = sdCatch)) +
  geom_jitter(aes(color = recScen, alpha = 0.03)) +
  theme_minimal() +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Catch SD (mt)", x = "HCR",
       caption = "Jitter plot of mean standard deviation of catch (mt) observed under each HCR for each recruitment scenario.\nMeans over model iteration, colors are recruitment scenarios.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

# plot closure frequency
metricsTbl %>% #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = closuresFreq)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency Bt < 150,000 mt", x = "HCR",
       caption = "Violin plot of the frequency Age1+ stock biomass was below the 150,000 mt closure threshold.\nFrequencies over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

metricsTbl %>% #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = closuresFreq)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  # facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency Bt < 150,000 mt", x = "HCR",
       caption = "Violin plot of the frequency Age1+ stock biomass was below the 150,000 mt closure threshold.\nFrequencies over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

metricsTbl %>% #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = HCR, y = closuresFreq)) +
  geom_jitter(aes(color = recScen, alpha = 0.03)) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency Bt < 150,000 mt", x = "HCR",
       caption = "Jitter plot of the frequency Age1+ stock biomass was below the 150,000 mt closure threshold.\nFrequencies over model iteration, colors are recruitment scenarios.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

# plot collapse frequency
metricsTbl %>% ggplot(aes(x = HCR, y = collapseFreq)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency Bt < 50,000 mt", x = "HCR",
       caption = "Violin plot of the frequency Age1+ stock biomass was below the 50,000 mt collapse threshold.\nFrequencies over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

metricsTbl %>% ggplot(aes(x = HCR, y = collapseFreq)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  # facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency Bt < 50,000 mt", x = "HCR",
       caption = "Violin plot of the frequency Age1+ stock biomass was below the 50,000 mt collapse threshold.\nFrequencies over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

metricsTbl %>% ggplot(aes(x = HCR, y = collapseFreq)) +
  geom_jitter(aes(color = recScen, alpha = 0.03)) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency Bt < 50,000 mt", x = "HCR",
       caption = "Jitter plot of the frequency Age1+ stock biomass was below the 50,000 mt collapse threshold.\nFrequencies over model iteration, colors are recruitment scenario.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

# plot bonanza frequency
metricsTbl %>% ggplot(aes(x = HCR, y = bonanzaFreq)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency Bt > 0.8B0", x = "HCR",
       caption = "Violin plot of the frequency Age1+ stock biomass was above the bonanza threshold (Bt > 0.8B0).\nFrequencies over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

metricsTbl %>% ggplot(aes(x = HCR, y = bonanzaFreq)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  #facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency Bt > 0.8B0", x = "HCR",
       caption = "Violin plot of the frequency Age1+ stock biomass was above the bonanza threshold (Bt > 0.8B0).\nFrequencies over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

metricsTbl %>% ggplot(aes(x = HCR, y = bonanzaFreq)) +
  geom_jitter(aes(color = recScen, alpha = 0.03)) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency Bt > 0.8B0", x = "HCR",
       caption = "Violin plot of the frequency Age1+ stock biomass was above the bonanza threshold (Bt > 0.8B0).\nFrequencies over model iteration, colors are recruitment scenario.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")
```

Investigate rebuilding lengths

```{r, echo=FALSE}
rebuildTime <- performanceList$tsSmry %>% select(Bio_smry , year, model_run, iteration, scenario, closure, closureLength) %>%
  filter(closure) %>% arrange(scenario, iteration, year) #%>% filter(year == 2020)
#all(rebuildTime$closure)
rebuildTime$isRebuilt <- NA
for(i in 1:(nrow(rebuildTime)-1)){
  rebuildTime$isRebuilt[i] <- if(rebuildTime$closureLength[i] != rebuildTime$closureLength[i+1]-1){
                              TRUE
                            } else { FALSE }
}
rebuildTime <- rebuildTime %>% filter(isRebuilt, year != 2069) %>% # remove last year b/c can't guarantee stock is rebuilt
                   mutate(HCR = sub(pattern = ".*Rec","", scenario),
                          recScen = sub(pattern = "HCR.*","", scenario)) %>%
                   mutate(recScen = sub(pattern = ".*EM_","", recScen))

# rebuildTime %>%  
#   ggplot(aes(x = HCR, y = closureLength)) +
#   #geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
#   geom_dotplot(binaxis = "y", binwidth = 1/15) +
#   facet_wrap(~recScen, scales = "free") + 
#   theme_minimal() +
#   scale_fill_manual(values = hcrPal, labels = hcrLabels) +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
#   labs(y = "Rebuilding Time (yrs)", x = "HCR",
#        caption = "Dot plot of the length of the rebuilding period (i.e., length of time Age1+ stock biomass was below the 150,000 mt closure threshold).\nValues over model iteration.") +
#   theme(plot.caption = element_text(hjust = 0),
#         plot.caption.position = "plot")

rebuildTime <- rebuildTime %>% group_by(model_run, iteration, scenario, HCR, recScen) %>%
                  summarize(nClosures = n(),
                            meanRebuildTime = mean(closureLength)) 

rebuildTime %>% #filter(recScen == "RandRec", HCR != "HCR4") %>% 
  ggplot(aes(x = HCR, y = meanRebuildTime)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean Rebuilding Time (yrs)", x = "HCR",
       caption = "Violin plot of the mean rebuilding time (i.e., mean length of time Age1+ stock biomass was below the 150,000 mt closure threshold).\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

rebuildTime %>% #filter(recScen == "RandRec", HCR != "HCR4") %>% 
  ggplot(aes(x = HCR, y = meanRebuildTime)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  # facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean Rebuilding Time (yrs)", x = "HCR",
       caption = "Violin plot of the mean rebuilding time (i.e., mean length of time Age1+ stock biomass was below the 150,000 mt closure threshold).\nMeans over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

rebuildTime %>% #filter(recScen == "RandRec", HCR != "HCR4") %>% 
  ggplot(aes(x = HCR, y = meanRebuildTime)) +
  geom_jitter(aes(color = recScen, alpha = 0.03)) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Mean Rebuilding Time (yrs)", x = "HCR",
       caption = "Jitter plot of the mean rebuilding time (i.e., mean length of time Age1+ stock biomass was below the 150,000 mt closure threshold).\nMeans over model iteration, colors are recruitment scenario.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

rebuildTime %>%  
  ggplot(aes(x = HCR, y = nClosures)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen, scales = "free") + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal, labels = hcrLabels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Number of Closures", x = "HCR",
       caption = "Violin plot of the number of time intervals (one or more years) when Age1+ stock biomass was below the 150,000 mt closure threshold.\nValues over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")
```

## Assessment
* Maximum non-convergence rate was 2% to 6% depending on the HCR
* For the overall assessment:
  * Any given assessment was expected to be positively biased (up to 12.5%) over assessment years
  * The SST scenario was expected to be least biased for a given assessment year
* Relative error was expected to be unbiased for any given year at 95% CI in all but later years of SST scenario
* Estimates of biomass in the final year of assessment were negatively biased
  * SST recruitment scenario was most negatively biased
  * Estimates for years with 2- to 3-year lag less likely to be biased
    * HCR1 slightly more negatively biased than other HCRs
  * Forecast estimates were negatively biased between -50% and 25%

```{r, metricsAssess, echo=FALSE, warning=FALSE}

# plot convergence frequency
metricsTbl %>% filter(HCR != "HCR0") %>%
  ggplot(aes(x = HCR, y = frqNonConvg)) +
  geom_violin(aes(fill = HCR), draw_quantiles = c(0.1, 0.5, 0.9)) +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Frequency of Non-convergence", x = "HCR",
       caption = "Violin plot of the frequency the Stock Synthesis 3.0 assessment model did not converge.\nFrequencies over model iteration, with horizontal black lines at 10%, 50%, and 90% quantiles.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

hcrs <- unique(termTS$HCR)
exIters <- sample(termTS$iteration, size = 4)

convrgCheck <- smryOutputList$sclSmry %>% 
                  select(max_grad, model_run, iteration, scenario) %>%
                  mutate(emYear = as.numeric(regmatches(model_run,
                                                        gregexpr("[[:digit:]]+", 
                                                                 model_run))),
                         HCR = sub(pattern = ".*Rec","", scenario),
                         recScen = sub(pattern = "HCR.*","", scenario)) %>%
                  mutate(recScen = sub(pattern = ".*EM_","", recScen))  

cnvrgTS <- smryOutputList$tsSmry %>% mutate(HCR = sub(pattern = ".*Rec","", scenario),
                                   recScen = sub(pattern = "HCR.*","", scenario)) %>%
      mutate(recScen = sub(pattern = ".*EM_","", recScen)) %>%
      left_join(y = convrgCheck, by = c("iteration", "model_run", "scenario", "HCR", "recScen")) %>%
      mutate(plotGroup = case_when(model_run == omName ~ "OM",
                                   max_grad > 0.01 ~ "non-convrg",
                                   max_grad < 0.01 ~ "convrg"))


errCompare <- cnvrgTS %>% filter(Seas == 1, model_run != omName) %>%
                select(Bio_smry, year, model_run, iteration, scenario, HCR, 
                       recScen, emYear, plotGroup) %>%
                inner_join(y = subset(termTS, model_run == omName), 
                           by = c("year", "iteration", "scenario", "HCR", "recScen")) %>%
                #filter(iteration == 1) %>%
                  rename(age1plusOM = Bio_smry.y,
                         age1plusEM = Bio_smry.x) %>% 
                  mutate(errSmryBio = ((age1plusEM - age1plusOM)/age1plusOM)*100)

# Error among years within assessment
assessRE <- errCompare %>% filter(year <= emYear.x) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                summarize(meanRunRE = mean(errSmryBio),
                          medRunRE = median(errSmryBio),
                          hiRunRE = quantile(errSmryBio, probs = 0.95),
                          loRunRE = quantile(errSmryBio, probs = 0.05),
                          nErrs = n()) 
                # group_by(iteration, scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))  %>%
                # group_by(scenario, HCR, recScen, plotGroup) %>%
                # summarize(runMSE = mean(runMSE))

# Error among assessments within year
annualRE <- errCompare %>% filter(year <= emYear.x) %>%
                select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
                group_by(year,  scenario, HCR, recScen, plotGroup) %>%#iteration,
                summarize(meanYrRE = mean(errSmryBio),
                          medYrRE = median(errSmryBio),
                          hiYrRE = quantile(errSmryBio, probs = 0.975),
                          loYrRE = quantile(errSmryBio, probs = 0.025),
                          q1YrRE = quantile(errSmryBio, probs = 0.25),
                          q3YrRE = quantile(errSmryBio, probs = 0.75),
                          nErrs = n())

assessRE %>% filter(plotGroup != "non-convrg") %>%
  ggplot(aes(x = HCR, y = meanRunRE, fill = plotGroup)) +
  geom_boxplot() +
  facet_wrap(~recScen) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Mean Relative Error of Total Assessment",
       caption = "Violin plot of the mean total assessment relative error (over all assessed years) for Age1+ biomass.\nMeans over model assessment and year, levels of boxplot are 25th, 50th, and 75th quartiles, whiskers are 1.5IQR.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

scens <- unique(annualRE$recScen)
for(i in 1:length(scens)){
  print(annualRE %>% filter(plotGroup != "non-convrg", recScen == scens[i]) %>%
    ggplot(aes(x = as.factor(year), fill = HCR)) +
    geom_boxplot(aes(ymin = loYrRE, lower = q1YrRE, middle = medYrRE, 
                     upper = q3YrRE, ymax = hiYrRE),
                 stat = "identity") +
    facet_wrap(~HCR) +
    geom_hline(yintercept = 0) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    labs(title = "Median Annual Relative Error of Assessment",
       caption = paste0("Violin plot of the mean assessment relative error in each year for Age1+ biomass for scenario ", 
                       scens[i],
                       ".\nMeans over assessment years, levels of boxplot are 25th, 50th, and 75th quartiles, whiskers are 95% CI.")) +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot"))
}

# Terminal estimate relative error
termRE <- errCompare %>% filter(year == emYear.x) %>%
              select(age1plusEM, age1plusOM, errSmryBio, year, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
              group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
              summarize(termRE = mean(errSmryBio))

termRE %>% filter(plotGroup != "non-convrg") %>%
  ggplot(aes(x = HCR, y = termRE, fill = HCR)) +
  geom_boxplot() +
  facet_wrap(~recScen) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Mean Relative Error of Terminal Assessment Year") +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  labs(caption = "Boxplot of the mean assessment relative error in the assessment year for Age1+ biomass.\nMeans over model assessment and year, levels of boxplot are 25th, 50th, and 75th quartiles, whiskers are 1.5IQR.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

termRE %>% filter(plotGroup != "non-convrg") %>%
  ggplot(aes(x = HCR, y = termRE, fill = HCR)) +
  geom_boxplot() +
  # facet_wrap(~recScen) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Mean Relative Error of Terminal Assessment Year") +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  labs(caption = "Boxplot of the mean assessment relative error in the assessment year for Age1+ biomass.\nMeans over model assessment and year, levels of boxplot are 25th, 50th, and 75th quartiles, whiskers are 1.5IQR.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

termRE %>% filter(plotGroup != "non-convrg") %>%
  ggplot(aes(x = HCR, y = termRE)) +
  geom_jitter(aes(color = recScen, alpha = 0.03)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Mean Relative Error of Terminal Assessment Year") +
  labs(caption = "Jitter plot of the mean assessment relative error in the assessment year for Age1+ biomass.\nMeans over model assessment and year, colors are recruitment scenario.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

# termRE %>% group_by(scenario, HCR, recScen, plotGroup) %>%
#               summarize(termScenHCR_RE = mean(termRE),
#                         itN = n())

# Terminal lag1 estimate relative error
lag1RE <- errCompare %>% filter(year == (emYear.x - 1)) %>%
              select(age1plusEM, age1plusOM, errSmryBio, year, emYear.x, model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
              group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
              summarize(lag1RE = mean(errSmryBio))

lag1RE %>% filter(plotGroup != "non-convrg") %>%
  ggplot(aes(x = HCR, y = lag1RE, fill = HCR)) +
  geom_boxplot() +
  facet_wrap(~recScen) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Mean Relative Error of Assessment Year Lag1") +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  labs(caption = "Boxplot of the mean assessment relative error 1 year preceding assessment for Age1+ biomass.\nMeans over model assessment and year, levels of boxplot are 25th, 50th, and 75th quartiles, whiskers are 1.5IQR.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

# Terminal lag2 estimate relative error
lag2RE <- errCompare %>% filter(year == (emYear.x - 2)) %>%
              select(age1plusEM, age1plusOM, errSmryBio, year, emYear.x, 
                     model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
              group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
              summarize(lag2RE = mean(errSmryBio))

lag2RE %>% filter(plotGroup != "non-convrg") %>%
  ggplot(aes(x = HCR, y = lag2RE, fill = HCR)) +
  geom_boxplot() +
  facet_wrap(~recScen) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Mean Relative Error of Assessment Year Lag2") +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  labs(caption = "Boxplot of the mean assessment relative error 2 years preceding assessment for Age1+ biomass.\nMeans over model assessment and year, levels of boxplot are 25th, 50th, and 75th quartiles, whiskers are 1.5IQR.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

# Terminal lag3 estimate relative error
lag3RE <- errCompare %>% filter(year == (emYear.x - 3)) %>%
              select(age1plusEM, age1plusOM, errSmryBio, year, emYear.x, 
                     model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
              group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
              summarize(lag3RE = mean(errSmryBio))

lag3RE %>% filter(plotGroup != "non-convrg") %>%
  ggplot(aes(x = HCR, y = lag3RE, fill = HCR)) +
  geom_boxplot() +
  facet_wrap(~recScen) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Mean Relative Error of Assessment Year Lag3") +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  labs(caption = "Boxplot of the mean assessment relative error 3 years preceding assessment for Age1+ biomass.\nMeans over model assessment and year, levels of boxplot are 25th, 50th, and 75th quartiles, whiskers are 1.5IQR.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

# Forecast estimate relative error
foreRE <- errCompare %>% filter(year == (emYear.x + 1)) %>%
              select(age1plusEM, age1plusOM, errSmryBio, year, emYear.x, 
                     model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
              group_by(model_run.x, iteration, scenario, HCR, recScen, plotGroup) %>%
              summarize(foreRE = mean(errSmryBio))

foreRE %>% filter(plotGroup != "non-convrg") %>%
  ggplot(aes(x = HCR, y = foreRE, fill = HCR)) +
  geom_boxplot() +
  facet_wrap(~recScen) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Mean Relative Error of Assessment 1 Year Forecast") +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  labs(caption = "Boxplot of the mean assessment relative error for a 1 year forecast for Age1+ biomass.\nMeans over model assessment and year, levels of boxplot are 25th, 50th, and 75th quartiles, whiskers are 1.5IQR.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

foreRE %>% filter(plotGroup != "non-convrg") %>%
  ggplot(aes(x = HCR, y = foreRE, fill = HCR)) +
  geom_boxplot() +
  #facet_wrap(~recScen) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Mean Relative Error of Assessment 1 Year Forecast") +
  scale_fill_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  labs(caption = "Boxplot of the mean assessment relative error for a 1 year forecast for Age1+ biomass.\nMeans over model assessment and year, levels of boxplot are 25th, 50th, and 75th quartiles, whiskers are 1.5IQR.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

foreRE %>% filter(plotGroup != "non-convrg") %>%
  ggplot(aes(x = HCR, y = foreRE)) +
  geom_jitter(aes(color = recScen, alpha = 0.03)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "Mean Relative Error of Assessment 1 Year Forecast") +
  labs(caption = "Jitter plot of the mean assessment relative error for a 1 year forecast for Age1+ biomass.\nMeans over model assessment and year, colors are recruitment scenarios.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")

```

### Error Progression
Plot some timeseries over estimation models for each run 

```{r, echo=FALSE}

for(hcr in 2:(length(hcrs)-1)){
  print(cnvrgTS %>% filter(HCR == hcrs[hcr], iteration %in% exIters, Seas == 1) %>%
      ggplot(aes(x = year, y = log(Bio_smry))) +
      ggplot2::geom_vline(xintercept = 2019, color = "gray") +
      ggplot2::geom_hline(yintercept = log(50000), color = "red") +
      ggplot2::geom_line(aes(linetype = model_run, color = plotGroup))+
      ggplot2::scale_color_manual(values = c("black", "blue", "#D65F00")) +
      ggplot2::scale_linetype_manual(values = rep("solid", 51)) +
      ggplot2::guides(linetype = "none") +
      ggplot2::facet_grid(rows = vars(iteration), cols = vars(recScen)) +
      ggplot2::theme_classic() + theme(legend.position="none") +
      labs(title = hcrs[hcr],
           caption = "Error progression of estimated log-Age1+ biomass (black lines) compared to the operating model biomass (colored line)\n for a sample of iterations (rows) in each recruitment scenario (columns).") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot"))
}

age1PlusBio <- smryOutputList$tsSmry %>% filter(Seas == 1) %>%
                  select(year, Bio_smry, model_run, iteration, scenario) %>%
                  mutate(plotGroup = case_when(grepl("_OM", model_run, fixed = TRUE) ~ "OM",
                                               TRUE ~ "EM"))

age1PlusRE <- age1PlusBio %>% filter(plotGroup != "OM")
age1PlusRE <- age1PlusRE %>% pivot_wider(names_from = "plotGroup", values_from = "Bio_smry") %>%
                left_join(y = convrgCheck,
                          by = c("model_run", "iteration", "scenario")) %>%
                full_join(y = subset(age1PlusBio, subset = plotGroup == "OM"),
                          by = c("iteration", "scenario", "year")) %>%
                mutate(convrg = case_when(max_grad > 0.01 ~ "non-convrg",
                                          max_grad < 0.01 ~ "convrg",
                                          TRUE ~ "OM"),
                       emRE = (EM - Bio_smry)/Bio_smry * 100)

# Plot relative errors of biomass over time
for(hcr in 2:(length(hcrs)-1)){
  print(age1PlusRE %>% filter(HCR == hcrs[hcr], iteration %in% exIters) %>%
  ggplot(aes(x = year, y = ifelse(emRE > 100, 100, emRE))) + #y = emRE)) +
  geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "gray") +
  geom_line(aes(linetype = as.character(model_run.x), color = convrg))+
  scale_color_manual(values = c("black", "blue", "#D65F00")) +
  scale_linetype_manual(values = rep("solid", 51)) +
  guides(linetype = "none") +
  facet_grid(rows = vars(iteration), cols = vars(scenario)) +
  theme_classic() + ylab(label = "Relative Error of Age 1+ Biomass (%)") +
  labs(title = hcrs[hcr],
           caption = "Progression of relative error of estimated log-Age1+ biomass (black lines) relative to the operating model biomass\n for a sample of iterations (rows) in each recruitment scenario (columns).") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") +
  ylim(-100, 100))
}
```
### Terminal Year Error
Error of final assessment year over projection 

```{r, echo=FALSE, warning=FALSE}
set.seed(seed = 413)
exIters <- sample(termTS$iteration, size = 3)
exHCR <- "HCR2"
convrgCheckEx <- convrgCheck %>% filter(iteration %in% exIters, HCR == exHCR)%>%
                  filter(max_grad > 0.01)

termTS %>% filter(iteration %in% exIters,
                  HCR == exHCR,
                  model_run != "constGrowBothShort_EM_init") %>%
  ggplot2::ggplot(aes(x = year, y = log(Bio_smry))) +
    ggplot2::geom_vline(xintercept = 2019, color = "gray") +
    
    ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = model_run))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
    ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
  scale_fill_manual(labels = c("Terminal EM","OM")) +
    ggplot2::guides(linetype = "none") +
    ggplot2::facet_grid(rows = vars(iteration), cols = vars(recScen)) +
    ggplot2::theme_classic() + 
  geom_rug(data = convrgCheckEx, mapping = aes(x = emYear),
                       sides = "b", inherit.aes = FALSE) +
  labs(x = "Year", y = "Age1+ Biomass (log-t)",
       caption = "Error progression of estimated terminal (assessment) year log-Age1+ biomass (orange line) compared to the operating model biomass (blue line)\n for a sample of iterations (rows) in each recruitment scenario (columns).") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")
```
# Tradeoffs
Plot tradeoffs among metrics

* HCR1 and HCR7 had relatively lower mean catch for a given mean level of biomass, while HCR2 and HCR8 had higher mean catch per biomass level
* On annual basis, stronger tradeoff between catch and biomass for HCRs 3, 6, 7, and 8
  * HCR2 provides higher catches at intermediate levels of biomass than many HCRs
* Positive relationship between mean catch and catch SD, except in SST scenario where relationship is negative, likely due to iterations reaching maximum catch cap more often

```{r, Tradeoffs, echo=FALSE, warning=FALSE}

metricsTbl %>% #filter(recScen == "RandRec", HCR != "HCR4") %>%
  ggplot(aes(x = log(meanCatch), y = log(meanB1plus), color = HCR)) +
  geom_vline(xintercept = log(200000)) +
  geom_hline(yintercept = log(150000)) +
  geom_point() +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_color_manual(values = hcrPal, labels = hcrLabels) +
  labs(y = "Mean Age 1+ Biomass (log-mt)", x = "Mean Catch (log-mt)",
       title = "Mean Biomass x Mean Catch",
       caption = "Interaction between mean log-catch and mean log-Age1+ biomass under each HCR (colored points) in each recruitment scenario.\nMeans over iterations.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") 

termTS %>% filter(model_run == omName, year > 2019) %>%
  ggplot(aes(x = log(Bio_smry), y = log(totCatch), color = HCR)) +
  geom_point() +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_color_manual(values = hcrPal, labels = hcrLabels) +
  labs(y = "Catch (log-mt)", x = "Age1+ Biomass (log-mt)",
       title = "Annual Biomass x Annual Catch",
       caption = "Interaction between annual log-catch and annual log-Age1+ biomass under each HCR (colored points) in each recruitment scenario.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") 

metricsTbl %>% ggplot(aes(x = log(meanCatch), y = closuresFreq, color = HCR)) +
  geom_point() +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_color_manual(values = hcrPal, labels = hcrLabels) +
  labs(caption = "Interaction between mean log-catch and closure frequency under each HCR (colored points) in each recruitment scenario.\nValues over iterations.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") 

metricsTbl %>% ggplot(aes(x = meanCatch, y = sdCatch, color = HCR)) +
  geom_point() +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_color_manual(values = hcrPal, labels = hcrLabels)+
  labs(caption = "Interaction between mean catch and standard deviation of catch under each HCR (colored points) in each recruitment scenario.\nValues over iterations.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot")  

metricsTbl %>% ggplot(aes(x = meanCatch, y = minLen, color = HCR)) +
  geom_point() +
  facet_wrap(~recScen) + 
  theme_minimal() +
  scale_color_manual(values = hcrPal, labels = hcrLabels) +
  labs(caption = "Interaction between mean catch and mean minimum length under each HCR (colored points) in each recruitment scenario.\nValues over iterations.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") 

```

## Radar plots
```{r, RadarPlots, echo=FALSE}
metricsTbl %>% full_join(y = rebuildTime, by = c("iteration", "scenario", 
                                                 "model_run", "HCR", "recScen")) %>%
  select(iteration, scenario, HCR, nameHCR, recScen, relBioMax, relCatMax, 
         sdCatch, closuresFreq, collapseFreq, meanCollapseSever, meanRebuildTime) %>%
  mutate(invSDCatch = 1 - rescale(sdCatch, to = c(0, 1)),
         invClosFreq = 1 - closuresFreq,
         invCollapseFreq = 1 - collapseFreq,
         invCollapseSever = 1 - meanCollapseSever,
         invRebuildLen = 1 - rescale(meanRebuildTime, to = c(0, 1), 
                                     from = c(0, max(meanRebuildTime, na.rm = TRUE)))) %>%
  select(iteration, scenario, HCR, nameHCR, recScen, relBioMax, relCatMax, 
         invSDCatch, invClosFreq, invCollapseFreq, invCollapseSever, invRebuildLen) %>%
  group_by(scenario, HCR, nameHCR, recScen) %>%
  summarize(relBioMax = median(relBioMax, na.rm = TRUE), 
            relCatMax = median(relCatMax, na.rm = TRUE), 
            invSDCatch = median(invSDCatch, na.rm = TRUE), 
            invClosFreq = median(invClosFreq, na.rm = TRUE), 
            invCollapseFreq = median(invCollapseFreq, na.rm = TRUE), 
            invCollapseSever = median(invCollapseSever, na.rm = TRUE), 
            invRebuildLen = median(invRebuildLen, na.rm = TRUE)) %>%
  pivot_longer(cols = -c(scenario, recScen, HCR, nameHCR), 
               names_to = "variable", values_to = "value") %>%
  filter(HCR != "HCR0") %>%
  arrange(variable) %>%
  ggplot(aes(x=variable, y=value, group=nameHCR, color=HCR)) + 
  geom_polygon(fill=NA, size = 1) + 
  coord_polar() + theme_minimal() + 
  facet_wrap(~recScen) +
  scale_color_manual(values = hcrPal[-1], labels = hcrLabels[-1]) +
  labs(caption = "Radar plot of select performance metrics. Metrics are scaled between 0 and 1 and inversed so that favorable performance levels are\n on outer edge of circle.\nValues are median metric over iterations.") +
  theme(plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") 


```



